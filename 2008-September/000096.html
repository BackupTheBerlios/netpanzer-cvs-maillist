<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Netpanzer-cvs] r1060 - in trunk/netpanzer: nbproject	src/NetPanzer/Interfaces src/NetPanzer/PowerUps	src/NetPanzer/Views/Components src/NetPanzer/Views/Game
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/netpanzer-cvs/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1060%20-%20in%20trunk/netpanzer%3A%20nbproject%0A%09src/NetPanzer/Interfaces%20src/NetPanzer/PowerUps%0A%09src/NetPanzer/Views/Components%20src/NetPanzer/Views/Game&In-Reply-To=%3C200809201317.m8KDH4qV006973%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000095.html">
   <LINK REL="Next"  HREF="000097.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Netpanzer-cvs] r1060 - in trunk/netpanzer: nbproject	src/NetPanzer/Interfaces src/NetPanzer/PowerUps	src/NetPanzer/Views/Components src/NetPanzer/Views/Game</H1>
    <B>kromxp at mail.berlios.de</B> 
    <A HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1060%20-%20in%20trunk/netpanzer%3A%20nbproject%0A%09src/NetPanzer/Interfaces%20src/NetPanzer/PowerUps%0A%09src/NetPanzer/Views/Components%20src/NetPanzer/Views/Game&In-Reply-To=%3C200809201317.m8KDH4qV006973%40sheep.berlios.de%3E"
       TITLE="[Netpanzer-cvs] r1060 - in trunk/netpanzer: nbproject	src/NetPanzer/Interfaces src/NetPanzer/PowerUps	src/NetPanzer/Views/Components src/NetPanzer/Views/Game">kromxp at mail.berlios.de
       </A><BR>
    <I>Sat Sep 20 15:17:04 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000095.html">[Netpanzer-cvs] r1059 - in trunk/netpanzer/src/NetPanzer:	Interfaces System Views/MainMenu/Options
</A></li>
        <LI>Next message: <A HREF="000097.html">[Netpanzer-cvs] r1061 - in trunk/netpanzer: nbproject	src/NetPanzer/Interfaces src/NetPanzer/PowerUps	src/NetPanzer/Views/Components src/NetPanzer/Views/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96">[ date ]</a>
              <a href="thread.html#96">[ thread ]</a>
              <a href="subject.html#96">[ subject ]</a>
              <a href="author.html#96">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: kromxp
Date: 2008-09-20 15:16:39 +0200 (Sat, 20 Sep 2008)
New Revision: 1060

Added:
   trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp
   trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.hpp
Modified:
   trunk/netpanzer/nbproject/configurations.xml
   trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.hpp
   trunk/netpanzer/src/NetPanzer/Interfaces/MiniMapInterface.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp
   trunk/netpanzer/src/NetPanzer/Views/Game/GameView.cpp
   trunk/netpanzer/src/NetPanzer/Views/Game/MiniMapView.cpp
Log:
- Resized the minimap to correct size.
- Several parts of code moved to new MiniMap class (minimap becomes a Component)

Modified: trunk/netpanzer/nbproject/configurations.xml
===================================================================
--- trunk/netpanzer/nbproject/configurations.xml	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/nbproject/configurations.xml	2008-09-20 13:16:39 UTC (rev 1060)
@@ -519,6 +519,8 @@
             &lt;itemPath&gt;src/NetPanzer/Views/Components/InputEvent.hpp&lt;/itemPath&gt;
             &lt;itemPath&gt;src/NetPanzer/Views/Components/Label.cpp&lt;/itemPath&gt;
             &lt;itemPath&gt;src/NetPanzer/Views/Components/Label.hpp&lt;/itemPath&gt;
+            &lt;itemPath&gt;src/NetPanzer/Views/Components/MiniMap.cpp&lt;/itemPath&gt;
+            &lt;itemPath&gt;src/NetPanzer/Views/Components/MiniMap.hpp&lt;/itemPath&gt;
             &lt;itemPath&gt;src/NetPanzer/Views/Components/MouseEvent.hpp&lt;/itemPath&gt;
             &lt;itemPath&gt;src/NetPanzer/Views/Components/ScrollBar.cpp&lt;/itemPath&gt;
             &lt;itemPath&gt;src/NetPanzer/Views/Components/ScrollBar.hpp&lt;/itemPath&gt;
@@ -2045,6 +2047,12 @@
       &lt;item path=&quot;src/NetPanzer/Views/Components/Label.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.cpp&quot;&gt;
+        &lt;itemTool&gt;1&lt;/itemTool&gt;
+      &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.hpp&quot;&gt;
+        &lt;itemTool&gt;3&lt;/itemTool&gt;
+      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Views/Components/MouseEvent.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
@@ -3768,6 +3776,12 @@
       &lt;item path=&quot;src/NetPanzer/Views/Components/Label.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.cpp&quot;&gt;
+        &lt;itemTool&gt;1&lt;/itemTool&gt;
+      &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.hpp&quot;&gt;
+        &lt;itemTool&gt;3&lt;/itemTool&gt;
+      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Views/Components/MouseEvent.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
@@ -5491,6 +5505,12 @@
       &lt;item path=&quot;src/NetPanzer/Views/Components/Label.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.cpp&quot;&gt;
+        &lt;itemTool&gt;1&lt;/itemTool&gt;
+      &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.hpp&quot;&gt;
+        &lt;itemTool&gt;3&lt;/itemTool&gt;
+      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Views/Components/MouseEvent.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
@@ -7214,6 +7234,12 @@
       &lt;item path=&quot;src/NetPanzer/Views/Components/Label.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.cpp&quot;&gt;
+        &lt;itemTool&gt;1&lt;/itemTool&gt;
+      &lt;/item&gt;
+      &lt;item path=&quot;src/NetPanzer/Views/Components/MiniMap.hpp&quot;&gt;
+        &lt;itemTool&gt;3&lt;/itemTool&gt;
+      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Views/Components/MouseEvent.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.cpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.cpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -29,6 +29,7 @@
 WadMapTable MapInterface::wad_mapping_table;
 Surface MapInterface::mini_map_surface;
 char MapInterface::map_path[256];
+MapInterface::MapListenerList MapInterface::listenerList;
 
 bool MapInterface::startMapLoad( const char *file_path, bool load_tiles,
         size_t partitions )
@@ -81,6 +82,13 @@
 
     wad_mapping_table.deallocate();
 
+    MapListenerList::iterator i = listenerList.begin();
+    while ( i != listenerList.end() )
+    {
+        (*i)-&gt;onMapLoadedEvent();
+        i++;
+    }
+    
     buildMiniMapSurface();
 
     strcpy( path, map_path );

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.hpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/MapInterface.hpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -18,6 +18,8 @@
 #ifndef _MAPINTERFACE_HPP
 #define _MAPINTERFACE_HPP
 
+#include &lt;list&gt;
+
 #include &quot;TileInterface.hpp&quot;
 #include &quot;Classes/WorldMap.hpp&quot;
 #include &quot;Classes/SpawnList.hpp&quot;
@@ -25,17 +27,23 @@
 
 #include &quot;2D/Surface.hpp&quot;
 
-class MapLoadCallback
+class MapEventListener
 {
 public:
-	virtual ~MapLoadCallback()
-	{ }
-
-    virtual void MapLoadProgress(float percent);
+    virtual ~MapEventListener() {};
+protected:
+    virtual void onMapLoadedEvent() = 0;
+private:
+    friend class MapInterface;
 };
 
+
 class MapInterface : protected TileInterface
 {
+private:
+    typedef std::list&lt;MapEventListener *&gt; MapListenerList;
+    static MapListenerList listenerList;
+    
 protected:
     static WorldMap main_map;
     static SpawnList spawn_list;
@@ -50,6 +58,16 @@
     static void buildMiniMapSurface();
 
 public:
+    static void addMapEventListener(MapEventListener *lis)
+    {
+        listenerList.push_back(lis);
+    }
+    
+    static void removeMapEventListener(MapEventListener *lis)
+    {
+        listenerList.remove(lis);
+    }
+    
     static void getMapPointSize(iXY *map_size)
     {
         map_size-&gt;x = main_map.getWidth() * tile_set.getTileXsize();

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/MiniMapInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/MiniMapInterface.cpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/MiniMapInterface.cpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -233,8 +233,8 @@
             }
         }
 
-        annotateObjectives( map_surface );
-        annotateUnits( map_surface );
+        //annotateObjectives( map_surface );
+        //annotateUnits( map_surface );
     }
 }
 

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -32,7 +32,29 @@
 #include &quot;Classes/Network/PowerUpNetMessage.hpp&quot;
 
 #include &quot;System/Sound.hpp&quot;
+#include &quot;Util/NTimer.hpp&quot;
 
+static NTimer radarTimer(180000);
+static bool radarActive = false;
+
+void
+ActivateRadar()
+{
+    radarActive = true;
+    radarTimer.reset();
+    ConsoleInterface::postMessage(Color::unitAqua, false, 0, &quot;YOU GOT AN ENEMY RADAR POWERUP&quot; );
+}
+
+bool
+EnemyRadarPowerUp::isRadarActive()
+{
+    if ( radarActive &amp;&amp; radarTimer.isTimeOut() )
+    {
+        radarActive = false;
+    }
+    return radarActive;
+}
+
 EnemyRadarPowerUp::EnemyRadarPowerUp(iXY map_loc, int type)
         : PowerUp( map_loc, type )
 {
@@ -47,8 +69,7 @@
 
     if(unit-&gt;player == PlayerInterface::getLocalPlayer())
     {
-        MiniMapInterface::setShowEnemyRadar( 180 );
-        ConsoleInterface::postMessage(Color::unitAqua, false, 0, &quot;YOU GOT AN ENEMY RADAR POWERUP&quot; );
+        ActivateRadar();
     }
 
     PowerUpHitMesg hit_mesg;
@@ -65,8 +86,7 @@
 
     if( PlayerInterface::getLocalPlayerIndex() == message-&gt;getPlayerID() )
     {
-        MiniMapInterface::setShowEnemyRadar( 180 );
-        ConsoleInterface::postMessage(Color::unitAqua, false, 0, &quot;YOU GOT AN ENEMY RADAR POWERUP&quot; );
+        ActivateRadar();
     }
 
     life_cycle_state = _power_up_lifecycle_state_inactive;

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -26,7 +26,8 @@
     virtual void onHit( UnitID unit_id );
 
 public:
-
+    static bool isRadarActive();
+    
     EnemyRadarPowerUp(iXY map_loc, int type);
     virtual ~EnemyRadarPowerUp()
     { }

Added: trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -0,0 +1,275 @@
+/*
+Copyright (C) 2008 by Aaron Perez &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">aaronps at gmail.com</A>&gt;
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+ * Created on September 20, 2008, 10:49 AM
+ */
+
+#include &quot;Util/NTimer.hpp&quot;
+
+
+#include &quot;Util/Log.hpp&quot;
+#include &quot;MiniMap.hpp&quot;
+
+
+// work in progres first has to change the input handling of game.
+
+#include &quot;Core/CoreTypes.hpp&quot;
+#include &quot;Views/Components/MiniMap.hpp&quot;
+#include &quot;2D/Surface.hpp&quot;
+#include &quot;Interfaces/MapInterface.hpp&quot;
+#include &quot;MouseEvent.hpp&quot;
+#include &quot;Interfaces/GameConfig.hpp&quot;
+#include &quot;Objectives/ObjectiveInterface.hpp&quot;
+#include &quot;Interfaces/PlayerInterface.hpp&quot;
+#include &quot;PowerUps/EnemyRadarPowerUp.hpp&quot;
+
+MiniMap::MiniMap(int x, int y, int w, int h) : mousepos(0,0)
+{
+    setLocation(x, y);
+    setSize(w,h);
+    moving=false;
+    
+    blinktimer.setTimeOut(200);
+    blinkstatus=false;
+    
+    MapInterface::addMapEventListener(this);
+}
+
+MiniMap::~MiniMap()
+{
+    MapInterface::removeMapEventListener(this);
+}
+
+void
+MiniMap::draw(Surface &amp;dest)
+{
+    //regenerate();
+    surface.blt(dest,position.x, position.y);
+    drawObjectives(dest);
+    drawUnits(dest);
+}
+
+void
+MiniMap::actionPerformed(const mMouseEvent &amp;me)
+{
+    // XXX enable after input handling reworked.
+//    switch (me.getID())
+//    {
+//        case mMouseEvent::MOUSE_EVENT_ENTERED:
+//            mousepos = me.getPoint();
+//            break;
+//        case mMouseEvent::MOUSE_EVENT_PRESSED:
+//            if ( me.getModifiers() &amp; InputEvent::BUTTON2_MASK )
+//            {
+//                moving = true;
+//            }
+//            break;
+//            
+//        case mMouseEvent::MOUSE_EVENT_CLICKED:
+//        case mMouseEvent::MOUSE_EVENT_RELEASED:
+//            if ( me.getModifiers() &amp; InputEvent::BUTTON2_MASK )
+//            {
+//                moving = false;
+//            }
+//            break;
+//        case mMouseEvent::MOUSE_EVENT_EXITED:
+//            moving = false;
+//            break;
+//        case mMouseEvent::MOUSE_EVENT_MOVED:
+//            if ( moving )
+//            {
+//                iXY diff = me.getPoint() - mousepos;
+//                setLocation(position-diff);
+//            }
+//            mousepos = me.getPoint();
+//            break;
+//    }
+//    
+}
+
+void
+MiniMap::regenerate()
+{
+    LOGGER.warning(&quot;Regenerating minimap....&quot;);
+    PIX *ptr = surface.getFrame0();
+    if ( !ptr )
+        return;
+    
+    xratio = (float)MapInterface::getWidth() / surface.getWidth();    
+    yratio = (float)MapInterface::getHeight() / surface.getHeight();
+    float mapx;
+    float mapy = 0.0f;
+    
+    PIX *curline = ptr;
+    PIX *curptr;
+    for ( int y=0; y&lt;surface.getHeight(); y++)
+    {
+        curptr = curline;
+        mapx = 0.0f;
+        for ( int x=0; x&lt;surface.getWidth(); x++)
+        {
+            iXY pos(mapx,mapy);
+            // XXX Beware, no check for limits, could raise assert and quit the game.
+            *curptr = MapInterface::getAverageColorMapXY(pos);
+            curptr++;
+            mapx += xratio;
+        }
+        curline += surface.getPitch();
+        mapy += yratio;
+    }
+}
+
+void
+MiniMap::drawObjectives(Surface &amp;dest)
+{
+    iRect objective_rect, map_rect;
+    unsigned char objective_status;
+    PIX color;
+    ObjectiveID objective_id;
+
+    ObjectiveInterface::startObjectivePositionEnumeration();
+
+    while( ObjectiveInterface::objectivePositionEnumeration( &amp;objective_rect, &amp;objective_status, &amp;objective_id ) )
+    {
+        ObjectiveState * obj_state = ObjectiveInterface::getObjectiveState(objective_id);
+
+	switch( objective_status )
+        {
+            case _objective_disposition_unoccupied :
+                color = Color::white;
+                break;
+
+            case _objective_disposition_player :
+                color = gameconfig-&gt;getPlayerRadarUnitColor();
+                break;
+
+            case _objective_disposition_allie :
+                color = gameconfig-&gt;getAlliedOutpostRadarColor();
+                break;
+
+            case _objective_disposition_enemy :
+                color = obj_state-&gt;occupying_player-&gt;getColor();
+                break;
+        }
+
+        // magic 32 to convert from point to tile
+        map_rect.min.x = int(float(objective_rect.min.x/32) / xratio);
+        map_rect.min.y = int(float(objective_rect.min.y/32) / yratio);
+        map_rect.max.x = int(float(objective_rect.max.x/32) / xratio);
+        map_rect.max.y = int(float(objective_rect.max.y/32) / yratio);
+
+        // Removed black borders to the text.
+//        if (gameconfig-&gt;radar_objectivedrawmode == _mini_map_objective_draw_mode_solid_rect) {
+//            map_surface.fillRect( map_rect, color);
+//        } else if (gameconfig-&gt;radar_objectivedrawmode == _mini_map_objective_draw_mode_outline_rect) {
+            dest.drawRect( map_rect, color);
+            dest.drawRect( iRect(map_rect.min.x + 1, map_rect.min.y + 1, map_rect.max.x - 1, map_rect.max.y - 1), color );
+            //}
+            //else if (gameconfig-&gt;radar_objectivedrawmode == _mini_map_objective_draw_mode_player_flag)
+            //{
+            //map_surface.fillRect( map_rect, color );
+//        }
+
+        //LOG((&quot;%d&quot;, obj_state.outpost_type));
+        if(objective_status == _objective_disposition_player)
+        {
+            OutpostStatus status = ObjectiveInterface::getOutpostStatus(objective_id);
+            //Only draw our unit collection location
+            iXY objdest, src;
+            MapInterface::mapXYtoPointXY(status.unit_collection_loc, &amp;objdest);
+            objdest.x = int(float(objdest.x) / xratio);
+            objdest.y = int(float(objdest.y) / yratio);
+
+            src.x  = int(float(obj_state-&gt;location.x) / xratio);
+            src.y  = int(float(obj_state-&gt;location.y) / yratio);
+            dest.drawLine(src.x, src.y, objdest.x, objdest.y, color);
+        }
+    }
+}
+
+void
+MiniMap::drawUnits(Surface &amp;dest)
+{
+    const UnitInterface::Units&amp; units = UnitInterface::getUnits();
+    for(UnitInterface::Units::const_iterator i = units.begin();
+            i != units.end(); ++i)
+    {
+        UnitBase* unit = i-&gt;second;
+        PIX color;
+        bool forceLarge = false;
+        UnitState&amp; unit_state = unit-&gt;unit_state;
+        iXY map_loc = iXY( int(float(unit_state.location.x/32) / xratio),
+                           int(float(unit_state.location.y/32) / yratio));
+
+        if ( unit-&gt;player-&gt;getID() == PlayerInterface::getLocalPlayerIndex())
+        {
+            if ( unit_state.threat_level == _threat_level_under_attack )
+            {
+                if ( blinktimer.isTimeOut() )
+                {
+                    blinkstatus = !blinkstatus;
+                    blinktimer.reset();
+                }
+                
+                if ( ! blinkstatus )
+                {
+                    continue;
+                }
+                
+                color = Color::yellow;
+                forceLarge = true;
+            }
+            else
+            {
+                if ( unit_state.select )
+                {
+                    color = gameconfig-&gt;getSelectedRadarUnitColor();
+                }
+                else
+                {
+                    color = gameconfig-&gt;getPlayerRadarUnitColor();
+                }
+            }
+        }
+        else if (PlayerInterface::isAllied(PlayerInterface::getLocalPlayerIndex(), unit-&gt;player-&gt;getID()))
+        {
+            color = gameconfig-&gt;getAlliedRadarUnitColor();
+        }
+        else if ( EnemyRadarPowerUp::isRadarActive() )
+        {
+            color = unit-&gt;player-&gt;getColor();
+        }
+        else
+        {
+            continue;
+        }
+        
+        drawUnit(dest, map_loc, color, forceLarge);
+    }    
+}
+
+void
+MiniMap::drawUnit(Surface &amp;dest, const iXY loc, PIX color, bool forceLarge)
+{
+    dest.putPixel( loc.x  , loc.y  , color );
+    if ( gameconfig-&gt;radar_unitsize == _mini_map_unit_size_large || forceLarge )
+    {
+        dest.putPixel( loc.x+1, loc.y  , color );
+        dest.putPixel( loc.x  , loc.y+1, color );
+        dest.putPixel( loc.x+1, loc.y+1, color );
+    }
+}

Added: trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.hpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.hpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -0,0 +1,63 @@
+/*
+Copyright (C) 2008 by Aaron Perez &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">aaronps at gmail.com</A>&gt;
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+ * Created on September 20, 2008, 10:46 AM
+ */
+
+#ifndef _MINIMAP_HPP
+#define	_MINIMAP_HPP
+
+#include &quot;Views/Components/Component.hpp&quot;
+#include &quot;Interfaces/MapInterface.hpp&quot;
+
+class MiniMap : public Component, public MapEventListener
+{
+public:
+    MiniMap(int x, int y, int w, int h);
+    virtual ~MiniMap();
+    
+    void draw(Surface &amp;dest);
+    
+    virtual void render()
+    {
+        // nothing
+    }
+    
+    void actionPerformed(const mMouseEvent &amp;me);
+    
+protected:
+    void onMapLoadedEvent()
+    {
+        LOGGER.warning(&quot;onMapLoadedEvent received........&quot;);
+        regenerate();
+    }
+    
+private:
+    void regenerate();
+    void drawObjectives(Surface &amp;dest);
+    void drawUnits(Surface &amp;dest);
+    void drawUnit(Surface &amp;dest, const iXY loc, PIX color, bool forceLarge);
+    bool moving;
+    iXY  mousepos;
+    float xratio;
+    float yratio;
+    NTimer blinktimer;
+    bool blinkstatus;
+};
+
+#endif	/* _MINIMAP_HPP */
+

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/GameView.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/GameView.cpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/GameView.cpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -46,6 +46,7 @@
 #include &quot;Interfaces/WorldViewInterface.hpp&quot;
 
 #include &quot;Views/Components/InfoBar.hpp&quot;
+#include &quot;Views/Components/MiniMap.hpp&quot;
 
 GameView gameView;
 int GameView::gDrawSolidBackground = 0;
@@ -54,8 +55,26 @@
 // GameView
 //---------------------------------------------------------------------------
 GameView::GameView() : View()
-{} // end GameView::GameView
+{
+    setSearchName(&quot;GameView&quot;);
+    setTitle(&quot;Game&quot;);
+    setSubTitle(&quot;&quot;);
 
+    setBordered(false);
+    setAlwaysOnBottom(true);
+    setAllowResize(false);
+    setDisplayStatusBar(false);
+    setVisible(false);
+
+    resize(640,480);
+    moveTo(iXY(0, 0));
+
+    add(new InfoBar(0,0));
+    // will add after input handling is done
+    //add(new MiniMap(100,100));
+
+} // end GameView::GameView
+
 // setSize
 //---------------------------------------------------------------------------
 void GameView::setSize(iXY size)
@@ -67,20 +86,8 @@
 //---------------------------------------------------------------------------
 void GameView::init()
 {
-    setSearchName(&quot;GameView&quot;);
-    setTitle(&quot;Game&quot;);
-    setSubTitle(&quot;&quot;);
-
-    setBordered(false);
-    setAlwaysOnBottom(true);
-    setAllowResize(false);
-    setDisplayStatusBar(false);
-    setVisible(false);
-
     resize(iXY(screen-&gt;getWidth(), screen-&gt;getHeight()));
     moveTo(iXY(0, 0));
-    add(new InfoBar(0,0));
-
 } // end GameView::init
 void
 GameView::checkResolution(iXY oldResolution, iXY newResolution)

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/MiniMapView.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/MiniMapView.cpp	2008-09-18 16:44:40 UTC (rev 1059)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/MiniMapView.cpp	2008-09-20 13:16:39 UTC (rev 1060)
@@ -25,6 +25,8 @@
 #include &quot;Classes/WorldInputCmdProcessor.hpp&quot;
 #include &quot;Interfaces/GameConfig.hpp&quot;
 
+#include &quot;Views/Components/MiniMap.hpp&quot;
+
 MiniMapView miniMapView;
 
 
@@ -51,7 +53,8 @@
     add(CLOSE_VIEW_BUTTON);
     add(MINMAX_VIEW_BUTTON);
 
-    resize(140, 140);
+    resize(160, 160);
+    add(new MiniMap(1,1,158,158));
 } // end MiniMapView::MiniMapView
 
 // init
@@ -61,22 +64,6 @@
     Surface *miniMap;
     miniMap = MiniMapInterface::getMiniMap();
 
-    //iXY size = miniMap-&gt;getPix();
-    // don't resize minimap, set to static
-    //iXY size(((const iXY &amp;)gameconfig-&gt;minimapsize)+iXY(2,2));
-    //resize(size);
-
-    //if(gameconfig-&gt;minimapposition.isDefaultValue()) {
-    //    gameconfig-&gt;minimapposition = iXY(0, screen-&gt;getHeight() - 196);
-    //}
-    
-    //moveTo(gameconfig-&gt;minimapposition);
-    
-    //checkArea(iXY(screen-&gt;getWidth(),screen-&gt;getHeight()));
-
-    //int xOffset = size.x;
-    //int yOffset = 0;
-
     MiniMapInterface::setMapScale(getSize() - iXY(2,2));
     //checkArea(iXY(screen-&gt;getWidth(),screen-&gt;getHeight()));
 
@@ -97,14 +84,16 @@
 void
 MiniMapView::checkResolution(iXY oldResolution, iXY newResolution)
 {
-    moveTo(iXY(0,newResolution.y-140));
+    moveTo(iXY(0,newResolution.y-300));
 }
 
 // doDraw
 //---------------------------------------------------------------------------
 void MiniMapView::doDraw(Surface &amp;viewArea, Surface &amp;clientArea)
 {
-    miniMapSurface.blt(clientArea, 0, 0);
+    //miniMapSurface.blt(clientArea, 0, 0);
+    // draw the components first
+    GameTemplateView::doDraw(viewArea, clientArea);
 
     // Draw a hairline border.
     //viewArea.drawRect(Color::white);
@@ -130,9 +119,6 @@
             drawMouseBox(clientArea);
         }
     }
-
-    GameTemplateView::doDraw(viewArea, clientArea);
-
 } // end doDraw
 
 // setViewWindow


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000095.html">[Netpanzer-cvs] r1059 - in trunk/netpanzer/src/NetPanzer:	Interfaces System Views/MainMenu/Options
</A></li>
	<LI>Next message: <A HREF="000097.html">[Netpanzer-cvs] r1061 - in trunk/netpanzer: nbproject	src/NetPanzer/Interfaces src/NetPanzer/PowerUps	src/NetPanzer/Views/Components src/NetPanzer/Views/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96">[ date ]</a>
              <a href="thread.html#96">[ thread ]</a>
              <a href="subject.html#96">[ subject ]</a>
              <a href="author.html#96">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">More information about the Netpanzer-cvs
mailing list</a><br>
</body></html>
