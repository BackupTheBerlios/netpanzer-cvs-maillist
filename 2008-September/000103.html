<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Netpanzer-cvs] r1067 - in trunk/netpanzer: nbproject	src/NetPanzer/Units
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/netpanzer-cvs/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1067%20-%20in%20trunk/netpanzer%3A%20nbproject%0A%09src/NetPanzer/Units&In-Reply-To=%3C200809211058.m8LAw8E3005641%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000102.html">
   <LINK REL="Next"  HREF="000104.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Netpanzer-cvs] r1067 - in trunk/netpanzer: nbproject	src/NetPanzer/Units</H1>
    <B>kromxp at mail.berlios.de</B> 
    <A HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1067%20-%20in%20trunk/netpanzer%3A%20nbproject%0A%09src/NetPanzer/Units&In-Reply-To=%3C200809211058.m8LAw8E3005641%40sheep.berlios.de%3E"
       TITLE="[Netpanzer-cvs] r1067 - in trunk/netpanzer: nbproject	src/NetPanzer/Units">kromxp at mail.berlios.de
       </A><BR>
    <I>Sun Sep 21 12:58:08 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000102.html">[Netpanzer-cvs] r1066 - trunk/netpanzer/src/NetPanzer/Units
</A></li>
        <LI>Next message: <A HREF="000104.html">[Netpanzer-cvs] r1068 - in trunk/netpanzer/src/NetPanzer:	Classes/Network Network
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#103">[ date ]</a>
              <a href="thread.html#103">[ thread ]</a>
              <a href="subject.html#103">[ subject ]</a>
              <a href="author.html#103">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: kromxp
Date: 2008-09-21 12:57:57 +0200 (Sun, 21 Sep 2008)
New Revision: 1067

Removed:
   trunk/netpanzer/src/NetPanzer/Units/UnitList.hpp
Modified:
   trunk/netpanzer/nbproject/configurations.xml
   trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp
   trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp
Log:
- Removed unused UnitList.hpp
- Possible fix to one of the lag issues in server: when creating tanks in the base and these cannot go out the server lags a lot, this is cause by frequent requests to update the path. Now the delay between request doubles everytime it fails, needs more testing but seems that this specific point is better.
Note: this has to be running on server.

Modified: trunk/netpanzer/nbproject/configurations.xml
===================================================================
--- trunk/netpanzer/nbproject/configurations.xml	2008-09-21 03:51:15 UTC (rev 1066)
+++ trunk/netpanzer/nbproject/configurations.xml	2008-09-21 10:57:57 UTC (rev 1067)
@@ -482,7 +482,6 @@
           &lt;itemPath&gt;src/NetPanzer/Units/UnitInterface.cpp&lt;/itemPath&gt;
           &lt;itemPath&gt;src/NetPanzer/Units/UnitInterface.hpp&lt;/itemPath&gt;
           &lt;itemPath&gt;src/NetPanzer/Units/UnitLifecycles.hpp&lt;/itemPath&gt;
-          &lt;itemPath&gt;src/NetPanzer/Units/UnitList.hpp&lt;/itemPath&gt;
           &lt;itemPath&gt;src/NetPanzer/Units/UnitOpcodeDecoder.cpp&lt;/itemPath&gt;
           &lt;itemPath&gt;src/NetPanzer/Units/UnitOpcodeDecoder.hpp&lt;/itemPath&gt;
           &lt;itemPath&gt;src/NetPanzer/Units/UnitOpcodeEncoder.cpp&lt;/itemPath&gt;
@@ -1955,9 +1954,6 @@
       &lt;item path=&quot;src/NetPanzer/Units/UnitLifecycles.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
-      &lt;item path=&quot;src/NetPanzer/Units/UnitList.hpp&quot;&gt;
-        &lt;itemTool&gt;3&lt;/itemTool&gt;
-      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Units/UnitOpcodeDecoder.cpp&quot;&gt;
         &lt;itemTool&gt;1&lt;/itemTool&gt;
       &lt;/item&gt;
@@ -3678,9 +3674,6 @@
       &lt;item path=&quot;src/NetPanzer/Units/UnitLifecycles.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
-      &lt;item path=&quot;src/NetPanzer/Units/UnitList.hpp&quot;&gt;
-        &lt;itemTool&gt;3&lt;/itemTool&gt;
-      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Units/UnitOpcodeDecoder.cpp&quot;&gt;
         &lt;itemTool&gt;1&lt;/itemTool&gt;
       &lt;/item&gt;
@@ -5401,9 +5394,6 @@
       &lt;item path=&quot;src/NetPanzer/Units/UnitLifecycles.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
-      &lt;item path=&quot;src/NetPanzer/Units/UnitList.hpp&quot;&gt;
-        &lt;itemTool&gt;3&lt;/itemTool&gt;
-      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Units/UnitOpcodeDecoder.cpp&quot;&gt;
         &lt;itemTool&gt;1&lt;/itemTool&gt;
       &lt;/item&gt;
@@ -7124,9 +7114,6 @@
       &lt;item path=&quot;src/NetPanzer/Units/UnitLifecycles.hpp&quot;&gt;
         &lt;itemTool&gt;3&lt;/itemTool&gt;
       &lt;/item&gt;
-      &lt;item path=&quot;src/NetPanzer/Units/UnitList.hpp&quot;&gt;
-        &lt;itemTool&gt;3&lt;/itemTool&gt;
-      &lt;/item&gt;
       &lt;item path=&quot;src/NetPanzer/Units/UnitOpcodeDecoder.cpp&quot;&gt;
         &lt;itemTool&gt;1&lt;/itemTool&gt;
       &lt;/item&gt;

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp	2008-09-21 03:51:15 UTC (rev 1066)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp	2008-09-21 10:57:57 UTC (rev 1067)
@@ -20,7 +20,6 @@
 
 #include &lt;vector&gt;
 #include &lt;map&gt;
-#include &quot;Units/UnitList.hpp&quot;
 #include &quot;Units/UnitBucketArray.hpp&quot;
 #include &quot;Classes/UnitMessage.hpp&quot;
 #include &quot;Classes/PlayerState.hpp&quot;

Deleted: trunk/netpanzer/src/NetPanzer/Units/UnitList.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitList.hpp	2008-09-21 03:51:15 UTC (rev 1066)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitList.hpp	2008-09-21 10:57:57 UTC (rev 1067)
@@ -1,223 +0,0 @@
-/*
-Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
- 
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
- 
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
- 
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-#ifndef _UNITLIST_HPP
-#define _UNITLIST_HPP
-
-#include &lt;vector&gt;
-#include &lt;algorithm&gt;
-#include &lt;assert.h&gt;
-
-#include &quot;Units/UnitBase.hpp&quot;
-
-#if 0
-
-class UnitList
-{
-private:
-    class IdUnit
-    {
-    public:
-	IdUnit(UnitBase* newunit, size_t newid)
-	    : unit(newunit), id(newid)
-	{
-	}
-
-        bool operator&lt; (const IdUnit&amp; otherunitid) const
-        {
-            return id &lt; otherunitid.id;
-        }
-
-	bool operator&lt; (const size_t&amp; compareid) const
-	{
-	    return id &lt; compareid;
-	}
-
-	bool operator == (const size_t&amp; compareid) const
-	{
-	    return id == compareid;
-	}
-
-	UnitBase* unit;
-	size_t id;
-    };
-    
-    std::vector&lt;IdUnit&gt; unitlist;
-    size_t unitlistsize;
-    typedef std::vector&lt;IdUnit&gt;::iterator unititerator;
-    typedef std::vector&lt;IdUnit&gt;::const_iterator const_unititerator;
-    
-public:
-    class iterator
-    {
-    public:
-	iterator&amp; operator++ ()
-	{
-	    ++i;
-	    return *this;
-	}
-
-	UnitBase* operator*() const
-	{
-	    return i-&gt;unit;
-	}
-
-	UnitBase* operator-&gt;() const
-	{
-	    return i-&gt;unit;
-	}
-
-	bool operator!=(const iterator&amp; other) const
-	{
-	    return i != other.i;
-	}
-
-	bool operator== (const iterator&amp; other) const
-	{
-	    return i == other.i;
-	}
-	
-    private:
-	friend class UnitList;
-	iterator(unititerator newi)
-	    : i(newi)
-	{
-	}
-	unititerator i;
-    };
-
-    class AsyncIterator 
-    {
-    public:
-        UnitBase* next()
-        {
-            unititerator i
-                = std::lower_bound(unitlist-&gt;unitlist.begin(),
-                        unitlist-&gt;unitlist.end(), IdUnit(0, currentid));
-            if(i == unitlist-&gt;unitlist.end())
-                return 0;
-            UnitBase* unit = i-&gt;unit;
-
-            currentid = i-&gt;id + 1;
-	    
-            return unit;
-        }
-
-    private:
-        friend class UnitList;
-        AsyncIterator(UnitList* newunitlist, size_t startid)
-            : currentid(startid), unitlist(newunitlist)             
-        {
-        }
-        
-        size_t currentid;
-        UnitList* unitlist;
-    };
-    
-    UnitList()
-	: unitlistsize(0)
-    { }
-
-    iterator begin()
-    {
-	return iterator(unitlist.begin());
-    }
-
-    iterator end()
-    {
-	return iterator(unitlist.end());
-    }
-
-    AsyncIterator getAsyncIterator()
-    {
-        return AsyncIterator(this, 0);
-    }
-
-    UnitBase* operator[] (size_t index) const
-    {
-	const_unititerator i 
-	    = std::lower_bound(unitlist.begin(), unitlist.end(), index);
-	if(i == unitlist.end() || i-&gt;id != index)
-            return 0;
-        
-	return i-&gt;unit;
-    }
-
-    void insert(UnitBase *unit, size_t index)
-    {
-	unititerator i 
-            = std::lower_bound(unitlist.begin(), unitlist.end(), index);
-
-        unitlist.insert(i, IdUnit(unit, index));
-	++unitlistsize;
-    }
-
-    void insert(UnitBase *unit, const UnitID &amp;unitID)
-    {
-	insert(unit, unitID.getIndex());
-    }
-
-    /** remember that erasing invalidates all existing iterators over the
-     * list. The only valid iterator is the returned from this function (which
-     * points to the next elements after the one removed)
-     */
-    iterator erase(iterator i)
-    {
-	--unitlistsize;
-	return unitlist.erase(i.i);
-    }
-
-    bool contains(size_t index) const
-    {
-	const_unititerator i 
-	    = std::lower_bound(unitlist.begin(), unitlist.end(), index);
-
-	return i != unitlist.end();
-    }
-
-    bool contains(const UnitID &amp;unitID) const
-    {
-	return contains(unitID.getIndex());
-    }
-
-    iterator find(size_t index)
-    {
-	unititerator i
-	    = std::lower_bound(unitlist.begin(), unitlist.end(), index);
-	
-	if(i == unitlist.end() || i-&gt;id != index)
-	    i = unitlist.end();
-
-	return iterator(i);
-    }
-
-    void clear()
-    {
-	unitlist.clear();
-        unitlistsize = 0;
-    }
-
-    size_t size() const
-    {
-	return unitlistsize;
-    }
-};
-
-#endif
-
-#endif
-

Modified: trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp	2008-09-21 03:51:15 UTC (rev 1066)
+++ trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp	2008-09-21 10:57:57 UTC (rev 1067)
@@ -109,6 +109,8 @@
     body_anim_shadow.attachSprite( &amp;turret_anim_shadow, zero );
     body_anim_shadow.attachSprite( &amp;turret_anim, zero );
     body_anim_shadow.attachSprite( &amp;select_info_box, zero );
+    
+    aiFsmMoveToLoc_wait_timer.changePeriod( 0.8f );
 }
 
 void Vehicle::setUnitProperties( unsigned char utype )
@@ -924,7 +926,8 @@
                     MapInterface::pointXYtoMapXY( aiFsmMoveToLoc_prev_loc, &amp;aiFsmMoveToLoc_prev_loc );
                     UnitBlackBoard::markUnitLoc( aiFsmMoveToLoc_prev_loc );
 
-                    aiFsmMoveToLoc_wait_timer.changePeriod( 0.8f );
+                    //aiFsmMoveToLoc_wait_timer.changePeriod( 0.8f );
+                    aiFsmMoveToLoc_wait_timer.reset();
                     aiFsmMoveToLoc_state = _aiFsmMoveToLoc_wait_clear_loc;
                 }
             }
@@ -971,17 +974,23 @@
                             PathRequest path_request;
                             path_request.set(id, aiFsmMoveToLoc_prev_loc, aiFsmMoveToLoc_goal, 0, &amp;path, _path_request_full );
                             PathScheduler::requestPath( path_request );
+                            aiFsmMoveToLoc_wait_timer.changePeriod( 0.8f );
                         }
                         else
                         {
+//                            LOGGER.warning(&quot;Requesting updated path for unit %d from %d,%d to %d,%d&quot;, id,
+//                                           aiFsmMoveToLoc_prev_loc.x, aiFsmMoveToLoc_prev_loc.y,
+//                                           aiFsmMoveToLoc_goal.x,aiFsmMoveToLoc_goal.y);
                             PathRequest path_request;
                             path_request.set(id, aiFsmMoveToLoc_prev_loc, aiFsmMoveToLoc_goal, 0, &amp;path, _path_request_update );
                             PathScheduler::requestPath( path_request );
+                            // XXX the more times timeout the longer will take next time
+                            aiFsmMoveToLoc_wait_timer.changePeriod( aiFsmMoveToLoc_wait_timer.getPeriod() * 2.0f );
                         }
 
                         aiFsmMoveToLoc_state = _aiFsmMoveToLoc_path_generate;
                     }
-
+                    // can't move and has to wait, finish the loop.
                     end_cycle = true;
                 }
                 else
@@ -992,6 +1001,7 @@
                     setFsmMoveMapSquare( aiFsmMoveToLoc_next_square );
 
                     aiFsmMoveToLoc_state = _aiFsmMoveToLoc_move_wait;
+                    aiFsmMoveToLoc_wait_timer.changePeriod( 0.8f );
                 }
 
             }
@@ -1750,6 +1760,7 @@
     ai_command_state = _ai_command_move_to_loc;
     aiFsmMoveToLoc_state = _aiFsmMoveToLoc_path_generate;
     aiFsmMoveToLoc_path_not_finished = true;
+    aiFsmMoveToLoc_wait_timer.changePeriod( 0.8f );
 
     opcode_move_timer.changePeriod( 0.10f );
     move_opcode_sent = false;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000102.html">[Netpanzer-cvs] r1066 - trunk/netpanzer/src/NetPanzer/Units
</A></li>
	<LI>Next message: <A HREF="000104.html">[Netpanzer-cvs] r1068 - in trunk/netpanzer/src/NetPanzer:	Classes/Network Network
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#103">[ date ]</a>
              <a href="thread.html#103">[ thread ]</a>
              <a href="subject.html#103">[ subject ]</a>
              <a href="author.html#103">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">More information about the Netpanzer-cvs
mailing list</a><br>
</body></html>
