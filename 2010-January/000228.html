<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Netpanzer-cvs] r1202 - in trunk/netpanzer: maps src/Lib/Network
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/netpanzer-cvs/2010-January/index.html" >
   <LINK REL="made" HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1202%20-%20in%20trunk/netpanzer%3A%20maps%20src/Lib/Network&In-Reply-To=%3C201001251345.o0PDjl8q008129%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000227.html">
   <LINK REL="Next"  HREF="000229.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Netpanzer-cvs] r1202 - in trunk/netpanzer: maps src/Lib/Network</H1>
    <B>kromxp at mail.berlios.de</B> 
    <A HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1202%20-%20in%20trunk/netpanzer%3A%20maps%20src/Lib/Network&In-Reply-To=%3C201001251345.o0PDjl8q008129%40sheep.berlios.de%3E"
       TITLE="[Netpanzer-cvs] r1202 - in trunk/netpanzer: maps src/Lib/Network">kromxp at mail.berlios.de
       </A><BR>
    <I>Mon Jan 25 14:45:47 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000227.html">[Netpanzer-cvs] r1201 - in trunk/netpanzer/src/NetPanzer:	Interfaces PowerUps Views/Components Views/Game
</A></li>
        <LI>Next message: <A HREF="000229.html">[Netpanzer-cvs] r1203 - in trunk/netpanzer: . pics/default	src/Lib/2D src/Lib/Network src/Lib/Util src/NetPanzer/Classes	src/NetPanzer/Classes/Network src/NetPanzer/Interfaces	src/NetPanzer/PowerUps src/NetPanzer/Resources	src/NetPanzer/System src/NetPanzer/Views/Game	src/NetPanzer/Views/MainMenu src/NetPanzer/Views/MainMenu/Multi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#228">[ date ]</a>
              <a href="thread.html#228">[ thread ]</a>
              <a href="subject.html#228">[ subject ]</a>
              <a href="author.html#228">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: kromxp
Date: 2010-01-25 14:44:51 +0100 (Mon, 25 Jan 2010)
New Revision: 1202

Added:
   trunk/netpanzer/maps/Hill 221 (mod).npm
   trunk/netpanzer/maps/Hill 221 (mod).opt
   trunk/netpanzer/maps/Hill 221 (mod).spn
   trunk/netpanzer/maps/Operation Blue.npm
   trunk/netpanzer/maps/Operation Blue.opt
   trunk/netpanzer/maps/Operation Blue.spn
Modified:
   trunk/netpanzer/src/Lib/Network/SocketBase.cpp
   trunk/netpanzer/src/Lib/Network/UDPSocket.cpp
Log:
- better handling of network errors to avoid premature server termination.
- added new maps by Geppi (one is a modified version of existing map).



Added: trunk/netpanzer/maps/Hill 221 (mod).npm
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/maps/Hill 221 (mod).npm
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/maps/Hill 221 (mod).opt
===================================================================
--- trunk/netpanzer/maps/Hill 221 (mod).opt	2010-01-24 16:03:21 UTC (rev 1201)
+++ trunk/netpanzer/maps/Hill 221 (mod).opt	2010-01-25 13:44:51 UTC (rev 1202)
@@ -0,0 +1,43 @@
+ObjectiveCount: 21
+Name: Falcon I
+Location: 22 13
+Name: Falcon II
+Location: 19 48
+Name: Falcon III
+Location: 90 24
+Name: Charly Nord
+Location: 379 15
+Name: Charly Middle
+Location: 380 87
+Name: Charly South
+Location: 376 123
+Name: Foxtrott East
+Location: 195 125
+Name: Foxtrott South
+Location: 202 155
+Name: Foxtrott West
+Location: 155 132
+Name: Bismark HQ
+Location: 21 176
+Name: Bismark East
+Location: 65 168
+Name: Bismark South
+Location: 50 217
+Name: Leipzig
+Location: 243 216
+Name: Chemnitz
+Location: 236 240
+Name: Dresden
+Location: 294 239
+Name: Alpha I
+Location: 322 330
+Name: Alpha II
+Location: 317 370
+Name: Alpha III
+Location: 262 367
+Name: Dakota II
+Location: 39 379
+Name: Dakota HQ
+Location: 77 360
+Name: Dakota I
+Location: 128 384

Added: trunk/netpanzer/maps/Hill 221 (mod).spn
===================================================================
--- trunk/netpanzer/maps/Hill 221 (mod).spn	2010-01-24 16:03:21 UTC (rev 1201)
+++ trunk/netpanzer/maps/Hill 221 (mod).spn	2010-01-25 13:44:51 UTC (rev 1202)
@@ -0,0 +1 @@
+SpawnCount: 11
Location: 29 282
Location: 125 303
Location: 221 283
Location: 199 378
Location: 388 242
Location: 347 185
Location: 269 57
Location: 217 53
Location: 65 78
Location: 133 181
Location: 160 268
\ No newline at end of file

Added: trunk/netpanzer/maps/Operation Blue.npm
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/maps/Operation Blue.npm
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/maps/Operation Blue.opt
===================================================================
--- trunk/netpanzer/maps/Operation Blue.opt	2010-01-24 16:03:21 UTC (rev 1201)
+++ trunk/netpanzer/maps/Operation Blue.opt	2010-01-25 13:44:51 UTC (rev 1202)
@@ -0,0 +1,33 @@
+ObjectiveCount: 16
+Name: Madrid
+Location: 86 31
+Name: Sevilla
+Location: 23 104
+Name: Valencia
+Location: 144 103
+Name: Bilbao
+Location: 199 7
+Name: Paris
+Location: 279 77
+Name: Toulouse
+Location: 340 173
+Name: Lyon
+Location: 429 110
+Name: Nancy
+Location: 474 15
+Name: Potsdam
+Location: 161 313
+Name: Koeln
+Location: 49 352
+Name: Dresden
+Location: 154 423
+Name: Bamberg
+Location: 30 459
+Name: Breslau
+Location: 364 439
+Name: Krakau
+Location: 480 478
+Name: Warschau
+Location: 484 232
+Name: Lodz
+Location: 396 293

Added: trunk/netpanzer/maps/Operation Blue.spn
===================================================================
--- trunk/netpanzer/maps/Operation Blue.spn	2010-01-24 16:03:21 UTC (rev 1201)
+++ trunk/netpanzer/maps/Operation Blue.spn	2010-01-25 13:44:51 UTC (rev 1202)
@@ -0,0 +1 @@
+SpawnCount: 4
Location: 120 66
Location: 383 59
Location: 380 379
Location: 107 390
\ No newline at end of file

Modified: trunk/netpanzer/src/Lib/Network/SocketBase.cpp
===================================================================
--- trunk/netpanzer/src/Lib/Network/SocketBase.cpp	2010-01-24 16:03:21 UTC (rev 1201)
+++ trunk/netpanzer/src/Lib/Network/SocketBase.cpp	2010-01-25 13:44:51 UTC (rev 1202)
@@ -108,10 +108,10 @@
 #endif
     if ( res == SOCKET_ERROR ) {
         lastError = GET_NET_ERROR();
-        doClose();
+//        doClose();
         std::stringstream msg;
         msg &lt;&lt; &quot;Couldn't set socket to nonblocking mode: &quot; &lt;&lt; NETSTRERROR(lastError);
-        throw NetworkException(msg.str());
+        LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
     }
 }
 
@@ -137,10 +137,10 @@
     int res = setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;val, sizeof(val));
     if(res == SOCKET_ERROR) {
         lastError = GET_NET_ERROR();
-        doClose();
+//        doClose();
         std::stringstream msg;
         msg &lt;&lt; &quot;Couldn't set SO_REUSEADDR: &quot; &lt;&lt; NETSTRERROR(lastError);
-        throw NetworkException(msg.str());
+        LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
     }
 }
 
@@ -154,8 +154,7 @@
 //        doClose();
         std::stringstream msg;
         msg &lt;&lt; &quot;Couldn't set TCP_NODELAY: &quot; &lt;&lt; NETSTRERROR(lastError);
-//        throw NetworkException(msg.str());
-        LOGGER.warning(&quot;NetError: %s&quot;, msg.str().c_str());
+        LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
     }
 }
 
@@ -197,17 +196,17 @@
     int res = send(sockfd, (const char*) data, len, SEND_FLAGS);
     if(res == SOCKET_ERROR) {
         lastError = GET_NET_ERROR();
-        if ( IS_DISCONECTED(lastError) ) {
-            onDisconected();
+        if ( IS_IGNORABLE_ERROR(lastError) )
             return 0;
+
+        if ( ! IS_DISCONECTED(lastError) ) {
+            std::stringstream msg;
+            msg &lt;&lt; &quot;Send error: &quot; &lt;&lt; NETSTRERROR(lastError);
+            LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
         }
         
-        if ( IS_IGNORABLE_ERROR(lastError) )
-            return 0;
-        
-        std::stringstream msg;
-        msg &lt;&lt; &quot;Send error: &quot; &lt;&lt; NETSTRERROR(lastError);
-        throw NetworkException(msg.str());
+        onDisconected();
+        return 0;
     }
     return res;
 }
@@ -218,17 +217,17 @@
     int res = recv(sockfd, (char*) buffer, len, RECV_FLAGS);
     if(res == SOCKET_ERROR) {
         lastError = GET_NET_ERROR();
-        if ( IS_DISCONECTED(lastError) ) {
-            onDisconected();
-            return 0;
-        }
-        
         if ( IS_IGNORABLE_ERROR(lastError) )
             return 0;
 
-        std::stringstream msg;
-        msg &lt;&lt; &quot;Read error: &quot; &lt;&lt; NETSTRERROR(lastError);
-        throw NetworkException(msg.str());
+        if ( ! IS_DISCONECTED(lastError) ) {
+            std::stringstream msg;
+            msg &lt;&lt; &quot;Read error: &quot; &lt;&lt; NETSTRERROR(lastError);
+            LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
+        }
+
+        onDisconected();
+        return 0;
     }
     
     if (!res) {
@@ -246,11 +245,13 @@
                 toaddr.getSockaddr(), toaddr.getSockaddrLen());
     if(res == SOCKET_ERROR) {
         lastError = GET_NET_ERROR();
-        if ( IS_SENDTO_IGNORABLE(lastError) )
-            return 0;
-        std::stringstream msg;
-        msg &lt;&lt; &quot;Send error: &quot; &lt;&lt; NETSTRERROR(lastError);
-        throw NetworkException(msg.str());
+        if ( ! IS_SENDTO_IGNORABLE(lastError) )
+        {
+            std::stringstream msg;
+            msg &lt;&lt; &quot;Send error: &quot; &lt;&lt; NETSTRERROR(lastError);
+            LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
+        }
+        return 0;
     }
     return res;
 }
@@ -260,14 +261,17 @@
 {
     int res = recvfrom(sockfd, (char*) buffer, len, RECV_FLAGS,
             fromaddr.getSockaddr(), fromaddr.getSockaddrLenPointer());
-    if(res == SOCKET_ERROR) {
+    if ( res == SOCKET_ERROR )
+    {
         lastError = GET_NET_ERROR();
-        if ( IS_RECVFROM_IGNORABLE(lastError) )
-            return 0;
+        if ( ! IS_RECVFROM_IGNORABLE(lastError) )
+        {
+            std::stringstream msg;
+            msg &lt;&lt; &quot;Receive error: &quot; &lt;&lt; NETSTRERROR(lastError);
+            LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
+        }
 
-        std::stringstream msg;
-        msg &lt;&lt; &quot;Receive error: &quot; &lt;&lt; NETSTRERROR(lastError);
-        throw NetworkException(msg.str());
+        return 0;
     }
     return res;
 }
@@ -277,13 +281,15 @@
 {
     SOCKET newsock;
     newsock= accept(sockfd, fromaddr.getSockaddr(), fromaddr.getSockaddrLenPointer());
-    if (newsock == INVALID_SOCKET) {
+    if ( newsock == INVALID_SOCKET )
+    {
         lastError = GET_NET_ERROR();
-        if ( IS_ACCEPT_IGNORABLE(lastError) )
-            return INVALID_SOCKET; // XXX this could be better
-        std::stringstream msg;
-        msg &lt;&lt; &quot;Accept error: &quot; &lt;&lt; NETSTRERROR(lastError);
-        throw NetworkException(msg.str());
+        if ( ! IS_ACCEPT_IGNORABLE(lastError) )
+        {
+            std::stringstream msg;
+            msg &lt;&lt; &quot;Accept error: &quot; &lt;&lt; NETSTRERROR(lastError);
+            LOGGER.warning(&quot;%s&quot;, msg.str().c_str());
+        }
     }
     return newsock;
 }

Modified: trunk/netpanzer/src/Lib/Network/UDPSocket.cpp
===================================================================
--- trunk/netpanzer/src/Lib/Network/UDPSocket.cpp	2010-01-24 16:03:21 UTC (rev 1201)
+++ trunk/netpanzer/src/Lib/Network/UDPSocket.cpp	2010-01-25 13:44:51 UTC (rev 1202)
@@ -20,8 +20,8 @@
 
 #include &quot;UDPSocket.hpp&quot;
 #include &lt;sstream&gt;
+#include &quot;Util/Log.hpp&quot;
 
-
 namespace network
 {
 
@@ -65,7 +65,7 @@
     if(res != (int) datasize) {
         std::stringstream msg;
         msg &lt;&lt; &quot;Send error: not all data sent.&quot;;
-        throw NetworkException(msg.str());
+        LOGGER.warning(msg.str().c_str());
     }
 }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000227.html">[Netpanzer-cvs] r1201 - in trunk/netpanzer/src/NetPanzer:	Interfaces PowerUps Views/Components Views/Game
</A></li>
	<LI>Next message: <A HREF="000229.html">[Netpanzer-cvs] r1203 - in trunk/netpanzer: . pics/default	src/Lib/2D src/Lib/Network src/Lib/Util src/NetPanzer/Classes	src/NetPanzer/Classes/Network src/NetPanzer/Interfaces	src/NetPanzer/PowerUps src/NetPanzer/Resources	src/NetPanzer/System src/NetPanzer/Views/Game	src/NetPanzer/Views/MainMenu src/NetPanzer/Views/MainMenu/Multi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#228">[ date ]</a>
              <a href="thread.html#228">[ thread ]</a>
              <a href="subject.html#228">[ subject ]</a>
              <a href="author.html#228">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">More information about the Netpanzer-cvs
mailing list</a><br>
</body></html>
