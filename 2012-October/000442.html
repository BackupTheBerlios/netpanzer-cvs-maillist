<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Netpanzer-cvs] r1418 - in trunk/netpanzer/src/NetPanzer: Actions	Bot Classes Classes/Network Core Interfaces Network	Network/PlayerRequests Objectives PowerUps Units	Views/Components Views/Game Weapons
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/netpanzer-cvs/2012-October/index.html" >
   <LINK REL="made" HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1418%20-%20in%20trunk/netpanzer/src/NetPanzer%3A%20Actions%0A%09Bot%20Classes%20Classes/Network%20Core%20Interfaces%20Network%0A%09Network/PlayerRequests%20Objectives%20PowerUps%20Units%0A%09Views/Components%20Views/Game%20Weapons&In-Reply-To=%3C20121023112729.8A3A355B0C%40scm.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000441.html">
   <LINK REL="Next"  HREF="000443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Netpanzer-cvs] r1418 - in trunk/netpanzer/src/NetPanzer: Actions	Bot Classes Classes/Network Core Interfaces Network	Network/PlayerRequests Objectives PowerUps Units	Views/Components Views/Game Weapons</H1>
    <B>kromxp at scm.berlios.de</B> 
    <A HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1418%20-%20in%20trunk/netpanzer/src/NetPanzer%3A%20Actions%0A%09Bot%20Classes%20Classes/Network%20Core%20Interfaces%20Network%0A%09Network/PlayerRequests%20Objectives%20PowerUps%20Units%0A%09Views/Components%20Views/Game%20Weapons&In-Reply-To=%3C20121023112729.8A3A355B0C%40scm.berlios.de%3E"
       TITLE="[Netpanzer-cvs] r1418 - in trunk/netpanzer/src/NetPanzer: Actions	Bot Classes Classes/Network Core Interfaces Network	Network/PlayerRequests Objectives PowerUps Units	Views/Components Views/Game Weapons">kromxp at scm.berlios.de
       </A><BR>
    <I>Tue Oct 23 13:27:29 CEST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="000441.html">[Netpanzer-cvs] r1417 - in trunk/netpanzer: Languages	src/NetPanzer/Classes/Network src/NetPanzer/Objectives	src/NetPanzer/Views/Game
</A></li>
        <LI>Next message: <A HREF="000443.html">[Netpanzer-cvs] r1419 - in trunk/netpanzer: Languages	src/NetPanzer/Core src/NetPanzer/Interfaces	src/NetPanzer/Network/PlayerRequests src/NetPanzer/Views/Components	src/NetPanzer/Views/MainMenu/Multi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#442">[ date ]</a>
              <a href="thread.html#442">[ thread ]</a>
              <a href="subject.html#442">[ subject ]</a>
              <a href="author.html#442">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: kromxp
Date: 2012-10-23 13:27:27 +0200 (Tue, 23 Oct 2012)
New Revision: 1418

Added:
   trunk/netpanzer/src/NetPanzer/Actions/StartSurrenderVoteAction.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AllianceRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AttackUnitRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/BreakAllianceRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeFlagRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveOutLocationRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeTeamRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChatRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ManualFireRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/MoveUnitRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerReadyRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerRequests.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/StartSurrenderVoteRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/TeamChatRequest.hpp
   trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/VoteSelectedRequest.hpp
Removed:
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetTypes.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkReturnCodes.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/TerminalNetMesg.hpp
   trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.cpp
   trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.hpp
   trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp
   trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp
Modified:
   trunk/netpanzer/src/NetPanzer/Actions/ActionManagerGUIActions.cpp
   trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetMessage.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.cpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/ObjectiveNetMessage.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/ServerConnectDaemon.cpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.cpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.hpp
   trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp
   trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp
   trunk/netpanzer/src/NetPanzer/Core/CoreTypes.hpp
   trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp
   trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.hpp
   trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.hpp
   trunk/netpanzer/src/NetPanzer/Interfaces/Team.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/Team.hpp
   trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp
   trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.hpp
   trunk/netpanzer/src/NetPanzer/Objectives/Objective.cpp
   trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.cpp
   trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.hpp
   trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp
   trunk/netpanzer/src/NetPanzer/Units/UnitBase.hpp
   trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp
   trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp
   trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp
   trunk/netpanzer/src/NetPanzer/Units/Vehicle.hpp
   trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp
   trunk/netpanzer/src/NetPanzer/Views/Components/tStringListBox.hpp
   trunk/netpanzer/src/NetPanzer/Views/Game/GFlagSelectionView.cpp
   trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp
   trunk/netpanzer/src/NetPanzer/Views/Game/RankView.cpp
   trunk/netpanzer/src/NetPanzer/Views/Game/VehicleSelectionView.cpp
   trunk/netpanzer/src/NetPanzer/Views/Game/VoteBox.cpp
   trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp
   trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp
   trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp
   trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp
Log:
- Protocol client -&gt; server almost completely modified, still has to do the connecting procedure. Many internals changed due to protocol.
- Fixed the scroll bar bug in chat.
- Almost no testing done

Others:
- Remove some unused code
- Teams has an internal type: TeamID

Modified: trunk/netpanzer/src/NetPanzer/Actions/ActionManagerGUIActions.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Actions/ActionManagerGUIActions.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Actions/ActionManagerGUIActions.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -24,6 +24,7 @@
 #include &quot;DisconnectAction.hpp&quot;
 #include &quot;ChatPageUpAction.hpp&quot;
 #include &quot;ChatPageDownAction.hpp&quot;
+#include &quot;StartSurrenderVoteAction.hpp&quot;
 
 void ActionManager::addGUIActions()
 {
@@ -44,4 +45,6 @@
     addAction(&quot;chat_pgup&quot;, new ChatPageUpAction());
     addAction(&quot;chat_pgdown&quot;, new ChatPageDownAction());
     
+    addAction(&quot;startvote_surrender&quot;, new StartSurrenderVoteAction());
+    
 }
\ No newline at end of file

Added: trunk/netpanzer/src/NetPanzer/Actions/StartSurrenderVoteAction.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Actions/StartSurrenderVoteAction.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Actions/StartSurrenderVoteAction.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,45 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 21, 2012, 5:06 PM
+ */
+
+#ifndef STARTSURRENDERVOTEACTION_HPP
+#define	STARTSURRENDERVOTEACTION_HPP
+
+#include &quot;Action.hpp&quot;
+#include &quot;Network/PlayerRequests/StartSurrenderVoteRequest.hpp&quot;
+#include &quot;Classes/Network/NetworkClient.hpp&quot;
+#include &quot;Views/Components/Desktop.hpp&quot;
+
+class StartSurrenderVoteAction : public Action
+{
+public:
+    StartSurrenderVoteAction() : Action(true) {}
+    
+    void execute()
+    {
+        if ( !Desktop::getVisible(&quot;PrepareTeam&quot;) &amp;&amp; !Desktop::getVisible(&quot;GFlagSelectionView&quot;) )
+        {
+            StartSurrenderVoteRequest req;
+            CLIENT-&gt;sendMessage(&amp;req, sizeof(req));
+        }
+    }
+};
+
+#endif	/* STARTSURRENDERVOTEACTION_HPP */
+

Modified: trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -24,12 +24,17 @@
 #include &quot;Classes/PlacementMatrix.hpp&quot;
 #include &quot;Units/UnitBase.hpp&quot;
 #include &quot;Objectives/Objective.hpp&quot;
-#include &quot;Classes/Network/TerminalNetMesg.hpp&quot;
 #include &quot;Classes/Network/NetworkClient.hpp&quot;
 #include &quot;Classes/Network/NetworkState.hpp&quot;
 #include &quot;Objectives/ObjectiveInterface.hpp&quot;
 #include &quot;Util/Log.hpp&quot;
 
+#include &quot;Network/PlayerRequests/MoveUnitRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/AttackUnitRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ManualFireRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp&quot;
+
+
 Bot *Bot::s_bot = 0;
 //-----------------------------------------------------------------
 void
@@ -56,11 +61,11 @@
     matrix.reset(map_pos);
     matrix.getNextEmptyLoc(&amp;map_pos);
 
-    TerminalUnitCmdRequest comm_mesg;
-    comm_mesg.comm_request.setHeader(unit-&gt;id, _umesg_flag_unique);
-    comm_mesg.comm_request.setMoveToLoc(map_pos);
+    MoveUnitRequest comm_mesg;
+    comm_mesg.setUnitId(unit-&gt;id);
+    comm_mesg.setMapPos(map_pos);
 
-    CLIENT-&gt;sendMessage(&amp;comm_mesg, sizeof(TerminalUnitCmdRequest));
+    CLIENT-&gt;sendMessage(&amp;comm_mesg, sizeof(comm_mesg));
     m_tasks.setUnitTask(unit, BotTaskList::TASK_MOVE);
 
     LOGGER.debug(&quot;bot: moveUnit %d to %dx%d&quot;, unit-&gt;id, map_pos.x, map_pos.y);
@@ -72,11 +77,11 @@
     assert(unit != 0);
     assert(enemyUnit != 0);
 
-    TerminalUnitCmdRequest comm_mesg;
-    comm_mesg.comm_request.setHeader(unit-&gt;id, _umesg_flag_unique);
-    comm_mesg.comm_request.setTargetUnit(enemyUnit-&gt;id);
+    AttackUnitRequest comm_mesg;
+    comm_mesg.setUnitId(unit-&gt;id);
+    comm_mesg.setEnemyId(enemyUnit-&gt;id);
 
-    CLIENT-&gt;sendMessage(&amp;comm_mesg, sizeof(TerminalUnitCmdRequest));
+    CLIENT-&gt;sendMessage(&amp;comm_mesg, sizeof(comm_mesg));
     m_tasks.setUnitTask(unit, BotTaskList::TASK_ATTACK);
 
     LOGGER.debug(&quot;bot: attackUnit %d to %d&quot;, unit-&gt;id, enemyUnit-&gt;id);
@@ -87,11 +92,11 @@
 {
     assert(unit != 0);
 
-    TerminalUnitCmdRequest comm_mesg;
-    comm_mesg.comm_request.setHeader(unit-&gt;id, _umesg_flag_unique);
-    comm_mesg.comm_request.setManualFire(world_pos);
+    ManualFireRequest comm_mesg;
+    comm_mesg.setUnitId(unit-&gt;id);
+    comm_mesg.setMapPos(world_pos);
 
-    CLIENT-&gt;sendMessage(&amp;comm_mesg, sizeof(TerminalUnitCmdRequest));
+    CLIENT-&gt;sendMessage(&amp;comm_mesg, sizeof(comm_mesg));
     //NOTE: manual fire is not special unit task,
     // unit can move and fire simultanous
 }
@@ -102,6 +107,11 @@
     LOGGER.debug(&quot;bot: produceUnit outpost=%d selectedProduce=%d&quot;,
                  outpostID, selectedProduce);
 
-    ObjectiveInterface::sendChangeGeneratingUnit(outpostID, selectedProduce, true);
- }
+    ChangeObjectiveGenerationRequest req;
+    req.setObjectiveId(outpostID);
+    req.unit_type = selectedProduce;
+    req.unit_gen_on = 1;
+    
+    CLIENT-&gt;sendMessage(&amp;req, sizeof(req));
+}
 

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetMessage.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetMessage.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetMessage.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -27,7 +27,7 @@
        _net_message_class_player,
        _net_message_class_unit,
        _net_message_class_unit_profile,
-       _net_message_class_terminal,
+       _net_message_class_player_commands,
        _net_message_class_objective,
        _net_message_class_game_control,
        _net_message_class_powerup,

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -25,7 +25,6 @@
 
 #include &quot;Classes/Network/NetPacket.hpp&quot;
 #include &quot;Classes/Network/UnitNetMessage.hpp&quot;
-#include &quot;TerminalNetMesg.hpp&quot;
 #include &quot;Units/UnitOpcodes.hpp&quot;
 
 #include &quot;NetPacketDebugger.hpp&quot;
@@ -74,7 +73,7 @@
             logUnitMessage(*log, message);
             break;
         }
-        case _net_message_class_terminal:
+        case _net_message_class_player_commands:
         {
             logTerminalMessage(*log, message);
             break;
@@ -104,13 +103,6 @@
 
     log-&gt;flags(std::ios::hex);
     log-&gt;fill('0');
-//    Uint8* data = (Uint8 *) message;
-//    for (size_t i=sizeof(NetMessage); i&lt;message-&gt;getSize(); ++i) {
-//        if ((i%4) == 0)
-//            *log &lt;&lt; &quot; &quot;;
-//        log-&gt;width(2);
-//        *log &lt;&lt; (int) data[i];
-//    }
     log-&gt;flags(std::ios::dec);
     *log &lt;&lt; std::endl;
 }
@@ -118,23 +110,7 @@
 void NetPacketDebugger::logMultiMessage(std::ostream&amp; log,
         const NetMessage* message)
 {
-//    MultiMessage* mmessage = (MultiMessage*) message;
-    
     log &lt;&lt; &quot;multimessage:\n&quot;;
-//    size_t index = 0;
-//    for(int i=0; i&lt;mmessage-&gt;message_count; i++) {
-//        if(index + mmessage-&gt;getHeaderSize() &gt;= message-&gt;getSize()) {
-//            log &lt;&lt; &quot;****Incorrect multi message!!!\n&quot;;
-//            log &lt;&lt; &quot;Index: &quot; &lt;&lt; index &lt;&lt; &quot; HeaderSize: &quot;
-//                &lt;&lt; mmessage-&gt;getHeaderSize() &lt;&lt; &quot; MessageSize: &quot;
-//                &lt;&lt; message-&gt;getSize() &lt;&lt; std::endl;
-//            return;
-//        }
-//        NetMessage* submessage = (NetMessage*) (mmessage-&gt;data + index);
-//        index += submessage-&gt;getSize();
-
-//        logMessage(&quot;  M&quot;, submessage);
-//    }
 }
 
 void NetPacketDebugger::logConnectMessage(std::ostream&amp; log,
@@ -195,15 +171,6 @@
 {
     log &lt;&lt; &quot;Terminal/&quot;;
     switch(message-&gt;message_id) {
-        case _net_message_id_term_unit_cmd:
-        {
-            TerminalUnitCmdRequest* unitcmd 
-                = (TerminalUnitCmdRequest*) message;
-            const UMesgAICommand&amp; cmd = unitcmd-&gt;comm_request;
-            log &lt;&lt; &quot;UnitCmd: &quot;;
-            logAICommand(log, cmd);
-            break;
-        }
         default:
         {
             log &lt;&lt; &quot;?&quot;;
@@ -212,45 +179,6 @@
     }
 }
 
-void NetPacketDebugger::logAICommand(std::ostream&amp; log,
-        const UMesgAICommand&amp; cmd)
-{
-    switch(cmd.command) {
-        case _command_move_to_loc:
-        {
-            log &lt;&lt; &quot;move to:&quot; 
-                &lt;&lt; cmd.getGoalLoc().x &lt;&lt; &quot;,&quot; &lt;&lt; cmd.getGoalLoc().y;
-            break;
-        }
-        case _command_attack_unit:
-        {
-            log &lt;&lt; &quot;Attack: &quot; &lt;&lt; cmd.getTargetUnitID();
-            break;
-        }
-        case _command_start_manual_move:
-        {
-            log &lt;&lt; &quot;mmove: O:&quot; &lt;&lt; cmd.manual_move_orientation;
-            break;
-        }
-        case _command_stop_manual_move:
-        {
-            log &lt;&lt; &quot;stop mm&quot;;
-            break;
-        }
-        case _command_manual_fire:
-        {
-            log &lt;&lt; &quot;MFire: &quot; &lt;&lt; cmd.getTargetLoc().x 
-                &lt;&lt; &quot;,&quot; &lt;&lt; cmd.getTargetLoc().y;
-            break;
-        }
-        default:
-        {
-            log &lt;&lt; &quot;?&quot;;
-            break;
-        }
-    }
-}
-
 void NetPacketDebugger::logUnitMessage(std::ostream&amp; log, const NetMessage* message)
 {
     log &lt;&lt; &quot;Unit/&quot;;

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -22,7 +22,6 @@
 
 class NetMessage;
 class NetPacket;
-class UMesgAICommand;
 
 class NetPacketDebugger
 {
@@ -32,7 +31,6 @@
 
 private:
     static void logTerminalMessage(std::ostream&amp; stream, const NetMessage* message);
-    static void logAICommand(std::ostream&amp; str, const UMesgAICommand&amp; command);
     static void logMultiMessage(std::ostream&amp; str, const NetMessage* message);
     static void logUnitMessage(std::ostream&amp; log, const NetMessage* message);
     static void logUnitOpcodeMessage(std::ostream&amp; log, const NetMessage* message);

Deleted: trunk/netpanzer/src/NetPanzer/Classes/Network/NetTypes.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetTypes.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetTypes.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,74 +0,0 @@
-/*
-Copyright (C) 2004 by Matthias Braun
-
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
-
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-#ifndef __NETTYPES_HPP__
-#define __NETTYPES_HPP__
-
-#include &quot;Util/Endian.hpp&quot;
-
-namespace net
-{
-
-typedef Uint8 UInt8;
-typedef Sint8 Int8;
-
-class UInt32
-{
-private:
-    Uint32 val;
-public:
-    UInt32(Uint32 val)
-    {
-        *this = val;
-    }
-
-    operator Uint32() const
-    {
-        return ltoh32(val);
-    }
-    void operator=(Uint32 val)
-    {
-        this-&gt;val = htol32(val);
-        return val;
-    }
-} __attribute__((packed));
-
-class UInt16
-{
-private:
-    Uint16 val;
-public:
-    UInt32(Uint16 val)
-    {
-        *this = val;
-    }
-
-    operator Uint16() const
-    {
-        return ltoh16(val);
-    }
-    void operator=(Uint16 val)
-    {
-        this-&gt;val = htol16(val);
-        return val;
-    }
-} __attribute__((packed));
-
-} // end of namespace net
-
-#endif
-

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -21,7 +21,6 @@
 #include &quot;Core/CoreTypes.hpp&quot;
 
 #include &quot;NetworkInterface.hpp&quot;
-#include &quot;NetworkReturnCodes.hpp&quot;
 #include &quot;Network/ClientSocket.hpp&quot;
 
 #include &quot;Util/Timer.hpp&quot;

Deleted: trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkReturnCodes.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkReturnCodes.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkReturnCodes.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,33 +0,0 @@
-/*
-Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
- 
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
- 
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
- 
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-#ifndef _NETWORK_RETURN_CODES_HPP
-#define _NETWORK_RETURN_CODES_HPP
-
-enum { _network_ok,
-       _network_failed,
-       _network_err_send_connection_lost,
-       _network_err_send_player_lost,
-       _network_err_send_transport_broken,
-       _network_err_send_busy,
-       _network_err_send_timeout
-     };
-
-enum { _network_send_no_guarantee = 0x01
-     };
-
-#endif // ** _NETWORK_RETURN_CODES_HPP

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -36,6 +36,8 @@
 #include &quot;SystemNetMessage.hpp&quot;
 #include &quot;ConnectNetMessage.hpp&quot;
 
+#include &quot;Network/TCPSocket.hpp&quot;
+#include &quot;Core/NetworkGlobals.hpp&quot;
 
 NetworkServer* SERVER = 0;
 
@@ -111,7 +113,7 @@
                                         true, true ); // tcp for binding
         
         socket = new TCPListenSocket(addr, this);
-
+        
     }
     catch(...)
     {

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkServer.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -20,7 +20,6 @@
 
 #include &lt;list&gt;
 #include &quot;NetworkInterface.hpp&quot;
-#include &quot;NetworkReturnCodes.hpp&quot;
 #include &quot;Network/TCPListenSocket.hpp&quot;
 #include &quot;Network/ClientSocket.hpp&quot;
 
@@ -58,7 +57,7 @@
 public:
     NetworkServer();
     virtual ~NetworkServer();
-
+    
     bool addClientToSendList( ClientSocket * client );
     bool isAlreadyConnected( ClientSocket * client );
     void cleanUpClientList();

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/ObjectiveNetMessage.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/ObjectiveNetMessage.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/ObjectiveNetMessage.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -23,83 +23,16 @@
 
 enum
 {
-    _net_message_id_change_output_location,
-    _net_message_id_change_generating_unit,
     _net_message_id_occupation_status_update,
-    _net_message_id_objective_sync
+    _net_message_id_objective_sync,
+    _net_message_id_objective_working_sync,
+    _net_message_id_objective_outloc_sync
 };
 
 #ifdef MSVC
 #pragma pack(1)
 #endif
 
-class ObjectiveChangeOutputLocation : public NetMessage
-{
-private:
-    ObjectiveID objective_id;
-    Uint32 map_x;
-    Uint32 map_y;
-
-public:
-    ObjectiveChangeOutputLocation()
-    {
-        message_class = _net_message_class_objective;
-        message_id = _net_message_id_change_output_location;
-    }
-
-    void set(ObjectiveID id, Uint32 map_x, Uint32 map_y)
-    {
-        objective_id = ObjectiveID_toPortable(id);
-        this-&gt;map_x = htol32(map_x);
-        this-&gt;map_y = htol32(map_y);
-    }
-
-    ObjectiveID getObjectiveId() const
-    {
-        return ObjectiveID_fromPortable(objective_id);
-    }
-
-    Uint32 getMapX() const
-    {
-        return ltoh32(map_x);
-    }
-
-    Uint32 getMapY() const
-    {
-        return ltoh32(map_y);
-    }
-
-}__attribute__((packed));
-
-class ObjectiveChangeGeneratingUnit : public NetMessage
-{
-private:
-    ObjectiveID objective_id;
-
-public:
-    Uint8 unit_type;
-    Uint8 unit_gen_on;
-
-    ObjectiveChangeGeneratingUnit()
-    {
-        message_class = _net_message_class_objective;
-        message_id = _net_message_id_change_generating_unit;
-    }
-
-    void set(ObjectiveID id, Uint8 unit_type, bool unit_generation_on)
-    {
-        objective_id = ObjectiveID_toPortable(id);
-        this-&gt;unit_type = unit_type;
-        unit_gen_on = unit_generation_on;
-    }
-
-    ObjectiveID getObjectiveId() const
-    {
-        return ObjectiveID_fromPortable(objective_id);
-    }
-
-} __attribute__((packed));
-
 class ObjectiveOccupationUpdate : public NetMessage
 {
 private:

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -21,19 +21,21 @@
 #include &quot;Core/CoreTypes.hpp&quot;
 #include &quot;NetMessage.hpp&quot;
 
+#include &quot;Network/PlayerRequests/ChangeFlagRequest.hpp&quot;
+
 enum { _net_message_id_player_connect_id,
        _net_message_id_player_sync_flag,
        _net_message_id_player_update_flag,
        _net_message_id_player_sync_state,
        _net_message_id_player_score_update,
-       _net_message_id_player_alliance_request,
-       _net_message_id_player_alliance_update,
        _net_message_id_player_flagtimer_update,
-       _net_message_id_player_changeteam_request,
-       _net_message_id_player_ready_request,
+       _net_message_id_team_change_update,
+       _net_message_id_player_ready_update,
        _net_message_id_player_team_score_sync,
        _net_message_id_player_vote_request,
-       _net_message_id_player_vote
+       _net_message_id_player_vote,
+       _net_message_id_alliance_created_update,
+       _net_message_id_alliance_broken_update
      };
 
 #ifdef MSVC
@@ -75,33 +77,6 @@
 }
 __attribute__((packed));
 
-class PlayerFlagSync : public NetMessage
-{
-public:
-    PlayerID player_id;
-    Uint8 player_flag[FLAG_WIDTH*FLAG_HEIGHT];
-
-    PlayerFlagSync()
-    {
-        message_class = _net_message_class_player;
-        message_id = _net_message_id_player_sync_flag;
-    }
-}
-__attribute__((packed));
-
-class UpdatePlayerFlag : public NetMessage
-{
-public:
-    Uint8 player_flag[FLAG_WIDTH*FLAG_HEIGHT];
-
-    UpdatePlayerFlag()
-    {
-        message_class = _net_message_class_player;
-        message_id = _net_message_id_player_update_flag;
-    }
-}
-__attribute__((packed));
-
 class PlayerScoreUpdate : public NetMessage
 {
 private:
@@ -143,76 +118,17 @@
 }
 __attribute__((packed));
 
-enum { _player_make_alliance,
-       _player_break_alliance
-     };
-
-class PlayerAllianceRequest : public NetMessage
+class PlayerFlagSync : public ChangeFlagRequest
 {
-private:
-    PlayerID allie_by_player_index;
-    PlayerID allie_with_player_index;
 public:
-    Uint8  alliance_request_type;
-
-    PlayerAllianceRequest()
+    PlayerID player_id;
+    PlayerFlagSync()
     {
         message_class = _net_message_class_player;
-        message_id = _net_message_id_player_alliance_request;
+        message_id = _net_message_id_player_sync_flag;
     }
+} __attribute__((packed));
 
-    void set(PlayerID allie_by_player_index, PlayerID allie_with_player_index,
-            Uint8 alliance_request_type)
-    {
-        this-&gt;allie_by_player_index = allie_by_player_index;
-        this-&gt;allie_with_player_index = allie_with_player_index;
-        this-&gt;alliance_request_type = alliance_request_type;
-    }
-    PlayerID getAllieByPlayerIndex() const
-    {
-        return allie_by_player_index;
-    }
-    PlayerID getAllieWithPlayerIndex() const
-    {
-        return allie_with_player_index;
-    }
-}
-__attribute__((packed));
-
-
-class PlayerAllianceUpdate : public NetMessage
-{
-private:
-    PlayerID allie_by_player_index;
-    PlayerID allie_with_player_index;
-public:
-    Uint8  alliance_update_type;
-
-    PlayerAllianceUpdate()
-    {
-        message_class = _net_message_class_player;
-        message_id = _net_message_id_player_alliance_update;
-    }
-
-    void set(PlayerID by_player_index, PlayerID with_player_index,
-            Uint8 update_type )
-    {
-        allie_by_player_index = by_player_index;
-        allie_with_player_index = with_player_index;
-        alliance_update_type = update_type;
-    }
-
-    Uint16 getAllieByPlayerIndex() const
-    {
-        return allie_by_player_index;
-    }
-    Uint16 getAllieWithPlayerIndex() const
-    {
-        return allie_with_player_index;
-    }
-}
-__attribute__((packed));
-
 class PlayerFlagTimerUpdate : public NetMessage
 {
 public:
@@ -236,65 +152,36 @@
        change_team_Accepted
      };
 
-class PlayerTeamRequest : public NetMessage
+class PlayerTeamUpdate : public NetMessage
 {
-private:
-    PlayerID player_index;
-    Uint8 team_index;
 public:
-    Uint8  request_type;
+    PlayerID player_id;
+    TeamID team_id;
 
-    PlayerTeamRequest()
+    PlayerTeamUpdate()
     {
         message_class = _net_message_class_player;
-        message_id = _net_message_id_player_changeteam_request;
+        message_id = _net_message_id_team_change_update;
     }
 
-    void set(PlayerID player_idx, Uint8 team_idx, Uint8 type_request)
-    {
-        this-&gt;player_index = player_idx;
-        this-&gt;team_index = team_idx;
-        this-&gt;request_type = type_request;
-    }
-    PlayerID getPlayerIndex() const
-    {
-        return player_index;
-    }
-    Uint8 gettoteamindex() const
-    {
-        return team_index;
-    }
 }
 __attribute__((packed));
 
 enum { ready_request,
        ready_Accepted};
 
-class PlayerReadyRequest : public NetMessage
+class PlayerReadyUpdate : public NetMessage
 {
-private:
-    PlayerID player_index;
 public:
-    Uint8  request_type;
+    PlayerID player_id;
 
-    PlayerReadyRequest()
+    PlayerReadyUpdate()
     {
         message_class = _net_message_class_player;
-        message_id = _net_message_id_player_ready_request;
+        message_id = _net_message_id_player_ready_update;
     }
+} __attribute__((packed));
 
-    void set(PlayerID player_idx, Uint8 type_request)
-    {
-        this-&gt;player_index = player_idx;
-        this-&gt;request_type = type_request;
-    }
-    PlayerID getPlayerIndex() const
-    {
-        return player_index;
-    }
-}
-__attribute__((packed));
-
 class TeamScoreSync : public NetMessage
 {
 private:

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/ServerConnectDaemon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/ServerConnectDaemon.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/ServerConnectDaemon.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -617,7 +617,7 @@
 
             unit = i-&gt;second;
             MapInterface::pointXYtoMapXY(unit-&gt;unit_state.location, unit_map_loc);
-            UnitRemoteCreate urc(unit-&gt;player-&gt;getID(),
+            UnitRemoteCreate urc(unit-&gt;player_id,
                                  unit-&gt;id,
                                  unit_map_loc.x,
                                  unit_map_loc.y,

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -25,14 +25,30 @@
 #include &quot;Objectives/ObjectiveInterface.hpp&quot;
 #include &quot;Interfaces/GameManager.hpp&quot;
 #include &quot;Interfaces/ChatInterface.hpp&quot;
+#include &quot;Interfaces/TeamManager.hpp&quot;
 
-#include &quot;TerminalNetMesg.hpp&quot;
+#include &quot;NetMessage.hpp&quot;
 #include &quot;SystemNetMessage.hpp&quot;
 #include &quot;ConnectNetMessage.hpp&quot;
 #include &quot;PlayerNetMessage.hpp&quot;
 #include &quot;Util/Log.hpp&quot;
 
+#include &quot;Network/PlayerRequests/PlayerRequests.hpp&quot;
+#include &quot;Network/PlayerRequests/AttackUnitRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ManualFireRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/MoveUnitRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeObjectiveOutLocationRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChatRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/TeamChatRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeFlagRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/AllianceRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/BreakAllianceRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeTeamRequest.hpp&quot;
+#include &quot;Interfaces/VoteManager.hpp&quot;
+#include &quot;Network/PlayerRequests/VoteSelectedRequest.hpp&quot;
 
+
 NetPacket ServerMessageRouter::temp_packet;
 NetMessageDecoder ServerMessageRouter::message_decoder;
 
@@ -44,66 +60,126 @@
 {
 }
 
-void ServerMessageRouter::processTerminalPacket(const NetPacket* packet)
+static void processPlayerCommands(const NetPacket* packet)
 {
     const NetMessage* message = packet-&gt;getNetMessage();
-    switch(message-&gt;message_id) {
-        case _net_message_id_term_unit_cmd:
-            UnitInterface::processNetPacket(packet);
+    
+    switch ( message-&gt;message_id )
+    {
+        case PlayerRequests::MOVE_UNIT :
+            UnitInterface::playerCommand_MoveUnit( packet-&gt;fromPlayer,
+                                        ((MoveUnitRequest*)message)-&gt;getUnitId(),
+                                        ((MoveUnitRequest*)message)-&gt;getMapPos());
             break;
-
-        default:
-            LOGGER.warning(&quot;unnown Terminal Message (id %d, player %u)&quot;,
-                    message-&gt;message_id, packet-&gt;fromPlayer);
+            
+        case PlayerRequests::ATTACK_UNIT :
+            UnitInterface::playerCommand_AttackUnit( packet-&gt;fromPlayer,
+                                        ((AttackUnitRequest*)message)-&gt;getUnitId(),
+                                        ((AttackUnitRequest*)message)-&gt;getEnemyId());
+            break;
+            
+        case PlayerRequests::MANUAL_FIRE :
+            UnitInterface::playerCommand_ManualShoot( packet-&gt;fromPlayer,
+                                        ((ManualFireRequest*)message)-&gt;getUnitId(),
+                                        ((ManualFireRequest*)message)-&gt;getMapPos());
+            break;
+            
+        case PlayerRequests::CHANGE_OBJECTIVE_GENERATION :
+            ObjectiveInterface::playerRequest_setGeneration(packet-&gt;fromPlayer,
+                                        ((ChangeObjectiveGenerationRequest*)message)-&gt;getObjectiveId(),
+                                        ((ChangeObjectiveGenerationRequest*)message)-&gt;unit_type,
+                                        ((ChangeObjectiveGenerationRequest*)message)-&gt;unit_gen_on);
+            break;
+            
+        case PlayerRequests::CHANGE_OBJECTIVE_OUTLOC :
+            ObjectiveInterface::playerRequest_setOutputLoc(packet-&gt;fromPlayer,
+                                        ((ChangeObjectiveOutLocationRequest*)message)-&gt;getObjectiveId(),
+                                        ((ChangeObjectiveOutLocationRequest*)message)-&gt;getMapPos());
+            break;
+            
+        case PlayerRequests::CHAT :
+            if ( packet-&gt;size &gt; sizeof(NetMessage) )
+            {
+                NPString text;
+                ((ChatRequest*)message)-&gt;getText(packet-&gt;size, text);
+                ChatInterface::playerRequest_chat(packet-&gt;fromPlayer, text);
+            }
+            else
+            {
+                LOGGER.warning(&quot;Player %d sent empty chat request&quot;, packet-&gt;fromPlayer);
+            }
+            break;
+            
+        case PlayerRequests::TEAM_CHAT :
+            if ( packet-&gt;size &gt; sizeof(NetMessage) )
+            {
+                NPString text;
+                ((TeamChatRequest*)message)-&gt;getText(packet-&gt;size, text);
+                ChatInterface::playerRequest_teamChat(packet-&gt;fromPlayer, text);
+            }
+            else
+            {
+                LOGGER.warning(&quot;Player %d sent empty team chat request&quot;, packet-&gt;fromPlayer);
+            }
+            break;
+            
+        case PlayerRequests::CHANGE_FLAG :
+            PlayerInterface::playerRequest_changeFlag(packet-&gt;fromPlayer,
+                                        ((ChangeFlagRequest*)message)-&gt;player_flag);
+                                         
+            break;
+            
+        case PlayerRequests::ALLIANCE_REQUEST :
+            PlayerInterface::playerRequest_allianceRequest(packet-&gt;fromPlayer,
+                                        ((AllianceRequest*)message)-&gt;with_player_id);
+                                         
+            break;
+            
+        case PlayerRequests::BREAK_ALLIANCE :
+            PlayerInterface::playerRequest_breakAlliance(packet-&gt;fromPlayer,
+                                        ((BreakAllianceRequest*)message)-&gt;with_player_id);
+                                         
+            break;
+            
+        case PlayerRequests::PLAYER_READY :
+            TeamManager::playerRequest_ready(packet-&gt;fromPlayer);
+            break;
+            
+        case PlayerRequests::CHANGE_TEAM :
+            TeamManager::playerRequest_changeTeam(packet-&gt;fromPlayer,
+                                        ((ChangeTeamRequest*)message)-&gt;team_id);
+            break;
+            
+        case PlayerRequests::STARTSURRENDER_VOTE :
+            VoteManager::playerRequest_startSurrenderVote(packet-&gt;fromPlayer);
+            break;
+            
+        case PlayerRequests::VOTE_SELECTED :
+            VoteManager::playerRequest_voteSelected(packet-&gt;fromPlayer,
+                                        ((VoteSelectedRequest*)message)-&gt;vote_selected);
+            break;
     }
 }
 
+
 void ServerMessageRouter::routePacket(const NetPacket* packet)
 {
     const NetMessage* message = packet-&gt;getNetMessage();
     PlayerState * player = PlayerInterface::getPlayer(packet-&gt;fromPlayer);
 
     switch (message-&gt;message_class) {
-        case _net_message_class_terminal:
+        case _net_message_class_player_commands:
             if ( player )
             {
                 player-&gt;resetAutokick();
             }
-            processTerminalPacket(packet);
+            processPlayerCommands(packet);
             break;
 
-        case _net_message_class_objective:
-            ObjectiveInterface::serverHandleNetPacket(packet);
-            break;
-
-        case _net_message_class_system:
-            if ( player )
-            {
-                player-&gt;resetAutokick();
-            }
-            GameManager::processSystemMessage(message);
-            break;
-            
-        case _net_message_class_chat:
-            if ( player )
-            {
-                player-&gt;resetAutokick();
-            }
-            ChatInterface::processChatMessages(packet);
-            break;
-
         case _net_message_class_connect:
             ServerConnectDaemon::processNetPacket(packet);
             break;
 
-        case _net_message_class_player:
-            if ( player )
-            {
-                player-&gt;resetAutokick();
-            }
-            PlayerInterface::processNetMessage(packet);
-            break;
-
         default:
             LOGGER.warning(&quot;Packet contained unknown message class: %d&quot;,
                     message-&gt;message_class);

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/ServerMessageRouter.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -26,7 +26,6 @@
 protected:
     static NetPacket temp_packet;
     static NetMessageDecoder message_decoder;
-    static void processTerminalPacket(const NetPacket* packet);
 
 public:
     static void initialize();

Deleted: trunk/netpanzer/src/NetPanzer/Classes/Network/TerminalNetMesg.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/TerminalNetMesg.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/TerminalNetMesg.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,47 +0,0 @@
-/*
-Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
- 
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
- 
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
- 
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-#ifndef _TERMINALNETMESG_HPP
-#define _TERMINALNETMESG_HPP
-
-#include &quot;NetMessage.hpp&quot;
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
-
-enum { _net_message_id_term_unit_cmd };
-
-#ifdef MSVC
-#pragma pack(1)
-#endif
-
-class TerminalUnitCmdRequest : public NetMessage
-{
-public:
-    UMesgAICommand comm_request;
-
-    TerminalUnitCmdRequest()
-    {
-        message_class = _net_message_class_terminal;
-        message_id = _net_message_id_term_unit_cmd;
-    }
-    
-}__attribute__((packed));
-
-#ifdef MSVC
-#pragma pack()
-#endif
-
-#endif

Deleted: trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,64 +0,0 @@
-/*
-Copyright (C) 2004 by Matthias Braun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">matze at braunis.de</A>&gt;
- 
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
- 
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
- 
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-
-
-#include &lt;memory&gt;
-#include &quot;Util/FileSystem.hpp&quot;
-#include &quot;Util/Exception.hpp&quot;
-#include &quot;TipOfDay.hpp&quot;
-
-TipOfDay::TipOfDay(const std::string&amp; filename)
-{
-    try {
-        std::auto_ptr&lt;filesystem::ReadFile&gt; file(
-                filesystem::openRead(filename));
-
-        std::string currenttip;
-        while(!file-&gt;eof()) {
-            std::string line;
-            file-&gt;readLine(line);
-            if(line == &quot;%%&quot;) {
-                tips.push_back(currenttip);
-                currenttip = &quot;&quot;;
-            } else {
-                currenttip += &quot; &quot;;
-                currenttip += line;
-            }
-        }
-        if(currenttip != &quot;&quot;)
-            tips.push_back(currenttip);
-    } catch(std::exception&amp; e) {
-        throw Exception(&quot;Couldn't open tipofdayfile '%s': %s&quot;,
-                filename.c_str(), e.what());
-    }
-}
-
-TipOfDay::~TipOfDay()
-{
-}
-
-size_t TipOfDay::getTipCount() const
-{
-    return tips.size();
-}
-
-const std::string&amp; TipOfDay::getTip(size_t number)
-{
-    return tips.at(number);
-}
-

Deleted: trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/TipOfDay.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,40 +0,0 @@
-/*
-Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
- 
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
- 
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
- 
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-#ifndef __TIPOFDAY_HPP__
-#define __TIPOFDAY_HPP__
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-
-/** This class parses the TipOfTheDay document
- */
-class TipOfDay
-{
-public:
-    TipOfDay(const std::string&amp; filename);
-    ~TipOfDay();
-    
-    size_t getTipCount() const;
-    const std::string&amp; getTip(size_t number);
-
-private:
-    std::vector&lt;std::string&gt; tips;    
-};
-
-#endif
-

Deleted: trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,81 +0,0 @@
-/*
-Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
- 
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
- 
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
- 
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-#ifndef _UNITMESSAGE_HPP
-#define _UNITMESSAGE_HPP
-
-#include &quot;Units/UnitBase.hpp&quot;
-
-enum { _umesg_flag_unique          = 0x01,
-       _umesg_flag_broadcast       = 0x02,
-       _umesg_flag_player          = 0x04,
-       _umesg_flag_notplayer       = 0x08,
-       _umesg_flag_send            = 0x0F,
-       _umesg_flag_queue           = 0x20,
-       _umesg_flag_manager_request = 0x40
-     };
-
-#ifdef MSVC
-#pragma pack(1)
-#endif
-
-class UnitMessage
-{
-private:
-    Uint16 unit_id;
-public:
-    Uint8 message_id;
-    Uint8 message_flags;
-
-public:
-    UnitMessage()
-    {
-        this-&gt;unit_id = 0xBADB;
-        message_id = 0;
-        message_flags = 0;
-    }
-
-    UnitMessage(UnitID unit_Id, unsigned char flags)
-    {
-        setHeader(unit_Id, flags);
-    }
-
-    UnitID getUnitID() const
-    {
-        return ltoh16(unit_id);
-    }
-
-    void setHeader(UnitID unit_id, unsigned char flags )
-    {
-        this-&gt;unit_id = htol16(unit_id);
-        message_flags = flags;
-    }
-
-    bool isFlagged(unsigned char flags) const
-    {
-        if ( (flags &amp; message_flags) == flags )
-            return true;
-
-        return false;
-    }
-} __attribute__((packed));
-
-#ifdef MSVC
-#pragma pack()
-#endif
-
-#endif // ** _UNITMESSAGE_HPP

Deleted: trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,174 +0,0 @@
-/*
-Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
- 
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
- 
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
- 
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-#ifndef _UNITMESSAGETYPES_HPP
-#define _UNITMESSAGETYPES_HPP
-
-#include &quot;Classes/UnitMessage.hpp&quot;
-
-enum { _umesg_ai_command,
-       _umesg_weapon_hit,
-       _umesg_end_lifecycle,
-       _umesg_update_select_box_info,
-       _umesg_self_destruct };
-
-enum { _command_move_to_loc,
-       _command_attack_unit,
-       _command_start_manual_move,
-       _command_stop_manual_move,
-       _command_manual_fire };
-
-#ifdef MSVC
-#pragma pack(1)
-#endif
-
-class UMesgAICommand : public UnitMessage
-{
-public:
-    Uint8 command;
-private:
-    Sint32 goal_loc_x;
-    Sint32 goal_loc_y;
-    Uint16 target_id;
-public:
-    Uint8 manual_move_orientation;
-private:
-    Sint32 target_loc_x;
-    Sint32 target_loc_y;
-public:
-    UMesgAICommand()
-    {
-        command = 0;
-        goal_loc_x = goal_loc_y = 0;
-        target_id = 0;
-        manual_move_orientation = 0;
-        target_loc_x = target_loc_y = 0;
-    }
-
-    UMesgAICommand(UnitID unit_id, unsigned char flags)
-            : UnitMessage(unit_id, flags )
-    {
-        command = 0;
-        goal_loc_x = goal_loc_y = 0;
-        target_id = 0;
-        manual_move_orientation = 0;
-        target_loc_x = target_loc_y = 0;
-    }
-
-    void setMoveToLoc(const iXY&amp; goal)
-    {
-        message_id = _umesg_ai_command;
-        command = _command_move_to_loc;
-        goal_loc_x = htol32(goal.x);
-        goal_loc_y = htol32(goal.y);
-        manual_move_orientation = 0;
-    }
-
-    void setTargetUnit(UnitID target)
-    {
-        message_id = _umesg_ai_command;
-        command = _command_attack_unit;
-        target_id = htol16(target);
-        manual_move_orientation = 0;
-    }
-
-    void setStartManualMove(unsigned char orientation)
-    {
-        message_id = _umesg_ai_command;
-        command = _command_start_manual_move;
-        manual_move_orientation = orientation;
-    }
-
-    void setStopManualMove()
-    {
-        message_id = _umesg_ai_command;
-        command = _command_stop_manual_move;
-        manual_move_orientation = 0;
-    }
-
-    void setManualFire(const iXY&amp; target)
-    {
-        message_id = _umesg_ai_command;
-        command = _command_manual_fire;
-        target_loc_x = htol32(target.x);
-        target_loc_y = htol32(target.y);
-        manual_move_orientation = 0;
-    }
-
-    iXY getGoalLoc() const
-    {
-        return iXY(ltoh32(goal_loc_x), ltoh32(goal_loc_y));
-    }
-
-    UnitID getTargetUnitID() const
-    {
-        return ltoh16(target_id);
-    }
-
-    iXY getTargetLoc() const
-    {
-        return iXY(ltoh32(target_loc_x), ltoh32(target_loc_y));
-    }
-}
-__attribute__((packed));
-
-class UMesgEndLifeCycleUpdate : public UnitMessage
-{
-private:
-    Uint16 destroyed;
-    Uint16 destroyer;
-
-public:
-    Uint8 unit_type;
-
-    void set(UnitID destroyed_unit, UnitID destroyer_unit,
-            unsigned char unit_type )
-    {
-        message_id = _umesg_end_lifecycle;
-        message_flags = _umesg_flag_manager_request;
-        destroyed = htol16(destroyed_unit);
-        destroyer = htol16(destroyer_unit);
-        this-&gt;unit_type = unit_type;
-    }
-
-    UnitID getDestroyed() const
-    {
-        return ltoh16(destroyed);
-    }
-
-    UnitID getDestroyer() const
-    {
-        return ltoh16(destroyer);
-    }
-}
-__attribute__((packed));
-
-class UMesgSelfDestruct : public UnitMessage
-{
-public:
-    UMesgSelfDestruct()
-    {
-        message_id = _umesg_self_destruct;
-    }
-}
-__attribute__((packed));
-
-#ifdef MSVC
-#pragma()
-#endif
-
-#endif

Modified: trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -37,8 +37,6 @@
 #include &quot;Objectives/ObjectiveInterface.hpp&quot;
 #include &quot;Objectives/Objective.hpp&quot;
 
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
-#include &quot;Classes/Network/TerminalNetMesg.hpp&quot;
 #include &quot;Classes/Network/PlayerNetMessage.hpp&quot;
 #include &quot;Classes/Network/NetworkClient.hpp&quot;
 #include &quot;Classes/Network/NetMessageEncoder.hpp&quot;
@@ -63,6 +61,13 @@
 #include &quot;Views/Game/ChatView.hpp&quot;
 #include &quot;Actions/ActionManager.hpp&quot;
 
+#include &quot;Network/PlayerRequests/AttackUnitRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ManualFireRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/MoveUnitRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeObjectiveOutLocationRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/AllianceRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/BreakAllianceRequest.hpp&quot;
+
 WorldInputCmdProcessor COMMAND_PROCESSOR;
 
 enum { _cursor_regular,
@@ -223,16 +228,16 @@
     if ( UnitInterface::queryUnitAtMapLoc(map_loc, &amp;unit_id) )
     {
         UnitBase * unit = UnitInterface::getUnit(unit_id);
-        if ( unit-&gt;player-&gt;getID() == PlayerInterface::getLocalPlayerIndex() )
+        if ( unit-&gt;player_id == PlayerInterface::getLocalPlayerIndex() )
         {
             return _cursor_player_unit;
         }
         // XXX ALLY
-        if ( ! PlayerInterface::isAllied(unit-&gt;player-&gt;getID(), PlayerInterface::getLocalPlayerIndex() ) )
+        if ( ! PlayerInterface::isAllied(unit-&gt;player_id, PlayerInterface::getLocalPlayerIndex() ) )
         {
             if ( KeyboardInterface::getKeyState(SDLK_a) &amp;&amp; !GameConfig::game_teammode )
             {
-                if ( PlayerInterface::isSingleAllied(PlayerInterface::getLocalPlayerIndex(), unit-&gt;player-&gt;getID() ) )
+                if ( PlayerInterface::isSingleAllied(PlayerInterface::getLocalPlayerIndex(), unit-&gt;player_id ) )
                 {
                     return _cursor_break_allie;
                 }
@@ -352,8 +357,7 @@
 
     if ( KeyboardInterface::getKeyPressed(SDLK_v) )
     {
-        if (!Desktop::getVisible(&quot;PrepareTeam&quot;) &amp;&amp; !Desktop::getVisible(&quot;GFlagSelectionView&quot;))
-            VoteManager::playerSendRequestVote(surrender_vote);
+        ActionManager::runAction(&quot;startvote_surrender&quot;);
     }
 
     if ( KeyboardInterface::getKeyPressed(SDLK_n) )
@@ -469,7 +473,7 @@
             i != units.end(); ++i)
     {
         UnitBase* unit = i-&gt;second;
-        if(unit-&gt;player != PlayerInterface::getLocalPlayer())
+        if(unit-&gt;player_id != PlayerInterface::getLocalPlayerIndex())
             continue;
 
         if (unit-&gt;unit_state.threat_level == _threat_level_under_attack)
@@ -695,9 +699,10 @@
         }
         else
         {
-            ObjectiveInterface::sendChangeOutputLocation(outpost_goal_selection,
-                                                         MapInterface::pointXtoMapX(world_pos.x),
-                                                         MapInterface::pointYtoMapY(world_pos.y));
+            ChangeObjectiveOutLocationRequest msg;
+            msg.setObjectiveId(outpost_goal_selection);
+            msg.setMapPos(iXY(MapInterface::pointXtoMapX(world_pos.x), MapInterface::pointYtoMapY(world_pos.y)));
+            CLIENT-&gt;sendMessage(&amp;msg, sizeof(msg));
         }
         outpost_goal_selection = OBJECTIVE_NONE;
         return;
@@ -809,8 +814,8 @@
     size_t id_list_size;
     UnitBase *unit_ptr;
 
-    TerminalUnitCmdRequest msg;
-
+    MoveUnitRequest req;
+    
     id_list_size = working_list.unit_list.size();
 
     if ( id_list_size == 0 )
@@ -830,17 +835,16 @@
             if ( unit_ptr-&gt;unit_state.select == true )
             {
                 matrix.getNextEmptyLoc( &amp;map_pos );
-                msg.comm_request.setHeader( unit_ptr-&gt;id,
-                                            _umesg_flag_unique );
-
-                msg.comm_request.setMoveToLoc( map_pos );
-
-                if ( !encoder.encodeMessage(&amp;msg, sizeof(msg)) )
+                
+                req.setUnitId(unit_ptr-&gt;id);
+                req.setMapPos(map_pos);
+                
+                if ( !encoder.encodeMessage(&amp;req, sizeof(req)) )
                 {
                     CLIENT-&gt;sendMessage(encoder.getEncodedMessage(),
                                         encoder.getEncodedLen());
                     encoder.resetEncoder();
-                    encoder.encodeMessage(&amp;msg, sizeof(msg));
+                    encoder.encodeMessage(&amp;req, sizeof(req));
                 }
             }
         }
@@ -860,7 +864,7 @@
 void
 WorldInputCmdProcessor::sendAttackCommand(const iXY &amp;world_pos)
 {
-    TerminalUnitCmdRequest msg;
+    AttackUnitRequest req;
 
     UnitBase *target_ptr;
 
@@ -887,16 +891,15 @@
             {
                 if ( unit_ptr-&gt;unit_state.select == true )
                 {
-                    msg.comm_request.setHeader(unit_ptr-&gt;id,
-                            _umesg_flag_unique);
-                    msg.comm_request.setTargetUnit(target_ptr-&gt;id);
+                    req.setUnitId(unit_ptr-&gt;id);
+                    req.setEnemyId(target_ptr-&gt;id);
 
-                    if ( !encoder.encodeMessage(&amp;msg, sizeof(msg)) )
+                    if ( !encoder.encodeMessage(&amp;req, sizeof(req)) )
                     {
                         CLIENT-&gt;sendMessage(encoder.getEncodedMessage(),
                                             encoder.getEncodedLen());
                         encoder.resetEncoder();
-                        encoder.encodeMessage(&amp;msg, sizeof(msg));
+                        encoder.encodeMessage(&amp;req, sizeof(req));
                     }
                 }
             }
@@ -914,56 +917,6 @@
 }
 
 void
-WorldInputCmdProcessor::sendManualMoveCommand(unsigned char orientation,
-        bool start_stop)
-{
-    TerminalUnitCmdRequest msg;
-    size_t id_list_index;
-    size_t id_list_size;
-    UnitBase *unit_ptr;
-
-    if ( working_list.unit_list.size() &gt; 0 ) {
-        id_list_size = working_list.unit_list.size();
-
-        NetMessageEncoder encoder;
-
-        for( id_list_index = 0; id_list_index &lt; id_list_size; id_list_index++ )
-        {
-            unit_ptr = UnitInterface::getUnit( working_list.unit_list[ id_list_index ] );
-            if ( unit_ptr != 0 ) {
-                if ( unit_ptr-&gt;unit_state.select == true )
-                {
-                    msg.comm_request.setHeader(unit_ptr-&gt;id,
-                            _umesg_flag_unique);
-                    if ( start_stop == true )
-                    {
-                        msg.comm_request.setStartManualMove( orientation );
-                    }
-                    else
-                    {
-                        msg.comm_request.setStopManualMove();
-                    }
-
-                    if ( !encoder.encodeMessage(&amp;msg, sizeof(msg)) )
-                    {
-                        CLIENT-&gt;sendMessage(encoder.getEncodedMessage(),
-                                            encoder.getEncodedLen());
-                        encoder.resetEncoder();
-                        encoder.encodeMessage(&amp;msg, sizeof(msg));
-                    }
-                }
-            }
-        }
-
-        if ( ! encoder.isEmpty() )
-        {
-            CLIENT-&gt;sendMessage(encoder.getEncodedMessage(),
-                                encoder.getEncodedLen());
-        }
-    }
-}
-
-void
 WorldInputCmdProcessor::sendManualFireCommand(const iXY &amp;world_pos)
 {
     if ( !actionTimer.isTimeOut() )
@@ -973,7 +926,7 @@
 
     actionTimer.reset();
 
-    TerminalUnitCmdRequest msg;
+    ManualFireRequest req;
 
     size_t id_list_index;
     size_t id_list_size;
@@ -989,16 +942,15 @@
 
             if ( unit_ptr != 0 ) {
                 if ( unit_ptr-&gt;unit_state.select == true ) {
-                    msg.comm_request.setHeader(unit_ptr-&gt;id,
-                            _umesg_flag_unique);
-                    msg.comm_request.setManualFire(world_pos);
+                    req.setUnitId(unit_ptr-&gt;id);
+                    req.setMapPos(world_pos);
 
-                    if ( !encoder.encodeMessage(&amp;msg, sizeof(msg)) )
+                    if ( !encoder.encodeMessage(&amp;req, sizeof(req)) )
                     {
                         CLIENT-&gt;sendMessage(encoder.getEncodedMessage(),
                                             encoder.getEncodedLen());
                         encoder.resetEncoder();
-                        encoder.encodeMessage(&amp;msg, sizeof(msg));
+                        encoder.encodeMessage(&amp;req, sizeof(req));
                     }
                 }
             }
@@ -1022,22 +974,22 @@
 
     target_list.selectTarget(world_pos);
 
-    if ( target_list.isSelected() == true ) {
+    if ( target_list.isSelected() == true )
+    {
         target_ptr = UnitInterface::getUnit( target_list.unit_list[0] );
 
-        Uint8 type;
-        if ( make_break ) {
-            type = _player_make_alliance;
-        } else {
-            type = _player_break_alliance;
+        if ( make_break )
+        {
+            AllianceRequest req;
+            req.with_player_id = target_ptr-&gt;player_id;
+            CLIENT-&gt;sendMessage( &amp;req, sizeof(req));
         }
-
-        // XXX ALLY
-        PlayerAllianceRequest allie_request;
-        allie_request.set(PlayerInterface::getLocalPlayerIndex(),
-                target_ptr-&gt;player-&gt;getID(), type);
-
-        CLIENT-&gt;sendMessage( &amp;allie_request, sizeof(PlayerAllianceRequest));
+        else
+        {
+            BreakAllianceRequest req;
+            req.with_player_id = target_ptr-&gt;player_id;
+            CLIENT-&gt;sendMessage( &amp;req, sizeof(req));
+        }
     }
 }
 

Modified: trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -64,8 +64,6 @@
 
     void getManualControlStatus();
 
-    void sendManualMoveCommand(unsigned char orientation,
-                                bool start_stop);
     void sendManualFireCommand(const iXY &amp;world_pos);
     void sendMoveCommand(const iXY &amp;world_pos);
     void sendAttackCommand(const iXY &amp;world_pos);

Modified: trunk/netpanzer/src/NetPanzer/Core/CoreTypes.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Core/CoreTypes.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Core/CoreTypes.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -40,11 +40,18 @@
 #define OBJECTIVE_NONE 0xffff
 
 typedef Uint16 UnitID;
+#define UnitID_toPortable(a) htol16(a)
+#define UnitID_fromPortable(a) ltoh16(a)
 
 typedef Uint8 FlagID;
 #define FLAG_WIDTH 20
 #define FLAG_HEIGHT 14
 
+typedef Uint8 TeamID;
+#define MIN_TEAM_ID (0)
+#define MAX_TEAM_ID (0xfe)
+#define INVALID_TEAM_ID (0xff)
+
 #ifndef __TEST_PLAYERID__
     typedef Uint8 PlayerID;
     #define MIN_PLAYER_ID (0)

Modified: trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -19,7 +19,7 @@
 #define __NETWORK_GLOBALS_HPP__
 
 #define NETPANZER_DEFAULT_PORT_TCP     3030
-#define NETPANZER_PROTOCOL_VERSION     1107
+#define NETPANZER_PROTOCOL_VERSION     1108
 #define MASTERSERVER_PORT             28900
 
 const char * getNetpanzerProtocolMessage(const int protocol);

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -31,335 +31,266 @@
 
 #include &quot;Scripts/ScriptManager.hpp&quot;
 
-enum { _net_message_id_chat_mesg_req,
-       _net_message_id_chat_mesg
-     };
+#include &quot;Network/PlayerRequests/ChatRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/TeamChatRequest.hpp&quot;
 
-enum { _chat_mesg_scope_player_set,
-       _chat_mesg_scope_alliance,
-       _chat_mesg_scope_enemies,
+enum { _net_message_id_chat_mesg };
+
+enum { _chat_mesg_scope_alliance,
        _chat_mesg_scope_all,
        _chat_mesg_scope_server
      };
+     
+enum {
+    message_type_server,
+    message_type_all,
+    message_type_alliance
+};
 
-#define CHATREQUEST_HEADER_LEN (sizeof(NetMessage) + sizeof(Uint8))
-#define CHATMESG_HEADER_LEN (sizeof(NetMessage) + sizeof(Uint8) + sizeof(PlayerID))
-#define MAX_CHAT_MSG_LEN (_MAX_NET_PACKET_SIZE - CHATMESG_HEADER_LEN)
-
-class ChatMesgRequest : public NetMessage
+class ServerChatMessage : public ChatRequest
 {
 public:
-    Uint8 message_scope;
-    char message_text[MAX_CHAT_MSG_LEN];
-
-    ChatMesgRequest()
+    ServerChatMessage()
     {
-        reset();
-    }
-
-    void reset()
-    {
         message_class = _net_message_class_chat;
-        message_id = _net_message_id_chat_mesg_req;
-        message_scope = _chat_mesg_scope_all;
+        message_id = message_type_server;
     }
-
-    int getTextLen(size_t size) const
-    {
-        return size - CHATREQUEST_HEADER_LEN;
-    }
-
+    
 } __attribute__((packed));
-
-
-class ChatMesg: public NetMessage
+     
+class AllChatMessage : public NetMessage
 {
 public:
-    Uint8  message_scope;
-private:
-    PlayerID source_player_index;
-public:
-    char message_text[MAX_CHAT_MSG_LEN];
+    enum { MAX_CHAT_LENGTH = _MAX_NET_PACKET_SIZE - 16 };
+    enum { CHATMESG_HEADSIZE = sizeof(NetMessage) + sizeof(PlayerID) };
+    
+    PlayerID player_id;
+    char message_text[MAX_CHAT_LENGTH];
 
-    ChatMesg()
+    AllChatMessage()
     {
         message_class = _net_message_class_chat;
-        message_id = _net_message_id_chat_mesg;
-        memset(message_text, 0, sizeof(message_text));
+        message_id = message_type_all;
     }
-
-    int getTextLen(size_t size) const
+    
+    unsigned int setText(const NPString&amp; text)
     {
-        return size - CHATMESG_HEADER_LEN;
+        unsigned int text_len = std::min(text.size(), (unsigned int)MAX_CHAT_LENGTH);
+        text.copy(message_text, text_len);
+        
+        return text_len + CHATMESG_HEADSIZE;
     }
-
-    PlayerID getSourcePlayerIndex() const
+    
+    void getText(int packet_length, NPString&amp; text) const
     {
-        return source_player_index;
+        unsigned int text_len = packet_length - CHATMESG_HEADSIZE;
+        text.assign(message_text, text_len);
     }
 
-    void setSourcePlayerIndex(PlayerID playerIndex)
-    {
-        source_player_index = playerIndex;
-    }
 } __attribute__((packed));
 
-static void chatMessageRequest(const NetPacket* packet)
+class AllianceChatMessage : public AllChatMessage
 {
-    const ChatMesgRequest* chat_request = (const ChatMesgRequest*) packet-&gt;getNetMessage();
-
-    if (   chat_request-&gt;message_scope == _chat_mesg_scope_server
-            &amp;&amp; NetworkState::getNetworkStatus() == _network_state_server
-            &amp;&amp; packet-&gt;fromClient )
+public:
+    AllianceChatMessage()
     {
-        LOGGER.warning(&quot;CI_CMR CHEAT Player %u tried to chat as server&quot;, packet-&gt;fromPlayer);
-        return;
+        message_id = message_type_alliance;
     }
+};
 
-    int text_len = chat_request-&gt;getTextLen(packet-&gt;size);
-    NPString text(chat_request-&gt;message_text, 0, text_len);
+void ChatInterface::clientHandleChatMessage(const NetMessage* message, size_t size)
+{
+    NPString text;
     
-    ScriptManager::prepareFunction(&quot;Filters.chatFilter&quot;);
-    ScriptManager::pushParameterInt(packet-&gt;fromPlayer);
-    ScriptManager::pushParameterString(text);
-    if ( ScriptManager::callFunction(1) )
+    if ( message-&gt;message_id == message_type_server )
     {
-        if ( ScriptManager::isNullResult(-1) || ! ScriptManager::getStringResult(-1, text) )
-        {
-            LOGGER.warning(&quot;Message from [%d] filtered&quot;, packet-&gt;fromPlayer);
-            ScriptManager::endFunction();
-            return;
-            // should return here and ignore, finishing the function
-        }
-    } else { // if function doesn't exits, then ignore
-        NPString s;
-        ScriptManager::getStringResult(-1, s);
-        LOGGER.warning(&quot;Error in chatFilter: '%s'&quot;, s.c_str());
+        ((ServerChatMessage*)message)-&gt;getText(size, text);
+        ConsoleInterface::postMessage(Color::unitAqua, false, 0, &quot;Server: %s&quot;, text.c_str());
+        return;
     }
     
-    ScriptManager::endFunction();
-    
-    text_len = text.length();
-    
-    bool post_on_server = false;
-    ChatMesg chat_mesg;
-
-    chat_mesg.setSourcePlayerIndex(packet-&gt;fromPlayer);
-    chat_mesg.message_scope = chat_request-&gt;message_scope;
-    text.copy(chat_mesg.message_text, text_len);
-
-    if ( chat_request-&gt;message_scope == _chat_mesg_scope_all )
+    PlayerID from_player = ((AllChatMessage*)message)-&gt;player_id;
+    if ( !PlayerInterface::isValidPlayerID(from_player) )
     {
-        if ( text[0] != '/' || ! ScriptManager::runServerCommand(text.substr(1), packet-&gt;fromPlayer) )
-        {
-            SERVER-&gt;broadcastMessage(&amp;chat_mesg, CHATMESG_HEADER_LEN + text_len);
-            post_on_server = true;
-        }
-    }
-    // XXX ALLY
-    else if (chat_request-&gt;message_scope == _chat_mesg_scope_alliance)
-    {
-        PlayerID max_players;
-        PlayerID local_player_index;
-
-        local_player_index = PlayerInterface::getLocalPlayerIndex();
-
-        max_players = PlayerInterface::getMaxPlayers();
-        for (PlayerID i = 0; i &lt; max_players; ++i)
-        {
-            if ( PlayerInterface::isAllied( packet-&gt;fromPlayer, i) == true )
-            {
-                if (local_player_index != i)
-                {
-                    SERVER-&gt;sendMessage(i, &amp;chat_mesg, CHATMESG_HEADER_LEN + text_len);
-                }
-                else
-                {
-                    post_on_server = true;
-                }
-            }
-        }
-
-        if ( packet-&gt;fromPlayer == PlayerInterface::getLocalPlayerIndex() )
-        {
-            post_on_server = true;
-        }
-        else
-        {
-            SERVER-&gt;sendMessage(packet-&gt;fromPlayer,
-                                &amp;chat_mesg, CHATMESG_HEADER_LEN + text_len);
-        }
-    }
-    else if ( chat_request-&gt;message_scope == _chat_mesg_scope_server )
-    {
-        SERVER-&gt;broadcastMessage(&amp;chat_mesg, CHATMESG_HEADER_LEN + text_len);
-        ConsoleInterface::postMessage(Color::unitAqua, false, 0, &quot;Server: %s&quot;, text.c_str());
+        LOGGER.warning(&quot;Received chat message contains incorrect player value: %u&quot;, from_player);
         return;
     }
+    
+    ((AllChatMessage*)message)-&gt;getText(size, text);
 
-    if ( post_on_server == true )
-    {
-        PlayerState *player_state;
+    PlayerState *player_state;
+    player_state = PlayerInterface::getPlayer(from_player);
 
-        player_state = PlayerInterface::getPlayer(packet-&gt;fromPlayer);
+    PIX color = (message-&gt;message_id == message_type_all) ? Color::white : Color::yellow;
 
-        PIX color = Color::white;
+    LOGGER.debug(&quot;C: %s: %s&quot;, player_state-&gt;getName().c_str(), text.c_str());
 
-        switch (chat_request-&gt;message_scope)
-        {
-        case _chat_mesg_scope_all:
-            color = Color::white;
-            break;
+    ChatView *v = (ChatView*) Desktop::getView(&quot;ChatView&quot;);
+    if (v)
+        v-&gt;postMessage(color, true, player_state-&gt;getFlag(),
+                       &quot;%s: %s&quot;, player_state-&gt;getName().c_str(), text.c_str());
+}
 
-        case _chat_mesg_scope_alliance:
-            color = Color::yellow;
-            break;
+void ChatInterface::say(const NPString&amp; message)
+{
+    ChatRequest req;
+    int to_send = req.setText(message);
+    
+    CLIENT-&gt;sendMessage(&amp;req, to_send);
+}
 
-        } // ** switch
+void ChatInterface::teamsay(const NPString&amp; message)
+{
+    TeamChatRequest req;
+    int to_send = req.setText(message);
+    
+    CLIENT-&gt;sendMessage(&amp;req, to_send);
+}
 
+void ChatInterface::serversay(const NPString&amp; message)
+{
+    if ( NetworkState::status == _network_state_server )
+    {
+        ServerChatMessage msg;
+        int to_send = msg.setText(message);
         
-        LOGGER.debug(&quot;C: %s: %s&quot;, player_state-&gt;getName().c_str(), text.c_str());
-        
-        ChatView *v = (ChatView*) Desktop::getView(&quot;ChatView&quot;);
-        if (v)
-            v-&gt;postMessage(color, true, player_state-&gt;getFlag(),
-                           &quot;%s: %s&quot;, player_state-&gt;getName().c_str(), text.c_str());
+        SERVER-&gt;broadcastMessage(&amp;msg, to_send);
+        ConsoleInterface::postMessage(Color::unitAqua, false, 0, &quot;Server: %s&quot;, message.c_str());
     }
 }
 
-void ChatInterface::clientHandleChatMessage(const NetMessage* message, size_t size)
+void ChatInterface::serversayTo(const PlayerID player, const NPString&amp; message)
 {
-    if ( message-&gt;message_id != _net_message_id_chat_mesg )
+    if ( ! PlayerInterface::isValidPlayerID(player) )
     {
-        LOGGER.warning(&quot;CI_CHCM Received wrong message type: %u&quot;,
-                       message-&gt;message_id);
-        return;
+        LOGGER.warning(&quot;serversayTo invalid player: %u&quot;, player);
     }
 
-    const ChatMesg *chat_mesg = (const ChatMesg*) message;
-
-    if ( chat_mesg-&gt;message_scope != _chat_mesg_scope_server
-            &amp;&amp; chat_mesg-&gt;getSourcePlayerIndex() &gt;= PlayerInterface::getMaxPlayers())
+    if ( ! PlayerInterface::isPlayerActive(player) )
     {
-        LOGGER.warning(&quot;CI_CHCM Received message, incorrect player value: %u, max is %u.&quot;,
-                       chat_mesg-&gt;getSourcePlayerIndex(),
-                       PlayerInterface::getMaxPlayers());
-        return;
+        LOGGER.warning(&quot;serversayTo inactive player: %u&quot;, player);
     }
 
-    int text_len = chat_mesg-&gt;getTextLen(size);
-    const NPString text(chat_mesg-&gt;message_text, text_len);
-
-    if ( chat_mesg-&gt;message_scope == _chat_mesg_scope_server )
+    if ( PlayerInterface::isLocalPlayer(player) )
     {
         ConsoleInterface::postMessage(Color::unitAqua, false, 0, _(&quot;Server: %s&quot;),
-                                      text.c_str());
-        return;
+                                      message.c_str());
     }
-
-    PlayerState *player_state;
-    player_state = PlayerInterface::getPlayer(chat_mesg-&gt;getSourcePlayerIndex());
-
-    PIX color = Color::white;
-
-    switch (chat_mesg-&gt;message_scope)
+    else
     {
-    case _chat_mesg_scope_all:
-        color = Color::white;
-        break;
-
-    case _chat_mesg_scope_alliance:
-        color = Color::yellow;
-        break;
-
-    } // ** switch
-
-//    ConsoleInterface::postMessage(color, true, player_state-&gt;getFlag(), &quot;%s: %s&quot;,
-//                                  player_state-&gt;getName().c_str(), text.c_str());
-    ChatView *v = (ChatView*) Desktop::getView(&quot;ChatView&quot;);
-    if (v)
-        v-&gt;postMessage(color, true, player_state-&gt;getFlag(),
-                       &quot;%s: %s&quot;, player_state-&gt;getName().c_str(), text.c_str());
-}
-
-void ChatInterface::processChatMessages(const NetPacket* packet)
-{
-    switch (packet-&gt;getNetMessage()-&gt;message_id)
-    {
-    case _net_message_id_chat_mesg_req:
-        chatMessageRequest(packet);
-        break;
-
-    default:
-        LOGGER.warning(&quot;CI_PCM Received unknown chat message (id %d-%d)&quot;,
-                       packet-&gt;getNetMessage()-&gt;message_class,
-                       packet-&gt;getNetMessage()-&gt;message_id);
+        ServerChatMessage msg;
+        int to_send = msg.setText(message);
+        
+        SERVER-&gt;sendMessage(player, &amp;msg, to_send);
     }
 }
 
-static void sendScopedMessage(const NPString&amp; message, Uint8 scope)
+static bool filterPlayerChat(const PlayerID player_id, const NPString&amp; text, NPString&amp; out)
 {
-    unsigned int text_len = std::min(message.length(), MAX_CHAT_MSG_LEN);
-    ChatMesgRequest cmsg;
-
-    message.copy(cmsg.message_text, text_len);
-    cmsg.message_scope = scope;
-
-    if (NetworkState::status == _network_state_client)
+    ScriptManager::prepareFunction(&quot;Filters.chatFilter&quot;);
+    ScriptManager::pushParameterInt(player_id);
+    ScriptManager::pushParameterString(text);
+    if ( ScriptManager::callFunction(1) )
     {
-        CLIENT-&gt;sendMessage(&amp;cmsg, CHATREQUEST_HEADER_LEN + text_len);
+        if ( ScriptManager::isNullResult(-1) || ! ScriptManager::getStringResult(-1, out) )
+        {
+            out.clear();
+        }
     }
     else
     {
-        EnqueueIncomingPacket(&amp;cmsg, CHATREQUEST_HEADER_LEN + text_len,
-                              PlayerInterface::getLocalPlayerIndex(), 0);
+        NPString s;
+        ScriptManager::getStringResult(-1, s);
+        LOGGER.warning(&quot;Error in chatFilter: '%s'&quot;, s.c_str());
+        out.assign(text);
     }
+    
+    ScriptManager::endFunction();
+    
+    return out.size() == 0;
 }
 
-void ChatInterface::say(const NPString&amp; message)
+void ChatInterface::playerRequest_chat(const PlayerID player_id, const NPString&amp; message)
 {
-    sendScopedMessage(message, _chat_mesg_scope_all);
-}
+    NPString text;
+    
+    if ( filterPlayerChat(player_id, message, text) )
+    {
+        LOGGER.warning(&quot;Message from [%d] filtered&quot;, player_id);
+        return;
+    }
 
-void ChatInterface::teamsay(const NPString&amp; message)
-{
-    sendScopedMessage(message, _chat_mesg_scope_alliance);
-}
+    if ( text[0] != '/' || ! ScriptManager::runServerCommand(text.substr(1), player_id) )
+    {
+        AllChatMessage msg;
+        msg.player_id = player_id;
+        int to_send = msg.setText(text);
+        
+        SERVER-&gt;broadcastMessage(&amp;msg, to_send);
+        
+        PlayerState *player_state = PlayerInterface::getPlayer(player_id);
+        LOGGER.debug(&quot;C: %s: %s&quot;, player_state-&gt;getName().c_str(), text.c_str());
 
-void ChatInterface::serversay(const NPString&amp; message)
-{
-    sendScopedMessage(message, _chat_mesg_scope_server);
+        ChatView *v = (ChatView*) Desktop::getView(&quot;ChatView&quot;);
+        if ( v )
+        {
+            v-&gt;postMessage(Color::white, true, player_state-&gt;getFlag(),
+                           &quot;%s: %s&quot;, player_state-&gt;getName().c_str(), text.c_str());
+        }
+
+    }    
 }
 
-void ChatInterface::serversayTo(const PlayerID player, const NPString&amp; message)
+void ChatInterface::playerRequest_teamChat(const PlayerID player_id, const NPString&amp; message)
 {
-    if ( ! PlayerInterface::isValidPlayerID(player) )
-    {
-        LOGGER.warning(&quot;CI_SST CHEAT Try to say something to unexisting player: %u&quot;,
-                       player);
-    }
+    AllianceChatMessage msg;
+    msg.player_id = player_id;
+    int to_send = msg.setText(message);
+    
+    PlayerID max_players = PlayerInterface::getMaxPlayers();
+    PlayerID local_player_index = PlayerInterface::getLocalPlayerIndex();
+    
+    bool post_on_server = false;
 
-    if ( ! PlayerInterface::isPlayerActive(player) )
+    for (PlayerID i = 0; i &lt; max_players; ++i)
     {
-        LOGGER.warning(&quot;CI_SST CHEAT Try to say something to inactive player: %u&quot;,
-                       player);
+        if ( PlayerInterface::isAllied( player_id, i) == true )
+        {
+            if ( local_player_index != i )
+            {
+                SERVER-&gt;sendMessage(i, &amp;msg, to_send);
+            }
+            else
+            {
+                // one of the allied players is me, non dedicated server
+                post_on_server = true;
+            }
+        }
     }
 
-    if ( PlayerInterface::isLocalPlayer(player) )
+    if ( player_id == local_player_index )
     {
-        ConsoleInterface::postMessage(Color::unitAqua, false, 0, _(&quot;Server: %s&quot;),
-                                      message.c_str());
+        // non dedicated server sent the msg
+        post_on_server = true;
     }
     else
     {
-        unsigned int text_len = std::min(message.length(), MAX_CHAT_MSG_LEN);
-        ChatMesg cmsg;
+        SERVER-&gt;sendMessage(player_id, &amp;msg, to_send);
+    }
+    
+    if ( post_on_server == true )
+    {
+        PlayerState *player_state;
 
-        message.copy(cmsg.message_text, text_len);
-        cmsg.setSourcePlayerIndex(PlayerInterface::getLocalPlayerIndex());
-        cmsg.message_scope = _chat_mesg_scope_server;
+        player_state = PlayerInterface::getPlayer(player_id);
 
-        SERVER-&gt;sendMessage(player, &amp;cmsg, CHATMESG_HEADER_LEN + text_len);
+        LOGGER.debug(&quot;C: %s: %s&quot;, player_state-&gt;getName().c_str(), message.c_str());
+        
+        ChatView *v = (ChatView*) Desktop::getView(&quot;ChatView&quot;);
+        if (v)
+            v-&gt;postMessage(Color::yellow, true, player_state-&gt;getFlag(),
+                           &quot;%s: %s&quot;, player_state-&gt;getName().c_str(), message.c_str());
     }
+    
 }
 

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/ChatInterface.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -26,13 +26,15 @@
 class ChatInterface
 {
 public:
-    static void processChatMessages(const NetPacket* packet);
     static void clientHandleChatMessage(const NetMessage* message, size_t size);
 
     static void say(const NPString&amp; message);
     static void teamsay(const NPString&amp; message);
     static void serversay(const NPString&amp; message);
     static void serversayTo(const PlayerID player, const NPString&amp; message);
+    
+    static void playerRequest_chat(const PlayerID player_id, const NPString&amp; message);
+    static void playerRequest_teamChat(const PlayerID player_id, const NPString&amp; message);
 };
 
 #endif // ** _CHATINTERFACE_HPP

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -36,7 +36,34 @@
 #include &quot;Classes/Network/NetworkServer.hpp&quot;
 #include &quot;Util/Log.hpp&quot;
 #include &quot;Classes/Network/NetworkState.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeFlagRequest.hpp&quot;
 
+class AllianceCreatedUpdate : public NetMessage
+{
+public:
+    PlayerID by_player;
+    PlayerID with_player;
+    
+    AllianceCreatedUpdate()
+    {
+        message_class = _net_message_class_player;
+        message_id = _net_message_id_alliance_created_update;
+    }
+} __attribute__((packed));
+
+class AllianceBrokenUpdate : public NetMessage
+{
+public:
+    PlayerID by_player;
+    PlayerID with_player;
+    
+    AllianceBrokenUpdate()
+    {
+        message_class = _net_message_class_player;
+        message_id = _net_message_id_alliance_broken_update;
+    }
+} __attribute__((packed));
+
 // ** PlayerInterface Statics
 PlayerState   * PlayerInterface::player_lists = 0;
 PlayerID        PlayerInterface::max_players = MIN_PLAYER_ID;
@@ -88,90 +115,6 @@
     return false;
 }
 
-static void handleAllianceMessage(const int type,
-                                  PlayerID by_player,
-                                  PlayerID with_player)
-{
-    PlayerID local_player = PlayerInterface::getLocalPlayerIndex();
-    PlayerState *player_state;
-    if ( type == _player_make_alliance )
-    {
-        setAlliance(by_player, with_player);
-
-        if ( by_player == local_player )
-        {
-            player_state = PlayerInterface::getPlayer(with_player);
-            if ( PlayerInterface::isSingleAllied(player_state-&gt;getID(), local_player) )
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;You accepted %s alliance request.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-            else
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;You request alliance with %s.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-        }
-        else if ( with_player == local_player )
-        {
-            player_state = PlayerInterface::getPlayer(by_player);
-            if ( PlayerInterface::isSingleAllied( local_player, player_state-&gt;getID()) )
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;%s accepted your alliance request.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-            else
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;%s request to ally with you.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-        }
-    }
-    else
-    {
-        // break alliance cancels both alliances
-        clearAlliance(by_player, with_player);
-        if ( by_player == local_player )
-        {
-            player_state = PlayerInterface::getPlayer(with_player);
-            if ( PlayerInterface::isSingleAllied(player_state-&gt;getID(), local_player) )
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;You broke the alliance with %s.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-            else
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;You cancel your alliance request with %s.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-        }
-        else if ( with_player == local_player )
-        {
-            player_state = PlayerInterface::getPlayer(by_player);
-            if ( PlayerInterface::isSingleAllied( local_player, player_state-&gt;getID()) )
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;%s broke the alliance with you.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-            else
-            {
-                ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                              _(&quot;%s cancelled the alliance request with you.&quot;),
-                                              player_state-&gt;getName().c_str());
-            }
-        }
-
-        clearAlliance(with_player, by_player);
-    }
-}
-
 static void resetAllianceMatrix()
 {
     int matrix_size;
@@ -544,65 +487,6 @@
     setKill(player1, player2, (UnitType) score_update-&gt;unit_type );
 }
 
-void PlayerInterface::netMessageAllianceRequest(const NetMessage *message)
-{
-    if ( GameConfig::game_allowallies == false )
-    {
-        return;
-    }
-
-    const PlayerAllianceRequest *allie_request
-    = (const PlayerAllianceRequest *) message;
-
-    if(allie_request-&gt;getAllieByPlayerIndex() &gt;= max_players
-            || allie_request-&gt;getAllieWithPlayerIndex() &gt;= max_players)
-    {
-        LOGGER.warning(&quot;Invalid alliance request message&quot;);
-        return;
-    }
-
-    SDL_mutexP(mutex);
-    handleAllianceMessage(allie_request-&gt;alliance_request_type,
-                          allie_request-&gt;getAllieByPlayerIndex(),
-                          allie_request-&gt;getAllieWithPlayerIndex());
-    SDL_mutexV(mutex);
-
-    PlayerAllianceUpdate allie_update;
-    allie_update.set(allie_request-&gt;getAllieByPlayerIndex(),
-                     allie_request-&gt;getAllieWithPlayerIndex(),
-                     allie_request-&gt;alliance_request_type);
-//    SERVER-&gt;broadcastMessage(&amp;allie_update, sizeof(PlayerAllianceUpdate));
-    if ( allie_request-&gt;getAllieByPlayerIndex() != local_player_index )
-    {
-        SERVER-&gt;sendMessage(allie_request-&gt;getAllieByPlayerIndex(),
-                            &amp;allie_update, sizeof(PlayerAllianceUpdate));
-    }
-    if ( allie_request-&gt;getAllieWithPlayerIndex() != local_player_index )
-    {
-        SERVER-&gt;sendMessage(allie_request-&gt;getAllieWithPlayerIndex(),
-                            &amp;allie_update, sizeof(PlayerAllianceUpdate));
-    }
-}
-
-void PlayerInterface::netMessageAllianceUpdate(const NetMessage* message)
-{
-    const PlayerAllianceUpdate* allie_update
-    = (const PlayerAllianceUpdate *) message;
-
-    if(allie_update-&gt;getAllieByPlayerIndex() &gt;= max_players
-            || allie_update-&gt;getAllieWithPlayerIndex() &gt;= max_players)
-    {
-        LOGGER.warning(&quot;Invalid alliance update message&quot;);
-        return;
-    }
-
-    SDL_mutexP(mutex);
-    handleAllianceMessage(allie_update-&gt;alliance_update_type,
-                          allie_update-&gt;getAllieByPlayerIndex(),
-                          allie_update-&gt;getAllieWithPlayerIndex());
-    SDL_mutexV(mutex);
-}
-
 void PlayerInterface::processNetMessage(const NetPacket* packet)
 {
     const NetMessage* message = packet-&gt;getNetMessage();
@@ -632,23 +516,6 @@
     }
     break;
 
-    case _net_message_id_player_update_flag:
-    {
-        const UpdatePlayerFlag* upf = (const UpdatePlayerFlag*)message;
-        ResourceManager::updateFlagData(packet-&gt;fromPlayer,
-                                        upf-&gt;player_flag,
-                                        sizeof(upf-&gt;player_flag) );
-
-        PlayerFlagSync pfs;
-        pfs.player_id = packet-&gt;fromPlayer;
-        memcpy(pfs.player_flag, upf-&gt;player_flag, sizeof(pfs.player_flag));
-
-        player_lists[packet-&gt;fromPlayer].setStateActive();
-
-        SERVER-&gt;broadcastMessage(&amp;pfs, sizeof(pfs));
-    }
-    break;
-
     case _net_message_id_player_sync_state :
         netMessageSyncState(message);
         break;
@@ -657,39 +524,36 @@
             netMessageScoreUpdate(message);
         break;
 
-    case _net_message_id_player_alliance_request :
-        netMessageAllianceRequest(message);
+    case _net_message_id_team_change_update :
+        TeamManager::handlePlayerTeamUpdate(((PlayerTeamUpdate*)message)-&gt;player_id, ((PlayerTeamUpdate*)message)-&gt;team_id);
         break;
 
-    case _net_message_id_player_alliance_update :
-        netMessageAllianceUpdate(message);
+    case _net_message_id_player_ready_update :
+        TeamManager::handlePlayerReadyUpdate(((PlayerReadyUpdate*)message)-&gt;player_id);
         break;
 
-    case _net_message_id_player_changeteam_request :
-        TeamManager::netMessageChangeTeamRequest(message);
-        break;
-
-    case _net_message_id_player_ready_request :
-        TeamManager::netMessageReadyRequest(message);
-        break;
-
     case _net_message_id_player_team_score_sync :
         if (GameControlRulesDaemon::getGameState() != _game_state_completed)
             TeamManager::receiveScores(message);
         break;
 
     case _net_message_id_player_vote_request :
-        VoteManager::netMessageReceiveRequestVote(message, packet-&gt;fromPlayer);
+        VoteManager::netMessageReceiveRequestVote(message);
         break;
 
-    case _net_message_id_player_vote :
-            VoteManager::netMessageVoteRequest(message);
-        break;
-
     case _net_message_id_player_flagtimer_update :
-        const PlayerFlagTimerUpdate* pftu = (const PlayerFlagTimerUpdate*)message;
-        gameconfig-&gt;game_changeflagtime = pftu-&gt;getflagtimer();
+        gameconfig-&gt;game_changeflagtime = ((const PlayerFlagTimerUpdate*)message)-&gt;getflagtimer();
         break;
+        
+    case _net_message_id_alliance_created_update :
+        handleAllianceCreatedUpdate( ((AllianceCreatedUpdate*)message)-&gt;by_player,
+                                     ((AllianceCreatedUpdate*)message)-&gt;with_player );
+        break;
+        
+    case _net_message_id_alliance_broken_update :
+        handleAllianceBrokenUpdate( ((AllianceBrokenUpdate*)message)-&gt;by_player,
+                                    ((AllianceBrokenUpdate*)message)-&gt;with_player );
+        break;
 
     }
 }
@@ -721,3 +585,156 @@
 
     SERVER-&gt;broadcastMessage(&amp;player_flagtimer_update, sizeof(PlayerFlagTimerUpdate));
 }
+ 
+void PlayerInterface::playerRequest_changeFlag(const PlayerID player_id, const Uint8* data)
+{
+    ResourceManager::updateFlagData(player_id, data, FLAG_WIDTH*FLAG_HEIGHT );
+
+    PlayerFlagSync pfs;
+    pfs.player_id = player_id;
+    
+    memcpy(pfs.player_flag, data, sizeof(pfs.player_flag));
+
+    player_lists[player_id].setStateActive();
+
+    SERVER-&gt;broadcastMessage(&amp;pfs, sizeof(pfs));
+}
+
+void PlayerInterface::playerRequest_allianceRequest(const PlayerID player_id, const PlayerID with_player_id)
+{
+    setAlliance(player_id, with_player_id);
+ 
+    AllianceCreatedUpdate upd;
+    upd.by_player = player_id;
+    upd.with_player = with_player_id;
+    
+    if ( player_id != local_player_index )
+    {
+        SERVER-&gt;sendMessage(player_id, &amp;upd, sizeof(upd));
+    }
+    else
+    {
+        handleAllianceCreatedUpdate(player_id, with_player_id);
+    }
+    
+    if ( with_player_id != local_player_index )
+    {
+        SERVER-&gt;sendMessage(with_player_id, &amp;upd, sizeof(upd));
+    }
+    else
+    {
+        handleAllianceCreatedUpdate(player_id, with_player_id);
+    }
+
+}
+
+void PlayerInterface::playerRequest_breakAlliance(const PlayerID player_id, const PlayerID with_player_id)
+{
+    clearAlliance(player_id, with_player_id);
+
+    AllianceBrokenUpdate upd;
+    upd.by_player = player_id;
+    upd.with_player = with_player_id;
+    
+    if ( player_id != local_player_index )
+    {
+        SERVER-&gt;sendMessage(player_id, &amp;upd, sizeof(upd));
+    }
+    else
+    {
+        handleAllianceBrokenUpdate(player_id, with_player_id);
+    }
+    
+    if ( with_player_id != local_player_index )
+    {
+        SERVER-&gt;sendMessage(with_player_id, &amp;upd, sizeof(upd));
+    }
+    else
+    {
+        handleAllianceBrokenUpdate(player_id, with_player_id);
+    }
+    
+    clearAlliance(with_player_id, player_id);
+}
+
+void PlayerInterface::handleAllianceCreatedUpdate(const PlayerID by_player, const PlayerID with_player)
+{
+    PlayerState * player_state;
+    
+    setAlliance(by_player, with_player);
+ 
+    if ( by_player == local_player_index )
+    {
+        player_state = PlayerInterface::getPlayer(with_player);
+        if ( PlayerInterface::isSingleAllied(with_player, by_player) )
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;You accepted %s alliance request.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+        else
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;You request alliance with %s.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+    }
+    else if ( with_player == local_player_index )
+    {
+        player_state = PlayerInterface::getPlayer(by_player);
+        if ( PlayerInterface::isSingleAllied( with_player, by_player) )
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;%s accepted your alliance request.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+        else
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;%s request to ally with you.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+    }
+}
+
+void PlayerInterface::handleAllianceBrokenUpdate(const PlayerID by_player, const PlayerID with_player)
+{
+    PlayerState * player_state;
+    
+    clearAlliance(by_player, with_player);
+    
+    if ( by_player == local_player_index )
+    {
+        player_state = PlayerInterface::getPlayer(with_player);
+        if ( PlayerInterface::isSingleAllied(with_player, by_player) )
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;You broke the alliance with %s.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+        else
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;You cancel your alliance request with %s.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+    }
+    else if ( with_player == local_player_index )
+    {
+        player_state = PlayerInterface::getPlayer(by_player);
+        if ( PlayerInterface::isSingleAllied( with_player, by_player) )
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;%s broke the alliance with you.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+        else
+        {
+            ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                          &quot;%s canceled the alliance request with you.&quot;,
+                                          player_state-&gt;getName().c_str());
+        }
+    }
+    
+    clearAlliance(with_player, by_player);
+}

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -141,14 +141,22 @@
     static void netMessageConnectID(const NetMessage *message );
     static void netMessageSyncState(const NetMessage *message );
     static void netMessageScoreUpdate(const NetMessage *message );
-    static void netMessageAllianceRequest(const NetMessage *message );
-    static void netMessageAllianceUpdate(const NetMessage *message );
 
     static void netMessageChangeTeamRequest(const NetMessage* message);
 
 public:
     static void processNetMessage(const NetPacket *packet );
     static void disconnectPlayerCleanup( PlayerID player_id );
+    
+    static void playerRequest_changeFlag(const PlayerID player_id, const Uint8* data);
+    static void playerRequest_allianceRequest(const PlayerID player_id, const PlayerID with_player_id);
+    static void playerRequest_breakAlliance(const PlayerID player_id, const PlayerID with_player_id);
+    static void playerRequest_ready(const PlayerID player_id);
+    
+
+private:
+    static void handleAllianceCreatedUpdate(const PlayerID by_player, const PlayerID with_player);
+    static void handleAllianceBrokenUpdate(const PlayerID by_player, const PlayerID with_player);
 };
 
 #endif // ** _PLAYERINTERFACE_HP

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/Team.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/Team.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/Team.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,6 +1,6 @@
 /*
 Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Laurent Jacques
-
+ 
 This program is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2 of the License, or
@@ -10,7 +10,7 @@
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
-
+ 
 You should have received a copy of the GNU General Public License
 along with this program; if not, write to the Free Software
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
@@ -21,7 +21,7 @@
 #include &quot;Util/Log.hpp&quot;
 #include &quot;2D/Surface.hpp&quot;
 
-void Team::initialize(const Uint8 id)
+void Team::initialize(const TeamID id)
 {
     teamID = id;
     resetStats();
@@ -57,7 +57,7 @@
         if (state-&gt;isActive())
         {
             if (state-&gt;getTeamID() == teamID
-                &amp;&amp; (player_id != new_player))
+                &amp;&amp; (player_id != new_player)) 
             {
                 PlayerInterface::allyplayers( player_id, new_player);
             }
@@ -72,7 +72,7 @@
     {
         if (PlayerInterface::getPlayer(player_id)-&gt;isActive())
         {
-            if (PlayerInterface::getPlayer(player_id)-&gt;getTeamID() == teamID)
+            if (PlayerInterface::getPlayer(player_id)-&gt;getTeamID() == teamID) 
             {
                 PlayerInterface::unallyplayers( old_player, player_id);
             }
@@ -93,7 +93,7 @@
     {
         if (PlayerInterface::getPlayer(player_id)-&gt;isActive())
         {
-            if (PlayerInterface::getPlayer(player_id)-&gt;getTeamID() == teamID)
+            if (PlayerInterface::getPlayer(player_id)-&gt;getTeamID() == teamID) 
             {
                 count++;
             }
@@ -107,12 +107,12 @@
     PlayerID count = 0;
     PlayerID player_id, result =0;
     Uint8 player = rand()%countPlayers();
-
+    
     for ( player_id = 0; player_id &lt; PlayerInterface::getMaxPlayers(); ++player_id )
     {
         if (PlayerInterface::getPlayer(player_id)-&gt;isActive())
         {
-            if (PlayerInterface::getPlayer(player_id)-&gt;getTeamID() == teamID)
+            if (PlayerInterface::getPlayer(player_id)-&gt;getTeamID() == teamID) 
             {
                 if (count == player) return player_id;
                 count++;
@@ -147,13 +147,13 @@
 {
     short TeamObjective = 0;
     PlayerID player_id;
-
+    
     for ( player_id = 0; player_id &lt; PlayerInterface::getMaxPlayers(); ++player_id )
     {
         PlayerState* state = PlayerInterface::getPlayer(player_id);
         if (state-&gt;isActive())
         {
-            if (state-&gt;getTeamID() == teamID)
+            if (state-&gt;getTeamID() == teamID) 
             {
                 TeamObjective += state-&gt;getObjectivesHeld();
             }

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/Team.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/Team.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/Team.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -24,7 +24,7 @@
 class Team
 {
 protected:
-    Uint8 teamID;
+    TeamID teamID;
     std::string name;
     Surface Flag;
     Uint8 teamColor;
@@ -35,7 +35,7 @@
     bool stats_locked;
 
 public:
-    void initialize(const Uint8 id);
+    void initialize(const TeamID id);
 
     void setName(const std::string&amp; newname);
     const std::string&amp; getName() const;
@@ -44,7 +44,7 @@
     void addPlayer(PlayerID player_id);
     void removePlayer(PlayerID player_id);
     void cleanUp();
-    Uint8 getID() const { return teamID; }
+    TeamID getID() const { return teamID; }
     PlayerID countPlayers() const;
     PlayerID getrandomplayer() const;
     void loadFlag(const char *fileName);

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -36,6 +36,7 @@
 #include &quot;Objectives/Objective.hpp&quot;
 #include &quot;Views/Components/Desktop.hpp&quot;
 #include &quot;Views/Game/PrepareTeam.hpp&quot;
+#include &quot;Network/PlayerRequests/PlayerReadyRequest.hpp&quot;
 
 Team       * TeamManager::Teams_lists = 0;
 Uint8        TeamManager::max_Teams = 0;
@@ -90,14 +91,14 @@
     for ( int team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         Teams_lists[ team_id ].initialize(team_id);
-        if (team_id &lt; (Uint8) plist.size()) Teams_lists[ team_id ].setName(plist[team_id]);
+        if (team_id &lt; (TeamID) plist.size()) Teams_lists[ team_id ].setName(plist[team_id]);
         snprintf(txtBuf, sizeof(txtBuf), &quot;pics/default/team-%d.bmp&quot;, team_id+1);
         Teams_lists[ team_id ].loadFlag(txtBuf);
         Teams_lists[ team_id ].setColor(colorsteam[team_id]);
     }
 }
 
-Uint8 TeamManager::getTeamColor(Uint8 team_id)
+Uint8 TeamManager::getTeamColor(TeamID team_id)
 {
     return Teams_lists[ team_id ].getColor();
 }
@@ -117,7 +118,7 @@
     Teams_lists[ lowTeam ].addPlayer(player_id);
 }
 
-int TeamManager::CountPlayerinTeam(Uint8 team_id)
+int TeamManager::CountPlayerinTeam(TeamID team_id)
 {
     return Teams_lists[ team_id ].countPlayers();
 }
@@ -141,9 +142,10 @@
             highTeam = team_id;
         }
     }
+    
     if ((maxPlayers - minPlayers) &gt; 1)
     {
-        serverrequestchangeTeam(Teams_lists[ highTeam ].getrandomplayer(), lowTeam);
+        playerRequest_changeTeam(Teams_lists[ highTeam ].getrandomplayer(), lowTeam);
     }
 }
 
@@ -161,19 +163,19 @@
     }
 }
 
-void TeamManager::addPlayerinTeam(PlayerID player_id, Uint8 team_id)
+void TeamManager::addPlayerinTeam(PlayerID player_id, TeamID team_id)
 {
     Teams_lists[ team_id ].addPlayer(player_id);
 }
 
-void TeamManager::removePlayer(PlayerID player_id, Uint8 team_id)
+void TeamManager::removePlayer(PlayerID player_id, TeamID team_id)
 {
     Teams_lists[ team_id ].removePlayer(player_id);
 }
 
 void TeamManager::cleanUp()
 {
-    Uint8 team_id;
+    TeamID team_id;
     for ( team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         Teams_lists[ team_id ].cleanUp();
@@ -185,7 +187,7 @@
 
 iXY TeamManager::getPlayerSpawnPoint(PlayerID player_id)
 {
-    Uint8 Team_id = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
+    TeamID Team_id = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
 
     iXY spawn_point;
     switch (Team_id)
@@ -204,7 +206,7 @@
 
 void TeamManager::lockTeamStats()
 {
-    for ( Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+    for ( TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         Teams_lists[ team_id ].lockStats();
     }
@@ -212,7 +214,7 @@
 
 void TeamManager::unlockTeamStats()
 {
-    for ( Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+    for ( TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         Teams_lists[ team_id ].unlockStats();
     }
@@ -220,48 +222,48 @@
 
 void TeamManager::resetTeamStats()
 {
-    for ( Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+    for ( TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         Teams_lists[ team_id ].resetStats();
     }
 }
 
-short TeamManager::getKills(  Uint8 team_id )
+short TeamManager::getKills(  TeamID team_id )
 {
     return Teams_lists[team_id].getKills();
 }
 
-short TeamManager::getLosses(  Uint8 team_id )
+short TeamManager::getLosses(  TeamID team_id )
 {
     return Teams_lists[team_id].getLosses();
 }
 
-void TeamManager::incKills( Uint8 team_id )
+void TeamManager::incKills( TeamID team_id )
 {
     Teams_lists[team_id].incKills();
 }
 
-void TeamManager::incLosses( Uint8 team_id )
+void TeamManager::incLosses( TeamID team_id )
 {
     Teams_lists[team_id].incLosses();
 }
 
-short TeamManager::getObjectivesHeld( Uint8 team_id )
+short TeamManager::getObjectivesHeld( TeamID team_id )
 {
     return Teams_lists[team_id].getTeamObjective();
 }
 
-Uint8 TeamManager::getTeamWin()
+TeamID TeamManager::getTeamWin()
 {
     long Score = 0;
-    Uint8 teamWin = 0;
+    TeamID teamWin = 0;
     unsigned char game_type = GameConfig::game_gametype;
 
     switch (game_type)
     {
     case _gametype_fraglimit:
     case _gametype_timelimit:
-        for (Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+        for (TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
         {
             if (Score &lt; Teams_lists[team_id].getKills())
             {
@@ -271,7 +273,7 @@
         }
         break;
     case _gametype_objective:
-        for (Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+        for (TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
         {
             if (Score &lt; Teams_lists[team_id].getTeamObjective())
             {
@@ -284,19 +286,19 @@
     return teamWin;
 }
 
-const std::string&amp; TeamManager::getTeamName( Uint8 team_id )
+const std::string&amp; TeamManager::getTeamName( TeamID team_id )
 {
     return Teams_lists[team_id].getName();
 }
 
-void TeamManager::drawFlag(Uint8 team_id, Surface&amp; dest, int x, int y)
+void TeamManager::drawFlag(TeamID team_id, Surface&amp; dest, int x, int y)
 {
     Teams_lists[team_id].drawFlag(dest, x, y);
 }
 
 bool TeamManager::testRuleScoreLimit( long score_limit )
 {
-    for (Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+    for (TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         if ( Teams_lists[team_id].getKills() &gt;= score_limit )
             return( true );
@@ -308,7 +310,7 @@
 {
     ObjectiveID max_objectives = ObjectiveInterface::getObjectiveLimit();
 
-    for (Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+    for (TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         if ( Teams_lists[team_id].getTeamObjective() &gt;= max_objectives )
         {
@@ -318,74 +320,6 @@
     return false;
 }
 
-void TeamManager::PlayerrequestchangeTeam(PlayerID player_id, Uint8 newteam)
-{
-    PlayerTeamRequest Changeteam_request;
-    Changeteam_request.set(player_id, newteam, change_team_request);
-    CLIENT-&gt;sendMessage( &amp;Changeteam_request, sizeof(PlayerTeamRequest));
-}
-
-void TeamManager::serverrequestchangeTeam(PlayerID player_id, Uint8 newteam)
-{
-    Uint8 current_team = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
-
-    if (GameControlRulesDaemon::getGameState() == _game_state_prepare_team)
-    {
-        if (((PlayerInterface::getMaxPlayers()/2) &gt; Teams_lists[newteam].countPlayers()))
-        {
-            Teams_lists[current_team].removePlayer(player_id);
-            Teams_lists[newteam].addPlayer(player_id);
-            PlayerTeamRequest Changeteam_request;
-            Changeteam_request.set(player_id, newteam, change_team_Accepted);
-            SERVER-&gt;broadcastMessage( &amp;Changeteam_request, sizeof(PlayerTeamRequest));
-        }
-    }
-    else
-    {
-        if ( (Teams_lists[newteam].countPlayers() &lt; Teams_lists[current_team].countPlayers())
-                &amp;&amp; ((PlayerInterface::getMaxPlayers()/2) &gt; Teams_lists[newteam].countPlayers()))
-        {
-            Teams_lists[current_team].removePlayer(player_id);
-            Teams_lists[newteam].addPlayer(player_id);
-            PlayerTeamRequest Changeteam_request;
-            Changeteam_request.set(player_id, newteam, change_team_Accepted);
-            SERVER-&gt;broadcastMessage( &amp;Changeteam_request, sizeof(PlayerTeamRequest));
-            ObjectiveInterface::disownPlayerObjectives(player_id);
-            UnitInterface::destroyPlayerUnits(player_id);
-            GameManager::spawnPlayer( player_id );
-        }
-    }
-}
-
-void TeamManager::PlayerchangeTeam(PlayerID player_id, Uint8 team_idx)
-{
-    Uint8 current_team = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
-
-    Teams_lists[current_team].removePlayer(player_id);
-    Teams_lists[team_idx].addPlayer(player_id);
-
-    if (GameControlRulesDaemon::getGameState() != _game_state_prepare_team)
-        ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                      &quot;%s has changed to team %s.&quot;,
-                                      PlayerInterface::getPlayer(player_id)-&gt;getName().c_str(),
-                                      Teams_lists[team_idx].getName().c_str());
-}
-
-void TeamManager::PlayerRequestReady(PlayerID player_id)
-{
-    PlayerReadyRequest Ready_request;
-    Ready_request.set(player_id, ready_request);
-    CLIENT-&gt;sendMessage( &amp;Ready_request, sizeof(PlayerReadyRequest));
-}
-
-void TeamManager::ServerRequestReady(PlayerID player_id)
-{
-    setReady(player_id);
-    PlayerReadyRequest Ready_request;
-    Ready_request.set(player_id, ready_Accepted);
-    SERVER-&gt;broadcastMessage( &amp;Ready_request, sizeof(PlayerReadyRequest));
-}
-
 bool TeamManager::CheckisPlayerReady()
 {
     if (PlayerInterface::getActivePlayerCount() &gt; 1)
@@ -419,7 +353,7 @@
 void TeamManager::sendScores()
 {
     TeamScoreSync score_Sync;
-    for (Uint8 team_id = 0; team_id &lt; max_Teams; ++team_id )
+    for (TeamID team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         score_Sync.set(team_id, getKills(team_id), getLosses(team_id));
         SERVER-&gt;broadcastMessage(&amp;score_Sync, sizeof(TeamScoreSync));
@@ -435,42 +369,8 @@
         Teams_lists[score_Sync-&gt;TeamID].syncScore(score_Sync-&gt;getKills(), score_Sync-&gt;getLosses());
 }
 
-void TeamManager::netMessageChangeTeamRequest(const NetMessage* message)
+void TeamManager::serversayToTeam(const TeamID teamID, const NPString&amp; message)
 {
-    const PlayerTeamRequest* changeTeamRequest
-    = (const PlayerTeamRequest *) message;
-
-    switch(changeTeamRequest-&gt;request_type)
-    {
-    case change_team_request :
-        serverrequestchangeTeam(changeTeamRequest-&gt;getPlayerIndex(),changeTeamRequest-&gt;gettoteamindex());
-        break;
-
-    case change_team_Accepted:
-        PlayerchangeTeam(changeTeamRequest-&gt;getPlayerIndex(),changeTeamRequest-&gt;gettoteamindex());
-        break;
-    }
-}
-void TeamManager::netMessageReadyRequest(const NetMessage* message)
-{
-    const PlayerReadyRequest* ReadyRequest
-    = (const PlayerReadyRequest *) message;
-
-    switch(ReadyRequest-&gt;request_type)
-    {
-    case ready_request :
-        ServerRequestReady(ReadyRequest-&gt;getPlayerIndex());
-        break;
-
-    case change_team_Accepted:
-        PlayerRequestReadyAccepted(ReadyRequest-&gt;getPlayerIndex());
-        break;
-    }
-
-}
-
-void TeamManager::serversayToTeam(const Uint8 teamID, const NPString&amp; message)
-{
     PlayerID player_id;
     for ( player_id = 0; player_id &lt; PlayerInterface::getMaxPlayers(); ++player_id )
     {
@@ -484,7 +384,7 @@
     }
 }
 
-void TeamManager::sendMessageToTeam(const Uint8 teamID, NetMessage* message, size_t size)
+void TeamManager::sendMessageToTeam(const TeamID teamID, NetMessage* message, size_t size)
 {
     PlayerID player_id;
     for ( player_id = 0; player_id &lt; PlayerInterface::getMaxPlayers(); ++player_id )
@@ -499,6 +399,71 @@
     }
 }
 
+void TeamManager::playerRequest_ready(const PlayerID player_id)
+{
+    setReady(player_id);
+    
+    PlayerReadyUpdate msg;
+    msg.player_id = player_id;
+    SERVER-&gt;broadcastMessage( &amp;msg, sizeof(msg));
+}
 
+void TeamManager::playerRequest_changeTeam(const PlayerID player_id, const TeamID team_id)
+{
+    TeamID current_team = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
 
+    if (GameControlRulesDaemon::getGameState() == _game_state_prepare_team)
+    {
+        if (((PlayerInterface::getMaxPlayers()/2) &gt; Teams_lists[team_id].countPlayers()))
+        {
+            Teams_lists[current_team].removePlayer(player_id);
+            Teams_lists[team_id].addPlayer(player_id);
+            
+            PlayerTeamUpdate upd;
+            upd.player_id = player_id;
+            upd.team_id = team_id;
+            
+            SERVER-&gt;broadcastMessage( &amp;upd, sizeof(upd));
+        }
+    }
+    else
+    {
+        if ( (Teams_lists[team_id].countPlayers() &lt; Teams_lists[current_team].countPlayers())
+                &amp;&amp; ((PlayerInterface::getMaxPlayers()/2) &gt; Teams_lists[team_id].countPlayers()))
+        {
+            Teams_lists[current_team].removePlayer(player_id);
+            Teams_lists[team_id].addPlayer(player_id);
+            
+            PlayerTeamUpdate upd;
+            upd.player_id = player_id;
+            upd.team_id = team_id;
+            
+            SERVER-&gt;broadcastMessage( &amp;upd, sizeof(upd));
+            
+            ObjectiveInterface::disownPlayerObjectives(player_id);
+            UnitInterface::destroyPlayerUnits(player_id);
+            GameManager::spawnPlayer( player_id );
+        }
+    }
+}
 
+void TeamManager::handlePlayerTeamUpdate(const PlayerID player_id, const TeamID team_id)
+{
+    TeamID current_team = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
+
+    Teams_lists[current_team].removePlayer(player_id);
+    Teams_lists[team_id].addPlayer(player_id);
+
+    if (GameControlRulesDaemon::getGameState() != _game_state_prepare_team)
+    {
+        ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                      &quot;%s has changed to team %s.&quot;,
+                                      PlayerInterface::getPlayer(player_id)-&gt;getName().c_str(),
+                                      Teams_lists[team_id].getName().c_str());
+    }
+}
+
+void TeamManager::handlePlayerReadyUpdate(const PlayerID player_id)
+{
+    setReady(player_id);
+}

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -30,13 +30,13 @@
 public:
 
     static void initialize(const Uint8 _max_teams);
-    static Uint8 getTeamColor(Uint8 team_id);
+    static Uint8 getTeamColor(TeamID team_id);
     static void reset();
     static void addPlayer(PlayerID player_id);
-    static void addPlayerinTeam(PlayerID player_id, Uint8 team_id);
+    static void addPlayerinTeam(PlayerID player_id, TeamID team_id);
     static void BalancedTeam();
-    static void removePlayer(PlayerID player_id, Uint8 team_id);
-    static int CountPlayerinTeam(Uint8 team_id);
+    static void removePlayer(PlayerID player_id, TeamID team_id);
+    static int CountPlayerinTeam(TeamID team_id);
     static void cleanUp();
 
     static PlayerID getMaxteams()
@@ -45,11 +45,11 @@
     }
     static iXY getPlayerSpawnPoint(PlayerID player_id);
 
-    static short getKills( Uint8 team_id );
-    static short getLosses( Uint8 team_id );
-    static short getObjectivesHeld( Uint8 team_id );
-    static void incKills( Uint8 team_id );
-    static void incLosses( Uint8 team_id );
+    static short getKills( TeamID team_id );
+    static short getLosses( TeamID team_id );
+    static short getObjectivesHeld( TeamID team_id );
+    static void incKills( TeamID team_id );
+    static void incLosses( TeamID team_id );
     static void lockTeamStats();
     static void unlockTeamStats();
     static void resetTeamStats();
@@ -57,27 +57,29 @@
     static void receiveScores(const NetMessage* message);
 
     static Uint8 getTeamWin();
-    static const std::string&amp; getTeamName( Uint8 team_id );
+    static const std::string&amp; getTeamName( TeamID team_id );
     static bool testRuleScoreLimit( long score_limit );
     static bool testRuleObjectiveRatio( float precentage );
-    static void drawFlag( Uint8 team_id, Surface &amp;dest, int x, int y);
+    static void drawFlag( TeamID team_id, Surface &amp;dest, int x, int y);
 
-    static void PlayerrequestchangeTeam(PlayerID player_id, Uint8 newteam);
-    static void serverrequestchangeTeam(PlayerID player_id, Uint8 team_idx);
-    static void PlayerchangeTeam(PlayerID player_id, Uint8 team_idx);
+    static void PlayerrequestchangeTeam(PlayerID player_id, TeamID newteam);
+    static void PlayerchangeTeam(PlayerID player_id, TeamID team_idx);
     static void SpawnTeams();
 
     static bool CheckisPlayerReady();
     static bool isPlayerReady(PlayerID player_id);
-    static void PlayerRequestReady(PlayerID player_id);
-    static void ServerRequestReady(PlayerID player_id);
     static void PlayerRequestReadyAccepted(PlayerID player_id);
 
     static void netMessageChangeTeamRequest(const NetMessage* message);
-    static void netMessageReadyRequest(const NetMessage* message);
-    static void serversayToTeam(const Uint8 teamID, const NPString&amp; message);
-    static void sendMessageToTeam(const Uint8 teamID, NetMessage* message, size_t size);
+    static void serversayToTeam(const TeamID teamID, const NPString&amp; message);
+    static void sendMessageToTeam(const TeamID teamID, NetMessage* message, size_t size);
 
+    static void playerRequest_ready(const PlayerID player_id);
+    static void playerRequest_changeTeam(const PlayerID player_id, const TeamID team_id);
+    
+    static void handlePlayerTeamUpdate(const PlayerID player_id, const TeamID team_id);
+    static void handlePlayerReadyUpdate(const PlayerID player_id);
+    
 };
 
 #endif // ** _TEAMMANAGER_HPP

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -1,182 +1,137 @@
-/*
-Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Laurent Jacques
-
-This program is free software; you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation; either version 2 of the License, or
-(at your option) any later version.
-
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-
-#include &quot;Interfaces/VoteManager.hpp&quot;
-#include &quot;Interfaces/PlayerInterface.hpp&quot;
-#include &quot;Interfaces/ChatInterface.hpp&quot;
-#include &quot;Interfaces/GameControlRulesDaemon.hpp&quot;
-#include &quot;Interfaces/GameConfig.hpp&quot;
-#include &quot;Interfaces/TeamManager.hpp&quot;
-#include &quot;Interfaces/StrManager.hpp&quot;
-#include &quot;Classes/Network/PlayerNetMessage.hpp&quot;
-#include &quot;Classes/Network/NetworkServer.hpp&quot;
-#include &quot;Classes/Network/NetworkClient.hpp&quot;
-#include &quot;Classes/Network/NetworkState.hpp&quot;
-#include &quot;Views/Components/Desktop.hpp&quot;
-#include &quot;Views/Game/VoteBox.hpp&quot;
-
-bool   VoteManager::vote_in_progress = false;
-Uint8  VoteManager::type_vote = unassigned_vote;
-Uint8  *VoteManager::player_vote = 0;
-Uint8  VoteManager::vote_counter = 0;
-Uint8  VoteManager::players_in_vote = 0;
-Timer  VoteManager::voteTimer;
-Uint8  VoteManager::vote_team = 0xFF;
-
-VoteBox *votebox;
-
-const char *VoteStrings[1] = {&quot;Surrendering vote, you choose surrendering?\0&quot;};
-
-void VoteManager::netMessageVoteRequest(const NetMessage* message)
-{
-    const PlayerSendVote* voteplayer
-    = (const PlayerSendVote *) message;
-
-    if (vote_in_progress)
-    {
-        vote_counter--;
-        player_vote[ voteplayer-&gt;getPlayerIndex() ] = voteplayer-&gt;player_vote;
-        char buff[100];
-        sprintf(buff, _(&quot;player %s has voted, waiting %d votes&quot;),
-                PlayerInterface::getPlayer(voteplayer-&gt;getPlayerIndex())-&gt;getName().c_str(),
-                vote_counter);
-        if (GameConfig::game_teammode)
-            TeamManager::serversayToTeam(vote_team, buff);
-        else
-            ChatInterface::serversay(buff);
-        if (vote_counter &lt; 1)
-            checkPlayersVote();
-    }
-}
-
-void VoteManager::startVote(Uint8 type)
-{
-    vote_in_progress = true;
-    type_vote = type;
-    if (GameConfig::game_teammode)
-        vote_counter = TeamManager::CountPlayerinTeam(vote_team);
-    else
-        vote_counter = PlayerInterface::getActivePlayerCount();
-    players_in_vote = vote_counter;
-}
-
-void VoteManager::netMessageReceiveRequestVote(const NetMessage* message, PlayerID playerid)
-{
-    const PlayerVoteRequested* vote_request
-    = (const PlayerVoteRequested *) message;
-
-    if ( NetworkState::status == _network_state_server )
-    {
-        if (vote_in_progress) return;
-        resetVote();
-        vote_team = PlayerInterface::getPlayer(playerid)-&gt;getTeamID();
-        startVote(vote_request-&gt;vote_type);
-        serverSendRequestVote();
-        char buff[100];
-        sprintf(buff, &quot;Player %s request vote&quot;,
-                PlayerInterface::getPlayer(playerid)-&gt;getName().c_str());
-        if (GameConfig::game_teammode)
-            TeamManager::serversayToTeam(vote_team, buff);
-        else
-            ChatInterface::serversay(buff);
-    }
-    else
-    {
-        resetVote();
-        startVote(vote_request-&gt;vote_type);
-        votebox = new VoteBox(VoteStrings[type_vote]);
-        Desktop::add(votebox);
-        Desktop::setVisibility(&quot;votebox&quot;, true);
-    }
-}
-
-void VoteManager::resetVote()
-{
-    vote_in_progress = false;
-    type_vote = unassigned_vote;
-    delete[] player_vote;
-    if (votebox)
-    {
-        Desktop::remove(votebox);
-    }
-    player_vote = new Uint8 [PlayerInterface::getMaxPlayers()];
-    for ( int i = 0; i &lt; PlayerInterface::getMaxPlayers(); i++ )
-    {
-        player_vote[ i ] = vote_nothing;
-    }
-    if ( NetworkState::status == _network_state_server )
-        voteTimer.changePeriod(70);// more time for prevent some client retard (lag)
-        else
-        voteTimer.changePeriod(60);
-    voteTimer.reset();
-    players_in_vote = 0;
-    vote_team = 0xFF;
-}
-
-void VoteManager::playerSendRequestVote(Uint8 type)
-{
-    PlayerVoteRequested vote_request;
-    vote_request.set(type);
-    CLIENT-&gt;sendMessage(&amp;vote_request, sizeof(PlayerVoteRequested));
-}
-
-void VoteManager::serverSendRequestVote()
-{
-    PlayerVoteRequested vote_request;
-    vote_request.set(type_vote);
-    if (GameConfig::game_teammode)
-        TeamManager::sendMessageToTeam(vote_team, &amp;vote_request, sizeof(PlayerVoteRequested));
-    else
-        SERVER-&gt;broadcastMessage(&amp;vote_request, sizeof(PlayerVoteRequested));
-}
-
-void VoteManager::executeVoteAction()
-{
-    switch (type_vote)
-    {
-        case surrender_vote :
-            GameControlRulesDaemon::forceEndRound();
-            break;
-    }
-}
-
-void VoteManager::checkPlayersVote()
-{
-    Uint8 yes_vote = 0, no_vote = 0;
-
-    for ( int i = 0; i &lt; PlayerInterface::getMaxPlayers(); i++ )
-    {
-        if (player_vote[ i ] == vote_yes)
-            yes_vote++;
-        else
-        if (player_vote[ i ] == vote_no)
-            no_vote++;
-    }
-    char buff[100];
-
-    int no_percent = ((players_in_vote-yes_vote)*100)/players_in_vote;
-    int yes_percent = ((players_in_vote-no_vote)*100)/players_in_vote;
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Laurent Jacques
 
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+*/
+
+#include &quot;Interfaces/VoteManager.hpp&quot;
+#include &quot;Interfaces/PlayerInterface.hpp&quot;
+#include &quot;Interfaces/ChatInterface.hpp&quot;
+#include &quot;Interfaces/GameControlRulesDaemon.hpp&quot;
+#include &quot;Interfaces/GameConfig.hpp&quot;
+#include &quot;Interfaces/TeamManager.hpp&quot;
+#include &quot;Interfaces/StrManager.hpp&quot;
+#include &quot;Classes/Network/PlayerNetMessage.hpp&quot;
+#include &quot;Classes/Network/NetworkServer.hpp&quot;
+#include &quot;Classes/Network/NetworkClient.hpp&quot;
+#include &quot;Classes/Network/NetworkState.hpp&quot;
+#include &quot;Views/Components/Desktop.hpp&quot;
+#include &quot;Views/Game/VoteBox.hpp&quot;
+
+bool   VoteManager::vote_in_progress = false;
+Uint8  VoteManager::type_vote = unassigned_vote;
+Uint8  *VoteManager::player_vote = 0;
+Uint8  VoteManager::vote_counter = 0;
+Uint8  VoteManager::players_in_vote = 0;
+Timer  VoteManager::voteTimer;
+Uint8  VoteManager::vote_team = 0xFF;
+
+VoteBox *votebox;
+
+const char *VoteStrings[1] = {&quot;Surrendering vote, you choose surrendering?\0&quot;};
+
+void VoteManager::startVote(Uint8 type)
+{
+    vote_in_progress = true;
+    type_vote = type;
+    if (GameConfig::game_teammode)
+        vote_counter = TeamManager::CountPlayerinTeam(vote_team);
+    else
+        vote_counter = PlayerInterface::getActivePlayerCount();
+    players_in_vote = vote_counter;
+}
+
+void VoteManager::netMessageReceiveRequestVote(const NetMessage* message)
+{
+    const PlayerVoteRequested* vote_request
+    = (const PlayerVoteRequested *) message;
+    
+    votebox = new VoteBox(VoteStrings[vote_request-&gt;vote_type]);
+    
+    Desktop::add(votebox);
+    Desktop::setVisibility(&quot;votebox&quot;, true);
+}
+
+void VoteManager::resetVote()
+{
+    vote_in_progress = false;
+    type_vote = unassigned_vote;
+    delete[] player_vote;
+    
+    if (votebox)
+    {
+        Desktop::remove(votebox);
+    }
+    
+    player_vote = new Uint8 [PlayerInterface::getMaxPlayers()];
+    for ( int i = 0; i &lt; PlayerInterface::getMaxPlayers(); i++ )
+    {
+        player_vote[ i ] = vote_nothing;
+    }
+    if ( NetworkState::status == _network_state_server )
+        voteTimer.changePeriod(70);// more time for prevent some client retard (lag)
+    else
+        voteTimer.changePeriod(60);
+    
+    voteTimer.reset();
+    players_in_vote = 0;
+    vote_team = 0xFF;
+}
+
+void VoteManager::serverSendRequestVote()
+{
+    PlayerVoteRequested vote_request;
+    vote_request.set(type_vote);
+    if (GameConfig::game_teammode)
+        TeamManager::sendMessageToTeam(vote_team, &amp;vote_request, sizeof(PlayerVoteRequested));
+    else
+        SERVER-&gt;broadcastMessage(&amp;vote_request, sizeof(PlayerVoteRequested));
+}
+
+void VoteManager::executeVoteAction()
+{
+    switch (type_vote)
+    {
+        case surrender_vote :
+            GameControlRulesDaemon::forceEndRound();
+            break;
+    }
+}
+
+void VoteManager::checkPlayersVote()
+{
+    Uint8 yes_vote = 0, no_vote = 0;
+
+    for ( int i = 0; i &lt; PlayerInterface::getMaxPlayers(); i++ )
+    {
+        if (player_vote[ i ] == vote_yes)
+            yes_vote++;
+        else
+        if (player_vote[ i ] == vote_no)
+            no_vote++;
+    }
+    char buff[100];
+
+    int no_percent = ((players_in_vote-yes_vote)*100)/players_in_vote;
+    int yes_percent = ((players_in_vote-no_vote)*100)/players_in_vote;
+
     bool accepted_vote = ( yes_percent &gt; 80 );
 
-    sprintf(buff, &quot;%d %% players has voted YES, %d %% has voted NO&quot;, yes_percent, no_percent);
+    sprintf(buff, &quot;%d %% players has voted YES, %d %% has voted NO&quot;, yes_percent, no_percent);
 
-    if ( GameConfig::game_teammode )
+    if ( GameConfig::game_teammode )
     {
         TeamManager::serversayToTeam(vote_team, buff);
         if ( accepted_vote )
@@ -189,34 +144,86 @@
     else
     {
         ChatInterface::serversay(buff);
-    }
-    vote_in_progress = false;
-    if ( accepted_vote ) executeVoteAction();
-}
-
-void VoteManager::playerVote(Uint8 responce)
-{
-    Desktop::setVisibility(&quot;votebox&quot;, false);
-    Desktop::remove(votebox);
-
-    PlayerSendVote vote_player;
-    vote_player.set(PlayerInterface::getLocalPlayerIndex(), responce);
-    CLIENT-&gt;sendMessage( &amp;vote_player, sizeof(PlayerSendVote));
-}
-
-bool VoteManager::checkVoteTimer()
-{
-    //server need to check the timer for stop vote
-    //if player crash or quit the game, vote don't ending
-    if (vote_in_progress)
-    {
-        return voteTimer.count();
-    }
-    return false;
-}
-
-int VoteManager::getTimer()
-{
-    return (int) voteTimer.getTimeLeft();
-}
-
+    }
+    vote_in_progress = false;
+    if ( accepted_vote ) executeVoteAction();
+}
+
+void VoteManager::playerVote(Uint8 responce)
+{
+    Desktop::setVisibility(&quot;votebox&quot;, false);
+    Desktop::remove(votebox);
+
+    PlayerSendVote vote_player;
+    vote_player.set(PlayerInterface::getLocalPlayerIndex(), responce);
+    CLIENT-&gt;sendMessage( &amp;vote_player, sizeof(PlayerSendVote));
+}
+
+bool VoteManager::checkVoteTimer()
+{
+    //server need to check the timer for stop vote
+    //if player crash or quit the game, vote don't ending
+    if (vote_in_progress)
+    {
+        return voteTimer.count();
+    }
+    return false;
+}
+
+int VoteManager::getTimer()
+{
+    return (int) voteTimer.getTimeLeft();
+}
+
+void VoteManager::playerRequest_startSurrenderVote(const PlayerID player_id)
+{
+    if (vote_in_progress)
+    {
+        return;
+    }
+    
+    resetVote();
+    
+    vote_team = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
+    
+    startVote(surrender_vote);
+    
+    serverSendRequestVote();
+    
+    char buff[100];
+    sprintf(buff, &quot;Player %s request vote&quot;,
+            PlayerInterface::getPlayer(player_id)-&gt;getName().c_str());
+    
+    if (GameConfig::game_teammode)
+        TeamManager::serversayToTeam(vote_team, buff);
+    else
+        ChatInterface::serversay(buff);
+}
+
+void VoteManager::playerRequest_voteSelected(const PlayerID player_id, Uint8 selected_vote)
+{
+    if (vote_in_progress)
+    {
+        vote_counter--;
+        player_vote[ player_id ] = selected_vote;
+        
+        char buff[100];
+        sprintf(buff, &quot;player %s has voted, waiting %d votes&quot;,
+                PlayerInterface::getPlayer(player_id)-&gt;getName().c_str(),
+                vote_counter);
+        
+        if (GameConfig::game_teammode)
+        {
+            TeamManager::serversayToTeam(vote_team, buff);
+        }
+        else
+        {
+            ChatInterface::serversay(buff);
+        }
+        
+        if (vote_counter &lt; 1)
+        {
+            checkPlayersVote();
+        }
+    }
+}

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/VoteManager.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -16,6 +16,9 @@
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
 
+#ifndef __VOTEMANAGER_HPP__
+#define __VOTEMANAGER_HPP__
+
 #include &quot;Classes/Network/NetMessage.hpp&quot;
 #include &quot;Util/Timer.hpp&quot;
 
@@ -47,9 +50,12 @@
     static void resetVote();
     static void startVote(Uint8 type);
     static void playerVote(Uint8 responce);
-    static void playerSendRequestVote(Uint8 type);
     static void serverSendRequestVote();
-    static void netMessageReceiveRequestVote(const NetMessage* message, PlayerID playerid);
-    static void netMessageVoteRequest(const NetMessage* message);
+    static void netMessageReceiveRequestVote(const NetMessage* message);
     static int getTimer();
+    
+    static void playerRequest_startSurrenderVote(const PlayerID player_id);
+    static void playerRequest_voteSelected(const PlayerID player_id, Uint8 selected_vote);
 };
+
+#endif

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AllianceRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AllianceRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AllianceRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,41 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 20, 2012, 4:07 PM
+ */
+
+#ifndef ALLIANCEREQUEST_HPP
+#define	ALLIANCEREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class AllianceRequest : public NetMessage
+{
+public:
+    PlayerID with_player_id;
+    
+    AllianceRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::ALLIANCE_REQUEST;
+    }
+    
+} __attribute__((packed));
+
+#endif	/* ALLIANCEREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AttackUnitRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AttackUnitRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/AttackUnitRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,50 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 8:41 AM
+ */
+
+#ifndef ATTACKUNITREQUEST_HPP
+#define	ATTACKUNITREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class AttackUnitRequest : public NetMessage
+{
+private:
+    Uint16 unit_id;
+    Uint16 enemy_id;
+    
+public:
+    AttackUnitRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::ATTACK_UNIT;
+    }
+    
+    void setUnitId(const UnitID unit_id) { this-&gt;unit_id = UnitID_toPortable(unit_id); }
+    UnitID getUnitId() const { return UnitID_fromPortable(unit_id); }
+    
+    void setEnemyId(const UnitID enemy_id) { this-&gt;enemy_id = UnitID_toPortable(enemy_id); }
+    UnitID getEnemyId() const { return UnitID_fromPortable(enemy_id); }
+    
+} __attribute__((packed));
+
+
+#endif	/* ATTACKUNITREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/BreakAllianceRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/BreakAllianceRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/BreakAllianceRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,41 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 20, 2012, 4:09 PM
+ */
+
+#ifndef BREAKALLIANCEREQUEST_HPP
+#define	BREAKALLIANCEREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class BreakAllianceRequest : public NetMessage
+{
+public:
+    PlayerID with_player_id;
+    
+    BreakAllianceRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::BREAK_ALLIANCE;
+    }
+    
+} __attribute__((packed));
+
+#endif	/* BREAKALLIANCEREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeFlagRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeFlagRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeFlagRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,41 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 20, 2012, 3:51 PM
+ */
+
+#ifndef CHANGEFLAGREQUEST_HPP
+#define	CHANGEFLAGREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class ChangeFlagRequest : public NetMessage
+{
+public:
+    Uint8 player_flag[FLAG_WIDTH*FLAG_HEIGHT];
+
+    ChangeFlagRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::CHANGE_FLAG;
+    }
+} __attribute__((packed));
+
+
+#endif	/* CHANGEFLAGREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,46 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 10:18 AM
+ */
+
+#ifndef CHANGEOBJECTIVEGENERATIONREQUEST_HPP
+#define	CHANGEOBJECTIVEGENERATIONREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class ChangeObjectiveGenerationRequest : public NetMessage
+{
+public:
+    ObjectiveID objective_id;
+    Uint8 unit_type;
+    Uint8 unit_gen_on;
+
+    ChangeObjectiveGenerationRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::CHANGE_OBJECTIVE_GENERATION;
+    }
+
+    void setObjectiveId(ObjectiveID id) { objective_id = ObjectiveID_toPortable(id); }
+    ObjectiveID getObjectiveId() const  { return ObjectiveID_fromPortable(objective_id); }
+    
+} __attribute__((packed));
+
+#endif	/* CHANGEOBJECTIVEGENERATIONREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveOutLocationRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveOutLocationRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeObjectiveOutLocationRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,57 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 10:26 AM
+ */
+
+#ifndef CHANGEOBJECTIVEOUTLOCATIONREQUEST_HPP
+#define	CHANGEOBJECTIVEOUTLOCATIONREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class ChangeObjectiveOutLocationRequest : public NetMessage
+{
+public:
+    ObjectiveID objective_id;
+    Uint16 map_x;
+    Uint16 map_y;
+
+    ChangeObjectiveOutLocationRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::CHANGE_OBJECTIVE_OUTLOC;
+    }
+
+    void setObjectiveId(ObjectiveID id) { objective_id = ObjectiveID_toPortable(id); }
+    ObjectiveID getObjectiveId() const  { return ObjectiveID_fromPortable(objective_id); }
+    
+    void setMapPos(const iXY&amp; map_pos)
+    {
+        map_x = htol16(map_pos.x);
+        map_y = htol16(map_pos.y);
+    }
+    
+    iXY getMapPos() const
+    {
+        return iXY(ltoh16(map_x), ltoh16(map_y));
+    }
+
+}__attribute__((packed));
+
+#endif	/* CHANGEOBJECTIVEOUTLOCATIONREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeTeamRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeTeamRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChangeTeamRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,41 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 20, 2012, 8:39 PM
+ */
+
+#ifndef CHANGETEAMREQUEST_HPP
+#define	CHANGETEAMREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class ChangeTeamRequest : public NetMessage
+{
+public:
+    Uint8 team_id;
+    
+    ChangeTeamRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::CHANGE_TEAM;
+    }
+    
+} __attribute__((packed));
+
+#endif	/* CHANGETEAMREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChatRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChatRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ChatRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,59 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 8:19 PM
+ */
+
+#ifndef CHATREQUEST_HPP
+#define	CHATREQUEST_HPP
+
+#include &quot;Core/CoreTypes.hpp&quot;
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+#include &lt;algorithm&gt;
+
+class ChatRequest : public NetMessage
+{
+public:
+    enum { MAX_CHAT_LENGTH = _MAX_NET_PACKET_SIZE - 16 };
+    
+    char message_text[MAX_CHAT_LENGTH];
+
+    ChatRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::CHAT;
+    }
+
+    unsigned int setText(const NPString&amp; text)
+    {
+        unsigned int text_len = std::min(text.size(), (unsigned int)MAX_CHAT_LENGTH);
+        text.copy(message_text, text_len);
+        
+        return text_len + sizeof(NetMessage);
+    }
+    
+    void getText(int packet_length, NPString&amp; text) const
+    {
+        unsigned int text_len = packet_length - sizeof(NetMessage);
+        text.assign(message_text, text_len);
+    }
+} __attribute__((packed));
+
+#endif	/* CHATREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ManualFireRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ManualFireRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/ManualFireRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,59 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 8:44 AM
+ */
+
+#ifndef MANUALFIREREQUEST_HPP
+#define	MANUALFIREREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class ManualFireRequest : public NetMessage
+{
+private:
+    Uint16 unit_id;
+    Uint16 map_x;
+    Uint16 map_y;
+    
+public:
+    
+    ManualFireRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::MANUAL_FIRE;
+    }
+    
+    void setUnitId(const UnitID unit_id) { this-&gt;unit_id = UnitID_toPortable(unit_id); }
+    UnitID getUnitId() const { return UnitID_fromPortable(unit_id); }
+
+    void setMapPos(const iXY&amp; map_pos)
+    {
+        map_x = htol16(map_pos.x);
+        map_y = htol16(map_pos.y);
+    }
+    
+    iXY getMapPos() const
+    {
+        return iXY(ltoh16(map_x), ltoh16(map_y));
+    }
+} __attribute__((packed));
+
+
+#endif	/* MANUALFIREREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/MoveUnitRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/MoveUnitRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/MoveUnitRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,58 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 8:38 AM
+ */
+
+#ifndef MOVEUNITREQUEST_HPP
+#define	MOVEUNITREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class MoveUnitRequest : public NetMessage
+{
+private:
+    Uint16 unit_id;
+    Uint16 map_x;
+    Uint16 map_y;
+    
+public:
+    MoveUnitRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::MOVE_UNIT;
+    }
+    
+    void setUnitId(const UnitID unit_id) { this-&gt;unit_id = UnitID_toPortable(unit_id); }
+    UnitID getUnitId() const { return UnitID_fromPortable(unit_id); }
+
+    void setMapPos(const iXY&amp; map_pos)
+    {
+        map_x = htol16(map_pos.x);
+        map_y = htol16(map_pos.y);
+    }
+    
+    iXY getMapPos() const
+    {
+        return iXY(ltoh16(map_x), ltoh16(map_y));
+    }
+    
+} __attribute__((packed));
+
+#endif	/* MOVEUNITREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerReadyRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerReadyRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerReadyRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,39 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 20, 2012, 8:21 PM
+ */
+
+#ifndef PLAYERREADYREQUEST_HPP
+#define	PLAYERREADYREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class PlayerReadyRequest : public NetMessage
+{
+public:
+    PlayerReadyRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::PLAYER_READY;
+    }
+    
+} __attribute__((packed));
+
+#endif	/* PLAYERREADYREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerRequests.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerRequests.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/PlayerRequests.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,48 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 8:34 AM
+ */
+
+#ifndef PLAYERREQUESTS_HPP
+#define	PLAYERREQUESTS_HPP
+
+class PlayerRequests
+{
+public:
+    enum
+    {
+        MOVE_UNIT,
+        ATTACK_UNIT,
+        MANUAL_FIRE,
+        CHANGE_OBJECTIVE_GENERATION,
+        CHANGE_OBJECTIVE_OUTLOC,
+        CHAT,
+        TEAM_CHAT,
+        CHANGE_FLAG,
+        ALLIANCE_REQUEST,
+        BREAK_ALLIANCE,
+        PLAYER_READY,
+        CHANGE_TEAM,
+        STARTSURRENDER_VOTE,
+        VOTE_SELECTED
+    };
+    
+};
+
+#endif	/* PLAYERREQUESTS_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/StartSurrenderVoteRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/StartSurrenderVoteRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/StartSurrenderVoteRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,39 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 21, 2012, 5:14 PM
+ */
+
+#ifndef STARTSURRENDERVOTEREQUEST_HPP
+#define	STARTSURRENDERVOTEREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class StartSurrenderVoteRequest : public NetMessage
+{
+public:
+    StartSurrenderVoteRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::STARTSURRENDER_VOTE;
+    }
+    
+} __attribute__((packed));
+
+#endif	/* STARTSURRENDERVOTEREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/TeamChatRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/TeamChatRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/TeamChatRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,37 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on September 19, 2012, 8:36 PM
+ */
+
+#ifndef TEAMCHATREQUEST_HPP
+#define	TEAMCHATREQUEST_HPP
+
+#include &quot;ChatRequest.hpp&quot;
+
+class TeamChatRequest : public ChatRequest
+{
+public:
+    TeamChatRequest()
+    {
+        message_id = PlayerRequests::TEAM_CHAT;
+    }
+    
+} __attribute__((packed));
+
+#endif	/* TEAMCHATREQUEST_HPP */
+

Added: trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/VoteSelectedRequest.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/VoteSelectedRequest.hpp	                        (rev 0)
+++ trunk/netpanzer/src/NetPanzer/Network/PlayerRequests/VoteSelectedRequest.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -0,0 +1,40 @@
+/*
+Copyright (C) 2012 Netpanzer Team. (www.netpanzer.org), Aaron Perez
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; either version 2 of the License, or
+(at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created on October 1, 2012, 3:25 PM
+ */
+
+#ifndef VOTESELECTEDREQUEST_HPP
+#define	VOTESELECTEDREQUEST_HPP
+
+#include &quot;PlayerRequests.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
+
+class VoteSelectedRequest : public NetMessage
+{
+public:
+    Uint8 vote_selected;
+    VoteSelectedRequest()
+    {
+        message_class = _net_message_class_player_commands;
+        message_id = PlayerRequests::VOTE_SELECTED;
+    }
+    
+} __attribute__((packed));
+
+#endif	/* VOTESELECTEDREQUEST_HPP */
+

Modified: trunk/netpanzer/src/NetPanzer/Objectives/Objective.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Objectives/Objective.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Objectives/Objective.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -33,9 +33,7 @@
 #include &quot;Classes/Network/NetworkState.hpp&quot;
 #include &quot;Classes/Network/UnitNetMessage.hpp&quot;
 #include &quot;Classes/Network/ObjectiveNetMessage.hpp&quot;
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 
-
 Objective::Objective(ObjectiveID id, iXY location, BoundBox area)
 {
     this-&gt;id = id;
@@ -193,12 +191,11 @@
 
             if ( unit != 0 )
             {
-                UnitRemoteCreate create_mesg(unit-&gt;player-&gt;getID(),
+                UnitRemoteCreate create_mesg(unit-&gt;player_id,
                         unit-&gt;id, gen_loc.x, gen_loc.y,
                         unit_generation_type);
                 SERVER-&gt;broadcastMessage(&amp;create_mesg, sizeof(UnitRemoteCreate));
 
-                UMesgAICommand ai_command;
                 PlacementMatrix placement_matrix;
                 iXY collection_loc, loc;
 
@@ -207,9 +204,7 @@
                 placement_matrix.reset( collection_loc );
                 placement_matrix.getNextEmptyLoc( &amp;loc );
 
-                ai_command.setHeader( unit-&gt;id, _umesg_flag_unique );
-                ai_command.setMoveToLoc( loc );
-                UnitInterface::sendMessage( &amp;ai_command );
+                UnitInterface::playerCommand_MoveUnit( unit-&gt;player_id, unit-&gt;id, loc );
             }
         } // ** if
     } // ** if

Modified: trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -37,7 +37,6 @@
 
 #include &quot;Classes/Network/NetMessage.hpp&quot;
 #include &quot;Classes/Network/ObjectiveNetMessage.hpp&quot;
-#include &quot;Classes/Network/TerminalNetMesg.hpp&quot;
 #include &quot;Classes/Network/NetPacket.hpp&quot;
 #include &quot;Classes/Network/NetworkServer.hpp&quot;
 #include &quot;Classes/Network/NetworkClient.hpp&quot;
@@ -47,6 +46,29 @@
 
 #include &quot;Units/UnitProfileInterface.hpp&quot;
 
+#include &quot;Network/PlayerRequests/ChangeObjectiveOutLocationRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp&quot;
+
+class ObjectiveOutLocSync : public ChangeObjectiveOutLocationRequest
+{
+public:
+    ObjectiveOutLocSync()
+    {
+        message_class = _net_message_class_objective;
+        message_id = _net_message_id_objective_outloc_sync;
+    }
+} __attribute__((packed));
+
+class ObjectiveWorkingSync : public ChangeObjectiveGenerationRequest
+{
+public:
+    ObjectiveWorkingSync()
+    {
+        message_class = _net_message_class_objective;
+        message_id = _net_message_id_objective_working_sync;
+    }
+} __attribute__((packed));
+
 Objective** ObjectiveInterface::objective_list = 0;
 int ObjectiveInterface::num_objectives = 0;
 
@@ -180,107 +202,69 @@
     }
 }
 
-/**
- * Only used in server, when received a packet from a player.
- */
 void
-ObjectiveInterface::serverHandleNetPacket(const NetPacket* packet)
+ObjectiveInterface::playerRequest_setGeneration(const PlayerID player_id, const ObjectiveID objective_id, const Uint8 unit_type, const bool active)
 {
-    const PlayerState* player = PlayerInterface::getPlayer(packet-&gt;fromPlayer);
-    if ( !player )
+    if ( objective_id &gt;= num_objectives )
     {
-        LOGGER.warning(&quot;Couldn't find player for packet %u.&quot;,
-                packet-&gt;fromPlayer);
+        LOGGER.warning(&quot;OISH_CGU CHEAT Player %u sent invalid objective_id %u, max is %u&quot;,
+                       player_id, objective_id, num_objectives);
         return;
     }
 
-    const NetMessage* message = packet-&gt;getNetMessage();
+    if ( objective_list[objective_id]-&gt;occupying_player-&gt;getID() != player_id )
+    {
+        LOGGER.warning(&quot;OISH_CGU CHEAT Player %u doesn't own objective %u&quot;,
+                       player_id, objective_id);
+        return;
+    }
 
-    switch(message-&gt;message_id)
+    if ( unit_type &gt;= UnitProfileInterface::getNumUnitTypes() )
     {
-        case _net_message_id_change_generating_unit:
-        {
-            const ObjectiveChangeGeneratingUnit* msg =
-                (const ObjectiveChangeGeneratingUnit*) message;
+        LOGGER.warning(&quot;OISH_CGU CHEAT Player %u sent invalid unit type %u, max is %u&quot;,
+                       player_id,
+                       unit_type,
+                       UnitProfileInterface::getNumUnitTypes());
+        return;
+    }
 
-            ObjectiveID obj_id = msg-&gt;getObjectiveId();
-            if ( obj_id &gt;= num_objectives )
-            {
-                LOGGER.warning(&quot;OISH_CGU CHEAT Player %u sent invalid objective_id %u, max is %u&quot;,
-                               player-&gt;getID(), obj_id, num_objectives);
-                break;
-            }
+    objective_list[objective_id]-&gt;changeUnitGeneration(active, unit_type);
 
-            if ( objective_list[obj_id]-&gt;occupying_player != player )
-            {
-                LOGGER.warning(&quot;OISH_CGU CHEAT Player %u doesn't own objective %u&quot;,
-                               player-&gt;getID(),
-                               obj_id);
-                break;
-            }
+    ObjectiveWorkingSync msg;
+    msg.setObjectiveId(objective_id);
+    msg.unit_type = unit_type;
+    msg.unit_gen_on = active;
+    
+    SERVER-&gt;sendMessage(player_id, &amp;msg, sizeof(msg));
+}
 
-            if ( msg-&gt;unit_type &gt;= UnitProfileInterface::getNumUnitTypes() )
-            {
-                LOGGER.warning(&quot;OISH_CGU CHEAT Player %u sent invalid unit type %u, max is %u&quot;,
-                               player-&gt;getID(),
-                               msg-&gt;unit_type,
-                               UnitProfileInterface::getNumUnitTypes());
-                break;
-            }
 
-            objective_list[obj_id]-&gt;changeUnitGeneration(msg-&gt;unit_gen_on, msg-&gt;unit_type);
+void ObjectiveInterface::playerRequest_setOutputLoc(const PlayerID player_id, const ObjectiveID objective_id, const iXY&amp; location)
+{
+    if ( objective_id &gt;= num_objectives )
+    {
+        LOGGER.warning(&quot;OISH_COL CHEAT Player %u sent invalid objective_id %u, max is %u&quot;,
+                       player_id, objective_id, num_objectives);
+        return;
+    }
 
-            if ( packet-&gt;fromClient )
-            {
-                packet-&gt;fromClient-&gt;sendMessage(msg, sizeof(ObjectiveChangeGeneratingUnit));
-            }
+    if ( location.x &gt;= MapInterface::getWidth()
+         || location.y &gt;= MapInterface::getHeight() )
+    {
+        LOGGER.warning(&quot;OISH_COL CHEAT Player %u sent invalid map location %u,%u; max is %u,%u&quot;,
+                       player_id,
+                       location.x, location.y,
+                       (unsigned int)MapInterface::getWidth(),
+                       (unsigned int)MapInterface::getHeight());
+        return;
+    }
 
-            break;
-        }
+    objective_list[objective_id]-&gt;unit_collection_loc = location;
 
-        case _net_message_id_change_output_location:
-        {
-            const ObjectiveChangeOutputLocation* msg =
-                (const ObjectiveChangeOutputLocation*) message;
-
-            ObjectiveID obj_id = msg-&gt;getObjectiveId();
-            if ( obj_id &gt;= num_objectives )
-            {
-                LOGGER.warning(&quot;OISH_COL CHEAT Player %u sent invalid objective_id %u, max is %u&quot;,
-                               player-&gt;getID(), obj_id, num_objectives);
-                break;
-            }
-
-            Uint32 map_x = msg-&gt;getMapX();
-            Uint32 map_y = msg-&gt;getMapY();
-
-            if ( map_x &gt;= MapInterface::getWidth()
-                 || map_y &gt;= MapInterface::getHeight() )
-            {
-                LOGGER.warning(&quot;OISH_COL CHEAT Player %u sent invalid map location %u,%u; max is %u,%u&quot;,
-                               player-&gt;getID(),
-                               map_x, map_y,
-                               (unsigned int)MapInterface::getWidth(),
-                               (unsigned int)MapInterface::getHeight());
-                break;
-            }
-
-            objective_list[obj_id]-&gt;unit_collection_loc.x = map_x;
-            objective_list[obj_id]-&gt;unit_collection_loc.y = map_y;
-
-            if ( packet-&gt;fromClient )
-            {
-                packet-&gt;fromClient-&gt;sendMessage(msg, sizeof(ObjectiveChangeOutputLocation));
-            }
-
-            break;
-        }
-
-        default:
-            LOGGER.warning(&quot;OISH CHEAT Player %u sent unknown message type %u&quot;,
-                           player-&gt;getID(),
-                           message-&gt;message_id);
-    }
+    ObjectiveOutLocSync msg;
+    msg.setObjectiveId(objective_id);
+    msg.setMapPos(location);
+    SERVER-&gt;sendMessage(player_id, &amp;msg, sizeof(msg));
 }
 
 void
@@ -345,10 +329,10 @@
             break;
         }
 
-        case _net_message_id_change_generating_unit:
+        case _net_message_id_objective_working_sync:
         {
-            const ObjectiveChangeGeneratingUnit* msg =
-                (const ObjectiveChangeGeneratingUnit*) message;
+            const ObjectiveWorkingSync* msg =
+                (const ObjectiveWorkingSync*) message;
 
             ObjectiveID obj_id = msg-&gt;getObjectiveId();
             if ( obj_id &gt;= num_objectives )
@@ -371,10 +355,10 @@
             break;
         }
 
-        case _net_message_id_change_output_location:
+        case _net_message_id_objective_outloc_sync:
         {
-            const ObjectiveChangeOutputLocation* msg =
-                (const ObjectiveChangeOutputLocation*) message;
+            const ObjectiveOutLocSync* msg =
+                (const ObjectiveOutLocSync*) message;
 
             ObjectiveID obj_id = msg-&gt;getObjectiveId();
             if ( obj_id &gt;= num_objectives )
@@ -384,22 +368,19 @@
                 break;
             }
 
-            Uint32 map_x = msg-&gt;getMapX();
-            Uint32 map_y = msg-&gt;getMapY();
-
-            if ( map_x &gt;= MapInterface::getWidth()
-                 || map_y &gt;= MapInterface::getHeight() )
+            iXY location = msg-&gt;getMapPos();
+            
+            if ( location.x &gt;= MapInterface::getWidth()
+                 || location.y &gt;= MapInterface::getHeight() )
             {
                 LOGGER.warning(&quot;OICH_COL CHEAT SERVER sent invalid map location %u,%u; max is %u,%u&quot;,
-                               map_x, map_y,
+                               location.x, location.y,
                                (unsigned int)MapInterface::getWidth(),
                                (unsigned int)MapInterface::getHeight());
                 break;
             }
 
-            objective_list[obj_id]-&gt;unit_collection_loc.x = msg-&gt;getMapX();
-            objective_list[obj_id]-&gt;unit_collection_loc.y = msg-&gt;getMapY();
-
+            objective_list[obj_id]-&gt;unit_collection_loc = location;
             break;
         }
         
@@ -410,30 +391,6 @@
 }
 
 void
-ObjectiveInterface::sendChangeGeneratingUnit(ObjectiveID objective_id, Uint8 unit_type, bool active)
-{
-    if ( objective_id &lt; num_objectives &amp;&amp; unit_type &lt; UnitProfileInterface::getNumUnitTypes() )
-    {
-        ObjectiveChangeGeneratingUnit msg;
-        msg.set( objective_id, unit_type, active );
-        CLIENT-&gt;sendMessage(&amp;msg, sizeof(msg));
-    }
-}
-
-void
-ObjectiveInterface::sendChangeOutputLocation(ObjectiveID objective_id, Uint32 map_x, Uint32 map_y)
-{
-    if ( objective_id &lt; num_objectives
-         &amp;&amp; map_x &lt; MapInterface::getWidth()
-         &amp;&amp; map_y &lt; MapInterface::getHeight() )
-    {
-        ObjectiveChangeOutputLocation msg;
-        msg.set( objective_id, map_x, map_y );
-        CLIENT-&gt;sendMessage(&amp;msg, sizeof(msg));
-    }
-}
-
-void
 ObjectiveInterface::updateObjectiveStatus()
 {
     for ( int i = 0; i &lt; num_objectives; ++i )

Modified: trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Objectives/ObjectiveInterface.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -42,12 +42,11 @@
 
     static void loadObjectiveList( const char *file_path );
 
-    static void serverHandleNetPacket(const NetPacket* packet);
+    static void playerRequest_setGeneration(const PlayerID player_id, const ObjectiveID objective_id, const Uint8 unit_type, const bool active);
+    static void playerRequest_setOutputLoc(const PlayerID player_id, const ObjectiveID objective_id, const iXY&amp; location);
+    
     static void clientHandleNetMessage(const NetMessage* message);
 
-    static void sendChangeGeneratingUnit(ObjectiveID objective_id, Uint8 unit_type, bool active);
-    static void sendChangeOutputLocation(ObjectiveID objective_id, Uint32 map_x, Uint32 map_y);
-
     static void updateObjectiveStatus();
 
     static void disownPlayerObjectives(PlayerID player_id);

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -46,7 +46,7 @@
 
     sound-&gt;playPowerUpSound();
 
-    PlayerID own_player = UnitInterface::getUnit(unit_id)-&gt;player-&gt;getID();
+    PlayerID own_player = UnitInterface::getUnit(unit_id)-&gt;player_id;
 
     placement_matrix.reset( map_loc );
 
@@ -64,7 +64,7 @@
 
         if ( new_unit != 0 )
         {
-            UnitRemoteCreate create_mesg(new_unit-&gt;player-&gt;getID(),
+            UnitRemoteCreate create_mesg(new_unit-&gt;player_id,
                     new_unit-&gt;id, spawn_loc.x, spawn_loc.y, bonus_unit_type);
             SERVER-&gt;broadcastMessage( &amp;create_mesg, sizeof( UnitRemoteCreate ));
         }

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -66,13 +66,13 @@
 
     UnitBase* unit = UnitInterface::getUnit(unit_id);
 
-    if(unit-&gt;player == PlayerInterface::getLocalPlayer())
+    if(unit-&gt;player_id == PlayerInterface::getLocalPlayerIndex())
     {
         ActivateRadar();
     }
 
     PowerUpHitMesg hit_mesg;
-    hit_mesg.set( ID, unit-&gt;player-&gt;getID());
+    hit_mesg.set( ID, unit-&gt;player_id);
     SERVER-&gt;broadcastMessage( &amp;hit_mesg, sizeof( PowerUpHitMesg ));
 
     life_cycle_state = _power_up_lifecycle_state_inactive;

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -21,7 +21,6 @@
 #include &lt;stdlib.h&gt;
 #include &quot;Units/UnitTypes.hpp&quot;
 #include &quot;Units/UnitInterface.hpp&quot;
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 #include &quot;Interfaces/PlayerInterface.hpp&quot;
 #include &quot;Interfaces/MapInterface.hpp&quot;
 #include &quot;Interfaces/ConsoleInterface.hpp&quot;
@@ -100,9 +99,7 @@
 
 void UnitPowerUp::powerUpDestruct( UnitID unit_id )
 {
-    UMesgSelfDestruct self_destruct;
-    self_destruct.setHeader( unit_id, _umesg_flag_unique );
-    UnitInterface::sendMessage( &amp;self_destruct );
+    UnitInterface::selfDestructUnit( unit_id );
 }
 
 static const char * powerupTypeToString( int type )
@@ -172,12 +169,12 @@
     }
 
     PowerUpHitMesg hit_mesg;
-    hit_mesg.set(ID, unit-&gt;player-&gt;getID(), unit_powerup_type);
+    hit_mesg.set(ID, unit-&gt;player_id, unit_powerup_type);
     SERVER-&gt;broadcastMessage(&amp;hit_mesg, sizeof(PowerUpHitMesg));
 
     life_cycle_state = _power_up_lifecycle_state_inactive;
 
-    if(unit-&gt;player == PlayerInterface::getLocalPlayer())
+    if(unit-&gt;player_id == PlayerInterface::getLocalPlayerIndex())
     {
         ConsoleInterface::postMessage(Color::unitAqua, false, 0, &quot;YOU GOT A %s POWERUP&quot;, 
                                       powerupTypeToString( unit_powerup_type ) );

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitBase.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitBase.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitBase.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -21,7 +21,6 @@
 #include &quot;Core/CoreTypes.hpp&quot;
 #include &quot;Units/UnitState.hpp&quot;
 
-class UnitMessage;
 class UnitOpcode;
 class SpriteSorter;
 class PlayerState;
@@ -29,26 +28,29 @@
 class UnitBase
 {
 public:
-    PlayerState* player;
+    PlayerID     player_id;
     UnitID       id;
     UnitState    unit_state;
     bool         in_sync_flag;
 
-    UnitBase(PlayerState* newPlayer, UnitID newId)
-        : player(newPlayer), id(newId)
+    UnitBase(PlayerID player_id, UnitID newId)
+        : player_id(player_id), id(newId)
     { }
     virtual ~UnitBase()
     { }
 
-    virtual void processMessage(const UnitMessage* ) = 0;
     virtual void evalCommandOpcode(const UnitOpcode* ) = 0;
     virtual void updateState() = 0;
     virtual void syncUnit() = 0;
     virtual void offloadGraphics(SpriteSorter&amp; ) = 0;
     virtual void soundSelected() = 0;
     
-    virtual void weaponHit(const UnitID from_unit, const Uint16 damage_factor) = 0;
-
+    virtual void moveToLoc(const iXY&amp; loc) = 0;
+    virtual void attackUnit(const UnitID unit_id) = 0;
+    virtual void manualShoot(const iXY&amp; loc) = 0;
+    
+    virtual bool weaponHit(const UnitID from_unit, const Uint16 damage_factor) = 0;
+    virtual void selfDestruct() = 0;
     bool isWeaponInRange(const iXY&amp; loc) const
     {
         int x = loc.x - unit_state.location.x;

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -37,17 +37,14 @@
 #include &quot;Interfaces/Console.hpp&quot;
 #include &quot;Units/UnitOpcodeDecoder.hpp&quot;
 
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 #include &quot;Classes/Network/PlayerNetMessage.hpp&quot;
 #include &quot;Classes/Network/NetPacket.hpp&quot;
-#include &quot;Classes/Network/TerminalNetMesg.hpp&quot;
 
 #include &quot;System/Sound.hpp&quot;
 #include &quot;Particles/ParticleInterface.hpp&quot;
 #include &quot;Util/Log.hpp&quot;
 #include &quot;UnitBlackBoard.hpp&quot;
 
-
 //UnitList * UnitInterface::unit_lists;
 UnitInterface::Units UnitInterface::units;
 UnitInterface::PlayerUnitList* UnitInterface::playerUnitLists = 0;
@@ -119,60 +116,44 @@
 }
 
 void
-UnitInterface::processNetPacket(const NetPacket* packet)
+UnitInterface::playerCommand_MoveUnit(const PlayerID player_id, const UnitID unit_id, const iXY&amp; destination)
 {
-    const NetMessage* message = packet-&gt;getNetMessage();
-    const TerminalUnitCmdRequest* terminal_command =
-        (const TerminalUnitCmdRequest*) message;
-
-    const PlayerState* player 
-        = PlayerInterface::getPlayer(packet-&gt;fromPlayer);
-    if(player == 0)
+    UnitBase * unit = getUnit(unit_id);
+    
+    if ( unit )
     {
-        LOGGER.warning(&quot;UnitInterface: Player not found '%u'?!?&quot;,
-                packet-&gt;fromPlayer);
-        return;
+        if ( unit-&gt;player_id == player_id )
+        {
+            unit-&gt;moveToLoc(destination);
+        }
     }
+}
+
+void
+UnitInterface::playerCommand_AttackUnit(const PlayerID player_id, const UnitID unit_id, const UnitID enemy_id)
+{
+    UnitBase * unit = getUnit(unit_id);
     
-    sendMessage(&amp;(terminal_command-&gt;comm_request) , player);
+    if ( unit )
+    {
+        if ( unit-&gt;player_id == player_id )
+        {
+            unit-&gt;attackUnit(unit_id);
+        }
+    }
 }
 
 void
-UnitInterface::sendMessage(const UnitMessage* message,const PlayerState* player)
+UnitInterface::playerCommand_ManualShoot(const PlayerID player_id, const UnitID unit_id, const iXY&amp; world_point)
 {
-    if (message-&gt;isFlagged(_umesg_flag_unique)) {
-        UnitBase* unit = getUnit(message-&gt;getUnitID());
-        if(unit == 0)
-            return;
-        if(player &amp;&amp; unit-&gt;player != player) {
-            LOGGER.warning(
-                &quot;Terminal request for unit (%u) not owned by player (%u).\n&quot;,
-                unit-&gt;id, player-&gt;getID());
-            return;
+    UnitBase * unit = getUnit(unit_id);
+    
+    if ( unit )
+    {
+        if ( unit-&gt;player_id == player_id )
+        {
+            unit-&gt;manualShoot(world_point);
         }
-                    
-        unit-&gt;processMessage(message);
-    } else if (message-&gt;isFlagged( _umesg_flag_broadcast) ) {
-        if(message-&gt;message_id != _umesg_weapon_hit) {
-            LOGGER.warning(&quot;Broadcast flag only allowed for weapon hit.&quot;);
-            if(player) {
-                LOGGER.warning(&quot;from player %u.\n&quot;, player-&gt;getID());
-            }
-            return;
-        }
-            
-        for(Units::iterator i = units.begin(); i != units.end(); ++i) {
-            UnitBase* unit = i-&gt;second;
-            unit-&gt;processMessage(message);
-        }
-    } else if (message-&gt;isFlagged( _umesg_flag_manager_request) ) {
-        if(player) {
-            LOGGER.warning(
-                    &quot;UnitManagerMessage sent out by player %u not allowed.&quot;,
-                    player-&gt;getID());
-            return;
-        }
-  	processManagerMessage(message);
     }
 }
 
@@ -194,7 +175,7 @@
     unit_bucket_array.deleteUnitBucketPointer(unit-&gt;id, 
             unit-&gt;unit_state.location );
     PlayerUnitList&amp; plist =
-        playerUnitLists[unit-&gt;player-&gt;getID()];
+        playerUnitLists[unit-&gt;player_id];
     
     PlayerUnitList::iterator pi
         = std::find(plist.begin(), plist.end(), unit);
@@ -310,7 +291,7 @@
 {
     units.insert(std::make_pair(unit-&gt;id, unit));
    
-    Uint16 player_index = unit-&gt;player-&gt;getID();
+    Uint16 player_index = unit-&gt;player_id;
     playerUnitLists[player_index].push_back(unit);
 
     unit_bucket_array.addUnit(unit);
@@ -399,7 +380,7 @@
             unit_placement_matrix.getNextEmptyLoc( &amp;next_loc );
             unit = createUnit(unit_type_index, next_loc, player_id);
             if (unit == 0) return;
-            UnitRemoteCreate create_mesg(unit-&gt;player-&gt;getID(), unit-&gt;id,
+            UnitRemoteCreate create_mesg(unit-&gt;player_id, unit-&gt;id,
                     next_loc.x, next_loc.y, unit-&gt;unit_state.unit_type);
             if ( !encoder.encodeMessage(&amp;create_mesg, sizeof(create_mesg)) )
             {
@@ -431,10 +412,10 @@
             continue;
 
         if(search_flags == _search_exclude_player
-                &amp;&amp; unit-&gt;player-&gt;getID() == player_id)
+                &amp;&amp; unit-&gt;player_id == player_id)
             continue;
         if(search_flags == _search_player
-                &amp;&amp; unit-&gt;player-&gt;getID() != player_id)
+                &amp;&amp; unit-&gt;player_id != player_id)
             continue;
 
         working_list.push_back(unit-&gt;id);
@@ -453,10 +434,10 @@
             continue;
 
         if(search_flags == _search_exclude_player
-                &amp;&amp; unit-&gt;player-&gt;getID() == player_id)
+                &amp;&amp; unit-&gt;player_id == player_id)
             continue;
         if(search_flags == _search_player
-                &amp;&amp; unit-&gt;player-&gt;getID() != player_id)
+                &amp;&amp; unit-&gt;player_id != player_id)
             continue;
 
         working_list.push_back(unit-&gt;id);
@@ -466,7 +447,7 @@
 PlayerState *
 UnitInterface::querySinglePlayerInArea(const iRect&amp; rect)
 {
-    PlayerState* player = 0;
+    PlayerID player_id = INVALID_PLAYER_ID;
     for ( Units::iterator i = units.begin(); i != units.end(); ++i )
     {
         UnitBase* unit = i-&gt;second;
@@ -475,13 +456,13 @@
             continue;
         }
 
-        if ( player &amp;&amp; unit-&gt;player != player )
+        if ( player_id != INVALID_PLAYER_ID &amp;&amp; unit-&gt;player_id != player_id )
         {
             return 0;
         }
-        player = unit-&gt;player;
+        player_id = unit-&gt;player_id;
     }
-    return player;
+    return (player_id == INVALID_PLAYER_ID) ? 0 : PlayerInterface::getPlayer(player_id);
 }
 
 /****************************************************************************/
@@ -497,10 +478,10 @@
         UnitBase* unit = i-&gt;second;
 
         if(search_flags == _search_exclude_player
-                &amp;&amp; unit-&gt;player-&gt;getID() == player_id)
+                &amp;&amp; unit-&gt;player_id == player_id)
             continue;
         if(search_flags == _search_player
-                &amp;&amp; unit-&gt;player-&gt;getID() != player_id)
+                &amp;&amp; unit-&gt;player_id != player_id)
             continue;
 
         iXY delta;
@@ -588,7 +569,7 @@
 
     for(Units::iterator i = units.begin(); i != units.end(); ++i) {
         UnitBase* unit = i-&gt;second;
-        PlayerID unitPlayerID = unit-&gt;player-&gt;getID();
+        PlayerID unitPlayerID = unit-&gt;player_id;
         
         if(unitPlayerID == player_index
                 || PlayerInterface::isAllied(player_index, unitPlayerID) // XXX ALLY
@@ -639,11 +620,11 @@
     if(!unit) {
         return _no_unit_found;
     }
-    if(unit-&gt;player-&gt;getID() == player_id) {
+    if(unit-&gt;player_id == player_id) {
         return _unit_player;
     }
     // XXX ALLY
-    if(PlayerInterface::isAllied(player_id, unit-&gt;player-&gt;getID())) {
+    if(PlayerInterface::isAllied(player_id, unit-&gt;player_id)) {
         return _unit_allied;
     }
 
@@ -672,63 +653,47 @@
 
 // ******************************************************************
 
-void UnitInterface::processManagerMessage(const UnitMessage* message)
+void UnitInterface::unitKilled(const UnitBase* unit, const UnitID killer)
 {
-    switch(message-&gt;message_id) {
-        case _umesg_end_lifecycle:
-            unitManagerMesgEndLifecycle(message);
-            break;
-        default:
-            LOGGER.warning(&quot;Unknown unit Manage Message type (%u).&quot;,
-                    message-&gt;message_id);
-#ifdef DEBUG
-            assert(false);
-#endif
-    }
-}
-
-// ******************************************************************
-
-void UnitInterface::unitManagerMesgEndLifecycle(const UnitMessage* message)
-{
-    const UMesgEndLifeCycleUpdate *lifecycle_update
-        = (const UMesgEndLifeCycleUpdate *) message;
-
-    UnitBase* unit1 = getUnit(lifecycle_update-&gt;getDestroyer());
-    UnitBase* unit2 = getUnit(lifecycle_update-&gt;getDestroyed());
-    if(unit1 == 0 || unit2 == 0) {
+    UnitBase* unit2 = getUnit(killer);
+    if ( ! unit2 )
+    {
         LOGGER.warning(
-                &quot;Unit in EndLifeCycle message doesn't exist anymore&quot;
-                &quot;(u1: %u u2: %u)&quot;, lifecycle_update-&gt;getDestroyer(),
-                lifecycle_update-&gt;getDestroyed());
+                &quot;Killer Unit in EndLifeCycle message doesn't exist anymore(u1: %u u2: %u)&quot;,
+                unit-&gt;id, killer);
         return;
     }
-    PlayerState* player1 = unit1-&gt;player;
-    PlayerState* player2 = unit2-&gt;player;
+    
+    PlayerState* player1 = PlayerInterface::getPlayer(unit-&gt;player_id);
+    PlayerState* player2 = PlayerInterface::getPlayer(unit2-&gt;player_id);
 
-    int unittype1 = unit1-&gt;unit_state.unit_type;
-    const std::string&amp; unitname1 = 
-        UnitProfileInterface::getUnitProfile(unittype1)-&gt;unitname;
+    int unittype1 = unit-&gt;unit_state.unit_type;
+    const std::string&amp; unitname1 = UnitProfileInterface::getUnitProfile(unittype1)-&gt;unitname;
+    
     int unittype2 = unit2-&gt;unit_state.unit_type;
-    const std::string&amp; unitname2 =
-        UnitProfileInterface::getUnitProfile(unittype2)-&gt;unitname;
-    if(Console::server) {
+    const std::string&amp; unitname2 = UnitProfileInterface::getUnitProfile(unittype2)-&gt;unitname;
+    
+    if(Console::server)
+    {
         *Console::server &lt;&lt; &quot;'&quot; &lt;&lt; player1-&gt;getName() &lt;&lt; &quot;' killed a '&quot;
             &lt;&lt; unitname2 &lt;&lt; &quot;' from '&quot; &lt;&lt; player2-&gt;getName() 
             &lt;&lt; &quot;' with his '&quot; &lt;&lt; unitname1 &lt;&lt; &quot;'.&quot; &lt;&lt; std::endl;
     }
 
     // killing team own units doesn't give score
-    if (GameConfig::game_teammode &amp;&amp; (player1-&gt;getTeamID() == player2-&gt;getTeamID())) return;
+    if (GameConfig::game_teammode &amp;&amp; (player1-&gt;getTeamID() == player2-&gt;getTeamID()))
+    {
+        return;
+    }
+    
     // killing own units doesn't give score
-    if( (player1 != player2) ) 
+    if( player1 != player2 ) 
     {
-        PlayerInterface::setKill(unit1-&gt;player, unit2-&gt;player,
-                (UnitType) lifecycle_update-&gt;unit_type);
+        PlayerInterface::setKill(player1, player2, (UnitType) unittype1);
         
         PlayerScoreUpdate score_update;
-        score_update.set(player1-&gt;getID(), player2-&gt;getID(),
-                (UnitType) lifecycle_update-&gt;unit_type);
+        score_update.set(player1-&gt;getID(), player2-&gt;getID(), (UnitType) unittype1);
+        
         SERVER-&gt;broadcastMessage(&amp;score_update, sizeof(PlayerScoreUpdate));
     }
 }
@@ -835,16 +800,23 @@
 
 // ******************************************************************
 
-void UnitInterface::destroyPlayerUnits(PlayerID player_id)
+void UnitInterface::selfDestructUnit(const UnitID unit_id)
 {
-    UMesgSelfDestruct self_destruct;
-    self_destruct.setHeader(0, _umesg_flag_unique);
+    UnitBase * unit = getUnit(unit_id);
+    if ( unit )
+    {
+        unit-&gt;selfDestruct();
+    }
+}
 
+void UnitInterface::destroyPlayerUnits(PlayerID player_id)
+{
     PlayerUnitList&amp; unitlist = playerUnitLists[player_id];
     for(PlayerUnitList::iterator i = unitlist.begin();
-            i != unitlist.end(); ++i) {
+            i != unitlist.end(); ++i)
+    {
         UnitBase* unit = *i;
-        unit-&gt;processMessage(&amp;self_destruct);
+        unit-&gt;selfDestruct();
     }
 }
 
@@ -857,7 +829,10 @@
         UnitBase* unit = i-&gt;second;
         if ( unit-&gt;unit_state.bounds(location) )
         {
-            unit-&gt;weaponHit( from_unit, damage_factor);
+            if ( unit-&gt;weaponHit( from_unit, damage_factor) )
+            {
+                unitKilled(unit, from_unit);
+            }
         }
     }
 }

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -21,7 +21,6 @@
 #include &lt;vector&gt;
 #include &lt;map&gt;
 #include &quot;Units/UnitBucketArray.hpp&quot;
-#include &quot;Classes/UnitMessage.hpp&quot;
 #include &quot;Classes/PlayerState.hpp&quot;
 #include &quot;Util/Timer.hpp&quot;
 #include &quot;Classes/PlacementMatrix.hpp&quot;
@@ -103,11 +102,8 @@
     static UnitBase* getUnit(UnitID unit_id);
 
     static void weaponHit(const UnitID from_unit, const iXY&amp; location, const Uint16 damage_factor);
-    
-    static void processNetPacket(const NetPacket* packet);
-    static void sendMessage(const UnitMessage* message,
-            const PlayerState* player = 0);
-
+    static void selfDestructUnit(const UnitID unit_id);
+        
     static void updateUnitStatus();
 
     static void offloadGraphics( SpriteSorter &amp;sorter );
@@ -148,9 +144,7 @@
     static unsigned char queryUnitLocationStatus( iXY loc );
 
 protected:
-    // Unit Message Handler Methods
-    static void processManagerMessage(const UnitMessage *message);
-    static void unitManagerMesgEndLifecycle(const UnitMessage *message);
+    static void unitKilled(const UnitBase* unit, const UnitID killer);
 
 protected:
     friend class Vehicle;
@@ -183,6 +177,11 @@
 public:
     static void processNetMessage(const NetMessage *net_message, size_t size);
     static void destroyPlayerUnits(PlayerID player_id);
+    
+    static void playerCommand_MoveUnit    (const PlayerID player_id, const UnitID unit_id, const iXY&amp; destination);
+    static void playerCommand_AttackUnit  (const PlayerID player_id, const UnitID unit_id, const UnitID enemy_id);
+    static void playerCommand_ManualShoot (const PlayerID player_id, const UnitID unit_id, const iXY&amp; world_point);
+    
 };
 
 #endif // ** _UNITINTERFACE_HPP

Modified: trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Units/Vehicle.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -16,6 +16,7 @@
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
 
+#include &quot;Vehicle.hpp&quot;
 
 #include &lt;stdexcept&gt;
 
@@ -72,8 +73,10 @@
 
 enum{ _rotate_and_move, _rotate_stop_move };
 
+enum { PENDING_COMMAND_MOVE, PENDING_COMMAND_ATTACK };
+
 Vehicle::Vehicle(PlayerState* player, unsigned char utype, UnitID id, iXY initial_loc)
-    : UnitBase(player, id)
+    : UnitBase(player-&gt;getID(), id)
 {
     smolderWait    = 0.0f;
     smolderWaitMin = 0.0f;
@@ -97,8 +100,6 @@
     body_anim_shadow.setDrawModeBlend(&amp;Palette::colorTableDarkenALot);
     turret_anim_shadow.setDrawModeBlend(&amp;Palette::colorTableDarkenALot);
 
-    path_generated = false;
-    critical_ai_section = false;
     ai_fsm_transition_complete = false;
 
     reload_counter = 0;
@@ -112,8 +113,6 @@
     fsmTurretRotate_rotation = 0;
     fsmTurretRotate_goal_angle = 0;
 
-    interpolation_speed = 0;
-    fsmMove_first_stamp = false;
     fsmMove_offset_x = fsmMove_offset_y = 0;
     fsmMove_moves_counter = 0;
     fsmMove_moves_per_square = 0;
@@ -412,46 +411,12 @@
     orientationToOffset( orientation, &amp;fsmMove_offset_x, &amp;fsmMove_offset_y );
     fsmMove_moves_counter = 0;
     fsmMove_moves_per_square = 32 / unit_state.speed_factor;
-    /*
-    fsmMove_moves_per_square = 32;
-    interpolation_speed = unit_state.speed_rate * unit_state.speed_factor;
-    if ( NetworkState::status == _network_state_client )
-     { interpolation_speed += 2; }
-    fsmMove_first_stamp = true;
-    */
 }
 
 bool Vehicle::fsmMove()
 {
-    /*
-    long move_offset;
-
-    if( fsmMove_first_stamp == true )
-       {
-        start_move_stamp = now();
-        fsmMove_first_stamp = false;
-       }
-
-    end_move_stamp = now();
-
-    move_offset = (end_move_stamp - start_move_stamp) * interpolation_speed;
-
-    if( (move_offset + fsmMove_moves_counter) &gt; fsmMove_moves_per_square )
-     {
-      move_offset = fsmMove_moves_per_square - fsmMove_moves_counter;
-     }
-    */
-
     if ( fsmMove_moves_counter &lt; fsmMove_moves_per_square )
     {
-        /*
-        fsmMove_moves_counter += move_offset;
-
-        unit_state.location.x = unit_state.location.x + ( move_offset * fsmMove_offset_x );
-
-        unit_state.location.y = unit_state.location.y + ( move_offset * fsmMove_offset_y );
-        */
-
         fsmMove_moves_counter++;
 
         unit_state.location.x = unit_state.location.x + ( unit_state.speed_factor * fsmMove_offset_x );
@@ -459,12 +424,10 @@
         unit_state.location.y = unit_state.location.y + ( unit_state.speed_factor * fsmMove_offset_y );
 
         ParticleInterface::addMoveDirtPuff(unit_state);
-        //start_move_stamp = now();
     }
 
     if( fsmMove_moves_counter &gt;= fsmMove_moves_per_square)
     {
-        //fsmMove_first_stamp = true;
         fsm_timer.changeRate( 10 );
         return( true );
     }
@@ -490,7 +453,6 @@
         fsmMoveMapSquare_movement_type = _rotate_stop_move;
 
     fsm_active_list[ _control_move_map_square ] = true;
-    critical_ai_section = true;
 
     if ( NetworkState::status == _network_state_server )
     {
@@ -533,7 +495,6 @@
                 if ( fsmMove() )
                 {
                     fsm_active_list[ _control_move_map_square ] = false;
-                    critical_ai_section = false;
 
                     if ( move_opcode_sent == false &amp;&amp; NetworkState::status == _network_state_server )
                     {
@@ -553,7 +514,6 @@
             if ( fsmMove() )
             {
                 fsm_active_list[ _control_move_map_square ] = false;
-                critical_ai_section = false;
 
                 if ( move_opcode_sent == false &amp;&amp; NetworkState::status == _network_state_server )
                 {
@@ -725,20 +685,6 @@
     }
 }
 
-
-
-void Vehicle::setFsmGunneryLocation(const iXY&amp; target )
-{
-    if ( fsm_active_list[ _control_gunnery_target ] == true )
-    {
-        clearFsmGunneryTarget();
-    }
-
-    fsmGunneryLocation_target = target;
-    setFsmTurretTrackPoint( target );
-    fsm_active_list[ _control_gunnery_location ] = true;
-}
-
 void Vehicle::clearFsmGunneryLocation()
 {
     fsm_active_list[ _control_gunnery_location ] = false;
@@ -853,16 +799,12 @@
             // *************************************************************
             case _aiFsmMoveToLoc_path_generate :
             {
-                // QueryPath: Has a path been generated for unit ?
-                path_generated = PathScheduler::queryPath(id);
-
-
                 if ( external_ai_event == _external_event_pending_unit_destruct  )
                 {
                     // External Event: This unit is about to be deleted
                     // Action : Exit fsm gracefully
                     aiFsmMoveToLoc_OnExitCleanUp();
-
+                    
                     iXY current_map_loc;
                     MapInterface::pointXYtoMapXY( unit_state.location, current_map_loc );
                     UnitBlackBoard::unmarkUnitLoc( current_map_loc );
@@ -881,7 +823,7 @@
                     end_cycle = true;
                     return;
                 }
-                else if ( path_generated == true )
+                else if ( PathScheduler::queryPath(id) )
                 {
                     // Rule QueryPath: is true move to next state
                     //LOG( (&quot;Path Successfully Generated&quot;) );
@@ -1155,9 +1097,6 @@
 
             case _aiFsmAttackUnit_path_generate :
             {
-                // QueryPath: Has a path been generated for unit ?
-                path_generated = PathScheduler::queryPath(id);
-
                 if ( external_ai_event == _external_event_pending_unit_destruct )
                 {
                     // External Event: This unit is about to be deleted
@@ -1182,7 +1121,7 @@
                     end_cycle = true;
                     return;
                 }
-                else if ( path_generated == true )
+                else if ( PathScheduler::queryPath(id) )
                 {
                     // Rule QueryPath: is true move to next state
                     aiFsmAttackUnit_state = _aiFsmAttackUnit_range_check;
@@ -1499,7 +1438,7 @@
                 {
                     if (UnitInterface::queryClosestEnemyUnit(
                                 &amp;target_unit_ptr, unit_state.location,
-                                player-&gt;getID() ) )
+                                player_id ) )
                     {
                         target_unit_state = &amp;(target_unit_ptr-&gt;unit_state);
                         range_vector = target_unit_state-&gt;location - unit_state.location;
@@ -1596,100 +1535,6 @@
 
 }
 
-
-
-
-
-void Vehicle::aiFsmManualMove()
-{
-    bool end_cycle = false;
-    signed char offset_x = 0, offset_y = 0;
-    size_t next_square;
-
-    do
-    {
-        switch( aiFsmManualMove_state )
-        {
-            case _aiFsmManualMove_next_move :
-            {
-                aiFsmManualMove_prev_loc = aiFsmManualMove_next_loc;
-                orientationToOffset( aiFsmManualMove_move_orientation, &amp;offset_x, &amp;offset_y );
-                aiFsmManualMove_next_loc.x += offset_x;
-                aiFsmManualMove_next_loc.y += offset_y;
-                next_square = MapInterface::mapXYtoOffset(aiFsmManualMove_next_loc);
-
-                if ( MapInterface::getMovementValue( aiFsmManualMove_next_loc ) == 0xFF )
-                {
-                    setAiFsmDefendHold();
-                    end_cycle = true;
-                    return;
-                }
-                else if( UnitBlackBoard::unitOccupiesLoc( aiFsmManualMove_next_loc ) == true )
-                {
-                    setAiFsmDefendHold();
-                    end_cycle = true;
-                    return;
-                }
-                else
-                {
-                    UnitBlackBoard::markUnitLoc( aiFsmManualMove_next_loc );
-                    setFsmMoveMapSquare( next_square );
-                    aiFsmManualMove_state = _aiFsmManualMove_move_wait;
-                }
-            }
-            break;
-
-            // *************************************************************
-
-            case _aiFsmManualMove_move_wait :
-            {
-                if ( fsm_active_list[ _control_move_map_square ] == false )
-                {
-                    UnitBlackBoard::unmarkUnitLoc( aiFsmManualMove_prev_loc );
-                    aiFsmManualMove_state = _aiFsmManualMove_check_fsm_transition;
-                    end_cycle = true;
-                    return;
-                }
-                else
-                {
-                    end_cycle = true;
-                    return;
-                } // ** else
-            }
-            break;
-
-            // *************************************************************
-
-            case _aiFsmManualMove_check_fsm_transition :
-            {
-                if ( external_ai_event == _external_event_pending_unit_destruct )
-                {
-                    // External Event: This unit is about to be deleted
-                    // Action : Exit fsm gracefully
-                    UnitBlackBoard::unmarkUnitLoc( aiFsmManualMove_next_loc );
-                    external_ai_event = _external_event_null;
-                    ai_command_state = _ai_command_idle;
-                    end_cycle = true;
-                    return;
-                }
-                else if ( pending_AI_comm == true )
-                {
-                    ai_fsm_transition_complete = true;
-                    end_cycle = true;
-                    return;
-                }
-                else
-                {
-                    aiFsmManualMove_state = _aiFsmManualMove_next_move;
-                }
-            }
-            break;
-
-        } // ** switch
-    } while ( end_cycle == false );
-
-}
-
 void Vehicle::fireWeapon( iXY &amp;target_loc )
 {
     reload_counter = 0;
@@ -1779,10 +1624,6 @@
         case _ai_command_attack_unit:
             aiFsmAttackUnit();
             break;
-
-        case _ai_command_manual_move:
-            aiFsmManualMove();
-            break;
     }
 }
 
@@ -1797,23 +1638,16 @@
 
         if ( unit_state.lifecycle_state == _UNIT_LIFECYCLE_ACTIVE )
         {
-            switch( pending_AI_comm_mesg.command )
+            switch( pending_command )
             {
-                case _command_move_to_loc :
-                    setCommandMoveToLoc( &amp;pending_AI_comm_mesg );
+                case PENDING_COMMAND_MOVE:
+                    setCommandMoveToLoc();
                     break;
 
-                case _command_attack_unit :
-                    setCommandAttackUnit( &amp;pending_AI_comm_mesg );
+                case PENDING_COMMAND_ATTACK:
+                    setCommandAttackUnit();
                     break;
 
-                case _command_start_manual_move :
-                    setCommandManualMove( &amp;pending_AI_comm_mesg  );
-                    break;
-
-                case _command_stop_manual_move :
-                    setCommandManualMove( &amp;pending_AI_comm_mesg  );
-                    break;
             } // ** switch
 
         } // ** unit_state.lifecycle_state == _UNIT_LIFECYCLE_ACTIVE
@@ -1822,8 +1656,35 @@
 
 }
 
-void Vehicle::setCommandMoveToLoc(const UMesgAICommand* message)
+void Vehicle::moveToLoc(const iXY&amp; loc)
 {
+    pending_command = PENDING_COMMAND_MOVE;
+    pending_moveToLocation = loc;
+    pending_AI_comm = true;
+}
+
+void Vehicle::attackUnit(const UnitID unit_id)
+{
+    pending_command = PENDING_COMMAND_ATTACK;
+    pending_enemyUnit = unit_id;
+    pending_AI_comm = true;
+}
+
+void Vehicle::manualShoot(const iXY&amp; loc)
+{
+    if ( fsm_active_list[ _control_gunnery_target ] == true )
+    {
+        clearFsmGunneryTarget();
+    }
+
+    fsmGunneryLocation_target = loc;
+    setFsmTurretTrackPoint( loc );
+    
+    fsm_active_list[ _control_gunnery_location ] = true;
+}
+
+void Vehicle::setCommandMoveToLoc()
+{
     iXY start;
 
     if ( fsm_active_list[ _control_gunnery_location ] == true )
@@ -1831,7 +1692,7 @@
         clearFsmGunneryLocation();
     }
 
-    aiFsmMoveToLoc_goal = message-&gt;getGoalLoc();
+    aiFsmMoveToLoc_goal = pending_moveToLocation;
     ai_command_state = _ai_command_move_to_loc;
     aiFsmMoveToLoc_state = _aiFsmMoveToLoc_path_generate;
     aiFsmMoveToLoc_path_not_finished = true;
@@ -1856,13 +1717,13 @@
     setFsmTurretTrackPoint( target );
 }
 
-void Vehicle::setCommandAttackUnit(const UMesgAICommand* message)
+void Vehicle::setCommandAttackUnit()
 {
     iXY start;
     UnitBase *target_unit_ptr;
     UnitState *target_unit_state;
 
-    aiFsmAttackUnit_target_ID = message-&gt;getTargetUnitID();
+    aiFsmAttackUnit_target_ID = pending_enemyUnit;
 
     target_unit_ptr = UnitInterface::getUnit( aiFsmAttackUnit_target_ID );
     if ( target_unit_ptr == 0 )
@@ -1890,47 +1751,8 @@
     setFsmGunneryTarget( aiFsmAttackUnit_target_ID );
 }
 
-void Vehicle::setCommandManualMove(const UMesgAICommand* message)
+bool Vehicle::weaponHit(const UnitID from_unit, const Uint16 damage_factor)
 {
-    if ( message-&gt;command == _command_start_manual_move )
-    {
-        aiFsmManualMove_move_orientation = message-&gt;manual_move_orientation;
-        MapInterface::pointXYtoMapXY( unit_state.location, aiFsmManualMove_next_loc );
-        aiFsmManualMove_state = _aiFsmManualMove_next_move;
-        ai_command_state = _ai_command_manual_move;
-    }
-    else if ( message-&gt;command == _command_stop_manual_move )
-    {
-        ai_command_state = _ai_command_idle;
-    }
-}
-
-void Vehicle::setCommandManualFire(const UMesgAICommand* message)
-{
-    setFsmGunneryLocation(message-&gt;getTargetLoc());
-}
-
-void Vehicle::messageAICommand(const UnitMessage* message)
-{
-    const UMesgAICommand *command_mesg = (const UMesgAICommand *) message;
-
-    if ( unit_state.lifecycle_state == _UNIT_LIFECYCLE_ACTIVE )
-    {
-        if (command_mesg-&gt;command == _command_manual_fire)
-        {
-            setCommandManualFire( command_mesg );
-        }
-        else
-        {
-            memcpy(&amp;pending_AI_comm_mesg, command_mesg, sizeof(UMesgAICommand));
-            pending_AI_comm = true;
-        }
-    }
-}
-
-
-void Vehicle::weaponHit(const UnitID from_unit, const Uint16 damage_factor)
-{
     unit_state.hit_points -= damage_factor;
     unit_state.threat_level = _threat_level_under_attack;
     threat_level_under_attack_timer.changePeriod(
@@ -1948,18 +1770,16 @@
         unit_state.lifecycle_state = _UNIT_LIFECYCLE_PENDING_DESTRUCT;
         external_ai_event = _external_event_pending_unit_destruct;
 
-        UMesgEndLifeCycleUpdate lifecycle_update;
-        lifecycle_update.set(id, from_unit, unit_state.unit_type);
-        UnitInterface::sendMessage(&amp;lifecycle_update);
-
         // ** Note: Temp
         iXY current_map_loc;
         MapInterface::pointXYtoMapXY(unit_state.location, current_map_loc);
         UnitBlackBoard::unmarkUnitLoc(current_map_loc);
     }
+    
+    return unit_state.lifecycle_state == _UNIT_LIFECYCLE_PENDING_DESTRUCT;
 }
 
-void Vehicle::messageSelfDestruct(const UnitMessage* )
+void Vehicle::selfDestruct()
 {
     unit_state.lifecycle_state = _UNIT_LIFECYCLE_PENDING_DESTRUCT;
     external_ai_event = _external_event_pending_unit_destruct;
@@ -1970,28 +1790,6 @@
     UnitBlackBoard::unmarkUnitLoc( current_map_loc );
 }
 
-void Vehicle::processMessage(const UnitMessage* message)
-{
-    if (unit_state.lifecycle_state != _UNIT_LIFECYCLE_ACTIVE)
-        return;
-
-    switch(message-&gt;message_id)
-    {
-        case _umesg_ai_command:
-            messageAICommand(message);
-            break;
-
-        case _umesg_self_destruct:
-            messageSelfDestruct(message);
-            break;
-
-        default:
-            LOGGER.warning(&quot;Unknown unit message (id %d)&quot;,
-                    message-&gt;message_id);
-            break;
-    }
-}
-
 void Vehicle::unitOpcodeMove(const UnitOpcode* opcode)
 {
     if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;flags &amp; _unit_opcode_flag_sync) ) ||

Modified: trunk/netpanzer/src/NetPanzer/Units/Vehicle.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/Vehicle.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Units/Vehicle.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -21,7 +21,6 @@
 
 #include &quot;Units/UnitBase.hpp&quot;
 #include &quot;Util/Timer.hpp&quot;
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 #include &quot;Units/UnitOpcodes.hpp&quot;
 #include &quot;Classes/AI/PathList.hpp&quot;
 
@@ -39,7 +38,6 @@
 enum { _ai_command_idle,
        _ai_command_move_to_loc,
        _ai_command_attack_unit,
-       _ai_command_manual_move,
        _ai_command_defend_hold };
 
 enum { _aiFsmMoveToLoc_path_generate,
@@ -61,10 +59,6 @@
 enum { _aiFsmDefendHold_search_for_enemy,
        _aiFsmDefendHold_attack_enemy };
 
-enum { _aiFsmManualMove_next_move,
-       _aiFsmManualMove_move_wait,
-       _aiFsmManualMove_check_fsm_transition };
-
 enum { _external_event_null,
        _external_event_pending_unit_destruct };
 
@@ -90,8 +84,6 @@
     bool fsm_active_list[ 7 ];
 
     PathList path;
-    bool path_generated;
-    bool critical_ai_section;
     bool ai_fsm_transition_complete;
 
     unsigned short reload_counter;
@@ -110,29 +102,25 @@
     // ** FSMs and AI FSMs
     unsigned short fsmBodyRotate_rotation;
     long           fsmBodyRotate_goal_angle;
-    void    setFsmBodyRotate( long goal_angle, unsigned short rotation );
+    void setFsmBodyRotate( long goal_angle, unsigned short rotation );
     bool fsmBodyRotate();
 
     unsigned short fsmTurretRotate_rotation;
     long           fsmTurretRotate_goal_angle;
-    void    setFsmTurretRotate( long goal_angle, unsigned short rotation );
+    void setFsmTurretRotate( long goal_angle, unsigned short rotation );
     bool fsmTurretRotate();
 
-    float interpolation_speed;
-    TimeStamp start_move_stamp;
-    TimeStamp end_move_stamp;
-    bool     fsmMove_first_stamp;
-    signed char fsmMove_offset_x;
-    signed char fsmMove_offset_y;
-    unsigned char fsmMove_moves_counter;
-    unsigned char fsmMove_moves_per_square;
+    signed char     fsmMove_offset_x;
+    signed char     fsmMove_offset_y;
+    unsigned char   fsmMove_moves_counter;
+    unsigned char   fsmMove_moves_per_square;
     void setFsmMove( unsigned short orientation );
     bool fsmMove();
 
-    MoveOpcode move_opcode;
-    Timer opcode_move_timer;
-    bool move_opcode_sent;
-    unsigned char fsmMoveMapSquare_movement_type;
+    MoveOpcode      move_opcode;
+    Timer           opcode_move_timer;
+    bool            move_opcode_sent;
+    unsigned char   fsmMoveMapSquare_movement_type;
     void setFsmMoveMapSquare( unsigned long square );
     bool fsmMoveMapSquare();
 
@@ -152,7 +140,6 @@
     void fsmTurretTrackTarget();
 
     iXY fsmGunneryLocation_target;
-    void setFsmGunneryLocation(const iXY&amp; target );
     void clearFsmGunneryLocation();
     void fsmGunneryLocation();
 
@@ -192,13 +179,6 @@
     void aiFsmAttackUnit_OnExitCleanUp();
     void aiFsmAttackUnit();
 
-
-    unsigned char aiFsmManualMove_move_orientation;
-    unsigned char aiFsmManualMove_state;
-    iXY aiFsmManualMove_next_loc;
-    iXY aiFsmManualMove_prev_loc;
-    void aiFsmManualMove();
-
     void fireWeapon( iXY &amp;target_loc );
     virtual unsigned short launchProjectile();
     virtual void soundSelected();
@@ -224,28 +204,30 @@
     void processOpcodeQueue();
 
     // ** Message Handlers
-    UMesgAICommand pending_AI_comm_mesg;
-    bool	     pending_AI_comm;
+    
+    iXY             pending_moveToLocation;
+    UnitID          pending_enemyUnit;
+    unsigned char   pending_command; 
+    bool	    pending_AI_comm;
     void checkPendingAICommStatus();
 
-    void setCommandMoveToLoc(const UMesgAICommand* message);
-    void setCommandAttackUnit(const UMesgAICommand* message);
-    void setCommandManualMove(const UMesgAICommand* message);
-    void setCommandManualFire(const UMesgAICommand* message);
+    void setCommandMoveToLoc();
+    void setCommandAttackUnit();
 
-    void messageAICommand(const UnitMessage* message);
-    void weaponHit(const UnitID from_unit, const Uint16 damage_factor);
-    void messageSelfDestruct(const UnitMessage* message);
+    bool weaponHit(const UnitID from_unit, const Uint16 damage_factor);
     
     void setUnitProperties( unsigned char utype );
 
+    void moveToLoc(const iXY&amp; loc);
+    void attackUnit(const UnitID unit_id);
+    void manualShoot(const iXY&amp; loc);
+    void selfDestruct();
+    
 public:
     Vehicle(PlayerState* player, unsigned char utype, UnitID id, iXY initial_loc);
 
     virtual void updateState();
 
-    virtual void processMessage(const UnitMessage* message);
-
     virtual void evalCommandOpcode(const UnitOpcode* opcode);
 
     virtual void syncUnit();

Modified: trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Views/Components/MiniMap.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -223,7 +223,7 @@
         iXY map_loc = iXY( int(float(unit_state.location.x/32) / xratio)+position.x,
                            int(float(unit_state.location.y/32) / yratio)+position.y);
 
-        if ( unit-&gt;player-&gt;getID() == PlayerInterface::getLocalPlayerIndex())
+        if ( unit-&gt;player_id == PlayerInterface::getLocalPlayerIndex())
         {
             if ( unit_state.threat_level == _threat_level_under_attack )
             {
@@ -254,13 +254,13 @@
             }
         }
         // XXX ALLY
-        else if (PlayerInterface::isAllied(PlayerInterface::getLocalPlayerIndex(), unit-&gt;player-&gt;getID()))
+        else if (PlayerInterface::isAllied(PlayerInterface::getLocalPlayerIndex(), unit-&gt;player_id))
         {
             color = gameconfig-&gt;getAlliedRadarUnitColor();
         }
         else if ( EnemyRadarPowerUp::isRadarActive() )
         {
-            color = unit-&gt;player-&gt;getColor();
+            color = PlayerInterface::getPlayer(unit-&gt;player_id)-&gt;getColor();
         }
         else
         {

Modified: trunk/netpanzer/src/NetPanzer/Views/Components/tStringListBox.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Components/tStringListBox.hpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Views/Components/tStringListBox.hpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -90,7 +90,30 @@
     virtual void AddData(const std::string&amp; S, void * D);
     virtual void deleteData(const DataItem&amp; data) { /* to be overriden */}
     
-    virtual void Clear(){List.clear();dirty = true; SelectedItem = List.end(); StartItem=List.end(); }
+    virtual void Clear()
+    {
+        List.clear();
+        dirty = true;
+        SelectedItem = List.end();
+        StartItem = List.end();
+        StartSubLine = 0;
+        TotalLines = 0;
+        TotalPosition = 0;
+        MaxItemWidth = size.x;
+        
+        if (VScrollBar)
+        {
+            VScrollBar-&gt;setPosition(0);
+            VScrollBar-&gt;setMax(0);
+        }
+
+        if (HScrollBar)
+        {
+            HScrollBar-&gt;setPosition(0);
+            HScrollBar-&gt;setMax(MaxItemWidth);
+        }
+    }
+    
     virtual int Count(){return List.size();}
     virtual void onPaint(Surface &amp;dst, const DataItem&amp; data, int SubLine);
     virtual void setLocation(int x, int y);

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/GFlagSelectionView.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/GFlagSelectionView.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/GFlagSelectionView.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -22,7 +22,6 @@
 #include &quot;Interfaces/PlayerInterface.hpp&quot;
 #include &quot;Interfaces/GameConfig.hpp&quot;
 #include &quot;Classes/Network/NetworkClient.hpp&quot;
-#include &quot;Classes/Network/PlayerNetMessage.hpp&quot;
 #include &quot;Classes/WorldInputCmdProcessor.hpp&quot;
 
 #include &quot;Views/GameViewGlobals.hpp&quot;
@@ -32,6 +31,7 @@
 #include &quot;Views/Components/Desktop.hpp&quot;
 
 #include &quot;2D/Palette.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeFlagRequest.hpp&quot;
 
 #include &lt;vector&gt;
 #include &lt;string&gt;
@@ -62,12 +62,12 @@
             bimage.frameToBuffer(GameConfig::player_flag_data,
                                  sizeof(GameConfig::player_flag_data));
 
-            UpdatePlayerFlag upf;
-            memcpy(upf.player_flag,
+            ChangeFlagRequest req;
+            memcpy(req.player_flag,
                    GameConfig::player_flag_data,
                    sizeof(GameConfig::player_flag_data));
 
-            CLIENT-&gt;sendMessage(&amp;upf, sizeof(upf));
+            CLIENT-&gt;sendMessage(&amp;req, sizeof(req));
 
             Desktop::setVisibility(&quot;GFlagSelectionView&quot;, false);
             COMMAND_PROCESSOR.Flagtimer.reset();

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -34,6 +34,9 @@
 #include &quot;Objectives/ObjectiveInterface.hpp&quot;
 
 #include &quot;Actions/Action.hpp&quot;
+#include &quot;Network/PlayerRequests/PlayerReadyRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/ChangeTeamRequest.hpp&quot;
+#include &quot;Classes/Network/NetworkClient.hpp&quot;
 
 class ChangeTeamAction : public Action
 {
@@ -286,21 +289,27 @@
 
 void PrepareTeam::changeTeam()
 {
+    ChangeTeamRequest req;
+    
     if (PlayerInterface::getLocalPlayer()-&gt;getTeamID() == 0)
     {
-        TeamManager::PlayerrequestchangeTeam(PlayerInterface::getLocalPlayerIndex(), 1);
+        req.team_id = 1;
         changebutton-&gt;setLabel(&quot; &lt;&lt; &quot;);
     }
     else
     {
-        TeamManager::PlayerrequestchangeTeam(PlayerInterface::getLocalPlayerIndex(), 0);
+        req.team_id = 0;
         changebutton-&gt;setLabel(&quot; &gt;&gt; &quot;);
     }
+    
+    CLIENT-&gt;sendMessage(&amp;req, sizeof(req));
 }
 
 void PrepareTeam::playerReady()
 {
-    TeamManager::PlayerRequestReady(PlayerInterface::getLocalPlayerIndex());
+    PlayerReadyRequest req;
+    CLIENT-&gt;sendMessage( &amp;req, sizeof(req));
+
     changebutton-&gt;disable();
     readybutton-&gt;disable();
 }

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/RankView.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/RankView.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/RankView.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -34,6 +34,8 @@
 #include &quot;Classes/WorldInputCmdProcessor.hpp&quot;
 
 #include &quot;Views/Components/Label.hpp&quot;
+#include &quot;Network/PlayerRequests/BreakAllianceRequest.hpp&quot;
+#include &quot;Network/PlayerRequests/AllianceRequest.hpp&quot;
 
 #define HEADER_HEIGHT 24
 #define ENTRY_HEIGHT 20
@@ -235,18 +237,18 @@
             unsigned int localplayer = PlayerInterface::getLocalPlayerIndex();
             if ( destplayer != localplayer )
             {
-                PlayerAllianceRequest allie_request;
-
                 if ( PlayerInterface::isSingleAllied(localplayer, destplayer) )
                 {
-                    allie_request.set( localplayer, destplayer, _player_break_alliance);
+                    BreakAllianceRequest req;
+                    req.with_player_id = destplayer;
+                    CLIENT-&gt;sendMessage(&amp;req, sizeof(req));
                 }
                 else
                 {
-                    allie_request.set( localplayer, destplayer, _player_make_alliance);
+                    AllianceRequest req;
+                    req.with_player_id = destplayer;
+                    CLIENT-&gt;sendMessage(&amp;req, sizeof(req));
                 }
-
-                CLIENT-&gt;sendMessage( &amp;allie_request, sizeof(PlayerAllianceRequest));
             }
         }
     }

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/VehicleSelectionView.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/VehicleSelectionView.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/VehicleSelectionView.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -18,7 +18,6 @@
 
 #include &quot;VehicleSelectionView.hpp&quot;
 
-#include &quot;Classes/Network/TerminalNetMesg.hpp&quot;
 #include &quot;Classes/Network/NetworkClient.hpp&quot;
 #include &quot;Classes/Network/NetworkState.hpp&quot;
 
@@ -45,6 +44,8 @@
 #include &quot;Views/Components/ViewGlobals.hpp&quot;
 #include &quot;Views/Components/Label.hpp&quot;
 
+#include &quot;Network/PlayerRequests/ChangeObjectiveGenerationRequest.hpp&quot;
+
 int vsvSelectedUnit   = 0;
 int vsvUnitGenOn      = true;
 bool changeMade       = false;
@@ -56,9 +57,12 @@
         return;
     }
     
-    ObjectiveInterface::sendChangeGeneratingUnit(CURRENT_SELECTED_OUTPOST_ID,
-                                                 (char)vsvSelectedUnit,
-                                                 vsvUnitGenOn);
+    ChangeObjectiveGenerationRequest req;
+    req.setObjectiveId(CURRENT_SELECTED_OUTPOST_ID);
+    req.unit_type = vsvSelectedUnit;
+    req.unit_gen_on = vsvUnitGenOn;
+    
+    CLIENT-&gt;sendMessage(&amp;req, sizeof(req));
 }
 
 static void bOK()

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/VoteBox.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/VoteBox.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/VoteBox.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -41,25 +41,33 @@
 VoteBox::VoteBox(NPString msg) : GameTemplateView()
 {
     int sizex = Surface::getTextLength(msg)+20;
+    
     if (sizex &lt; 200) sizex = 200;
+    
     moveTo(iXY((screen-&gt;getWidth()/2)-(sizex/2), screen-&gt;getHeight()/2-150));
     resize(iXY(sizex, 75));
+    
     setSearchName(&quot;votebox&quot;);
     setTitle(&quot;Message&quot;);
     setSubTitle(&quot;&quot;);
+    
     setAllowResize(false);
     setAllowMove(true);
     setVisible(false);
     setBordered(false);
+    
     add( new Label(10, 12, msg, Color::cyan));
+    
     add(Button::createNewSpecialButton(&quot;Yes&quot;,
                                        iXY(sizex/2-55, 35),
                                        50,
                                        new YesNoAction(vote_yes)));
+    
     add(Button::createNewSpecialButton(&quot;No&quot;,
                                        iXY(sizex/2+5, 35),
                                        50,
                                        new YesNoAction(vote_no)));
+    
     LOGGER.warning(&quot;VoteBox %s&quot;, msg.c_str());
 }
 
@@ -74,6 +82,7 @@
     clientArea.bltString(getClientRect().getSizeX()/2-50, getClientRect().getSizeY()-12,statBuf, Color::yellow);
 
     View::doDraw(viewArea, clientArea);
+    
     if (VoteManager::checkVoteTimer())
         VoteManager::playerVote(vote_nothing);
 }

Modified: trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -18,7 +18,6 @@
 
 
 #include &quot;BulletWeapon.hpp&quot;
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 #include &quot;Classes/Network/NetworkState.hpp&quot;
 #include &quot;Units/UnitInterface.hpp&quot;
 #include &quot;Interfaces/WorldViewInterface.hpp&quot;

Modified: trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -18,7 +18,6 @@
 
 
 #include &quot;MissleWeapon.hpp&quot;
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 #include &quot;Classes/Network/NetworkState.hpp&quot;
 #include &quot;Interfaces/GameConfig.hpp&quot;
 #include &quot;Units/UnitInterface.hpp&quot;

Modified: trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -18,7 +18,6 @@
 
 
 #include &quot;ShellWeapon.hpp&quot;
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 #include &quot;Units/UnitInterface.hpp&quot;
 #include &quot;Classes/Network/NetworkState.hpp&quot;
 #include &quot;Interfaces/WorldViewInterface.hpp&quot;

Modified: trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp	2012-10-23 08:54:58 UTC (rev 1417)
+++ trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp	2012-10-23 11:27:27 UTC (rev 1418)
@@ -21,7 +21,6 @@
 
 #include &quot;Weapons/Weapon.hpp&quot;
 
-#include &quot;Classes/UnitMessageTypes.hpp&quot;
 #include &quot;Units/UnitInterface.hpp&quot;
 
 #include &quot;Classes/Network/NetworkState.hpp&quot;

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000441.html">[Netpanzer-cvs] r1417 - in trunk/netpanzer: Languages	src/NetPanzer/Classes/Network src/NetPanzer/Objectives	src/NetPanzer/Views/Game
</A></li>
	<LI>Next message: <A HREF="000443.html">[Netpanzer-cvs] r1419 - in trunk/netpanzer: Languages	src/NetPanzer/Core src/NetPanzer/Interfaces	src/NetPanzer/Network/PlayerRequests src/NetPanzer/Views/Components	src/NetPanzer/Views/MainMenu/Multi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#442">[ date ]</a>
              <a href="thread.html#442">[ thread ]</a>
              <a href="subject.html#442">[ subject ]</a>
              <a href="author.html#442">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">More information about the Netpanzer-cvs
mailing list</a><br>
</body></html>
