<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Netpanzer-cvs] r1364 - in trunk/netpanzer:	pics/backgrounds/menus/buttons/default	pics/backgrounds/menus/menu src/Lib/2D src/NetPanzer/Classes	src/NetPanzer/Classes/Network src/NetPanzer/Interfaces	src/NetPanzer/Views/Components src/NetPanzer/Views/Game
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/netpanzer-cvs/2012-May/index.html" >
   <LINK REL="made" HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1364%20-%20in%20trunk/netpanzer%3A%0A%09pics/backgrounds/menus/buttons/default%0A%09pics/backgrounds/menus/menu%20src/Lib/2D%20src/NetPanzer/Classes%0A%09src/NetPanzer/Classes/Network%20src/NetPanzer/Interfaces%0A%09src/NetPanzer/Views/Components%20src/NetPanzer/Views/Game&In-Reply-To=%3C20120514155242.A120955B0C%40scm.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000387.html">
   <LINK REL="Next"  HREF="000389.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Netpanzer-cvs] r1364 - in trunk/netpanzer:	pics/backgrounds/menus/buttons/default	pics/backgrounds/menus/menu src/Lib/2D src/NetPanzer/Classes	src/NetPanzer/Classes/Network src/NetPanzer/Interfaces	src/NetPanzer/Views/Components src/NetPanzer/Views/Game</H1>
    <B>wile64 at scm.berlios.de</B> 
    <A HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1364%20-%20in%20trunk/netpanzer%3A%0A%09pics/backgrounds/menus/buttons/default%0A%09pics/backgrounds/menus/menu%20src/Lib/2D%20src/NetPanzer/Classes%0A%09src/NetPanzer/Classes/Network%20src/NetPanzer/Interfaces%0A%09src/NetPanzer/Views/Components%20src/NetPanzer/Views/Game&In-Reply-To=%3C20120514155242.A120955B0C%40scm.berlios.de%3E"
       TITLE="[Netpanzer-cvs] r1364 - in trunk/netpanzer:	pics/backgrounds/menus/buttons/default	pics/backgrounds/menus/menu src/Lib/2D src/NetPanzer/Classes	src/NetPanzer/Classes/Network src/NetPanzer/Interfaces	src/NetPanzer/Views/Components src/NetPanzer/Views/Game">wile64 at scm.berlios.de
       </A><BR>
    <I>Mon May 14 17:52:42 CEST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="000387.html">[Netpanzer-cvs] r1363 - trunk/netpanzer/src/NetPanzer/Interfaces
</A></li>
        <LI>Next message: <A HREF="000389.html">[Netpanzer-cvs] r1365 - in trunk/netpanzer:	pics/backgrounds/menus/menu src/Lib/2D src/NetPanzer/Classes	src/NetPanzer/Interfaces src/NetPanzer/Units	src/NetPanzer/Views/Components src/NetPanzer/Views/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#388">[ date ]</a>
              <a href="thread.html#388">[ thread ]</a>
              <a href="subject.html#388">[ subject ]</a>
              <a href="author.html#388">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: wile64
Date: 2012-05-14 17:52:41 +0200 (Mon, 14 May 2012)
New Revision: 1364

Added:
   trunk/netpanzer/pics/backgrounds/menus/buttons/default/b-black.bmp
Removed:
   trunk/netpanzer/pics/backgrounds/menus/buttons/default/be-black.bmp
   trunk/netpanzer/pics/backgrounds/menus/buttons/default/bs-black.bmp
Modified:
   trunk/netpanzer/pics/backgrounds/menus/menu/canon.bmp
   trunk/netpanzer/src/Lib/2D/Surface.hpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp
   trunk/netpanzer/src/NetPanzer/Classes/PlayerState.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/GameControlRulesDaemon.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp
   trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp
   trunk/netpanzer/src/NetPanzer/Views/Components/cssButton.cpp
   trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp
Log:
TeamMode : 
 - Some bugs change
 - Free change team in prepare screen
 - Player have color team
 - Change design prepare screen
 - Enable ready button (min 2 players for start game)

Added: trunk/netpanzer/pics/backgrounds/menus/buttons/default/b-black.bmp
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/pics/backgrounds/menus/buttons/default/b-black.bmp
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: trunk/netpanzer/pics/backgrounds/menus/buttons/default/be-black.bmp
===================================================================
(Binary files differ)

Deleted: trunk/netpanzer/pics/backgrounds/menus/buttons/default/bs-black.bmp
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/pics/backgrounds/menus/menu/canon.bmp
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/src/Lib/2D/Surface.hpp
===================================================================
--- trunk/netpanzer/src/Lib/2D/Surface.hpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/Lib/2D/Surface.hpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -109,6 +109,7 @@
 
     void drawRect(iRect bounds, const PIX &amp;color);
     void fillRect(iRect bounds, const PIX &amp;color);
+    bool grab(const Surface &amp;s, iRect bounds);
 
 private:
     friend class ScreenSurface;
@@ -117,7 +118,6 @@
     PIX   *frame0;    // Pointer to first frame
     
     void alloc(unsigned int w, unsigned int h, int nframes);
-    bool grab(const Surface &amp;s, iRect bounds);
 
     PIX *pixPtr(unsigned int x, unsigned int y) const
     {

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/PlayerNetMessage.hpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -29,7 +29,8 @@
        _net_message_id_player_alliance_request,
        _net_message_id_player_alliance_update,
        _net_message_id_player_flagtimer_update,
-       _net_message_id_player_changeteam_request
+       _net_message_id_player_changeteam_request,
+       _net_message_id_player_ready_request
      };
 
 #ifdef MSVC
@@ -263,7 +264,35 @@
 }
 __attribute__((packed));
 
+enum { ready_request,
+       ready_Accepted};
 
+class PlayerReadyRequest : public NetMessage
+{
+private:
+    PlayerID player_index;
+public:
+    Uint8  request_type;
+
+    PlayerReadyRequest()
+    {
+        message_class = _net_message_class_player;
+        message_id = _net_message_id_player_ready_request;
+    }
+
+    void set(PlayerID player_idx, Uint8 type_request)
+    {
+        this-&gt;player_index = player_idx;
+        this-&gt;request_type = type_request;
+    }
+    PlayerID getPlayerIndex() const
+    {
+        return player_index;
+    }
+}
+__attribute__((packed));
+
+
 #ifdef MSVC
 #pragma pack()
 #endif

Modified: trunk/netpanzer/src/NetPanzer/Classes/PlayerState.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/PlayerState.cpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Classes/PlayerState.cpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -22,6 +22,7 @@
 #include &quot;Classes/PlayerState.hpp&quot;
 #include &quot;Interfaces/PlayerInterface.hpp&quot;
 #include &quot;Interfaces/GameConfig.hpp&quot;
+#include &quot;Interfaces/TeamManager.hpp&quot;
 #include &quot;Resources/ResourceManager.hpp&quot;
 #include &lt;sstream&gt;
 
@@ -99,6 +100,9 @@
 PlayerState::getColor() const
 {
     assert(id &lt; playerColorCount);
+    if (GameConfig::game_teammode)
+    return TeamManager::getTeamColor(team_id);
+    else
     return ( *playerColorArray[ id ] );
 }
 

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/GameControlRulesDaemon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/GameControlRulesDaemon.cpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/GameControlRulesDaemon.cpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -188,6 +188,7 @@
     {
         if (!Desktop::getVisible(&quot;PrepareTeam&quot;)&amp;&amp; !Desktop::getVisible(&quot;GFlagSelectionView&quot;))
         {
+            TeamManager::reset();
             Desktop::setVisibility(&quot;PrepareTeam&quot;, true);
         }
         if (Desktop::getVisible(&quot;PrepareTeam&quot;))
@@ -382,10 +383,10 @@
         if (GameConfig::game_teammode)
         {
             map_cycle_fsm_server_state = _map_cycle_server_prepare_team;
+            TeamManager::reset();
             setStateServerprepareteam();
             GameControlCyclePrepareTeam prepare_team_mesg;
             SERVER-&gt;broadcastMessage(&amp;prepare_team_mesg, sizeof(GameControlCyclePrepareTeam));
-
         }
         else
         {
@@ -398,7 +399,7 @@
 
     case _map_cycle_server_prepare_team :
     {
-        if (cooldown.count())
+        if (cooldown.count() || TeamManager::CheckisPlayerReady())
         {
             GameControlCycleTeamStart team_start_mesg;
             SERVER-&gt;broadcastMessage(&amp;team_start_mesg, sizeof(GameControlCycleTeamStart));

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/PlayerInterface.cpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -590,24 +590,6 @@
     SDL_mutexV(mutex);
 }
  
-void PlayerInterface::netMessageChangeTeamRequest(const NetMessage* message)
-{
-    const PlayerTeamRequest* changeTeamRequest
-    = (const PlayerTeamRequest *) message;
-    
-    switch(changeTeamRequest-&gt;request_type)
-    {
-    case change_team_request :
-        TeamManager::serverrequestchangeTeam(changeTeamRequest-&gt;getPlayerIndex(),changeTeamRequest-&gt;gettoteamindex());
-        break;
- 
-    case change_team_Accepted:
-        TeamManager::PlayerchangeTeam(changeTeamRequest-&gt;getPlayerIndex(),changeTeamRequest-&gt;gettoteamindex());
-        break;
-    }
-
-}
-
 void PlayerInterface::processNetMessage(const NetPacket* packet)
 {
     const NetMessage* message = packet-&gt;getNetMessage();
@@ -662,8 +644,12 @@
         break;
 
     case _net_message_id_player_changeteam_request :
-        netMessageChangeTeamRequest(message);
+        TeamManager::netMessageChangeTeamRequest(message);
         break;
+     
+    case _net_message_id_player_ready_request :
+        TeamManager::netMessageReadyRequest(message);
+        break;
  
     case _net_message_id_player_flagtimer_update :
         const PlayerFlagTimerUpdate* pftu = (const PlayerFlagTimerUpdate*)message;

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.cpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -23,6 +23,7 @@
 #include &quot;Interfaces/TeamManager.hpp&quot;
 #include &quot;Interfaces/Team.hpp&quot;
 #include &quot;Interfaces/PlayerInterface.hpp&quot;
+#include &quot;Interfaces/GameControlRulesDaemon.hpp&quot;
 #include &quot;Classes/Network/NetworkClient.hpp&quot;
 #include &quot;Classes/Network/PlayerNetMessage.hpp&quot;
 #include &quot;Classes/Network/NetworkServer.hpp&quot;
@@ -31,25 +32,57 @@
 #include &quot;Objectives/ObjectiveInterface.hpp&quot;
 #include &quot;Objectives/Objective.hpp&quot;
 
-
 Team       * TeamManager::Teams_lists = 0;
 Uint8        TeamManager::max_Teams = 0;
+static bool   * player_ready = 0;
 
+static void resetPlayerReady()
+{
+    for ( int i = 0; i &lt; PlayerInterface::getMaxPlayers(); i++ )
+    {
+        player_ready[ i ] = false;
+    }
+}
+
+static bool isAllPlayersReady()
+{
+    for ( int i = 0; i &lt; PlayerInterface::getMaxPlayers(); i++ )
+    {
+        if (PlayerInterface::getPlayer(i)-&gt;isActive())
+        {
+            if (player_ready[ i ] == false) return false;
+        }
+    }
+    return true;
+}
+
+static void setReady(PlayerID player_id)
+{
+    player_ready[ player_id ] = true;
+}
+
+bool TeamManager::isPlayerReady(PlayerID player_id)
+{
+    return player_ready[ player_id ];
+}
+
 void TeamManager::initialize(const Uint8 _max_teams)
 {
     char txtBuf[256];
     Uint8 colorsteam[4] = {Color::yellow, 208, Color::green, Color::cyan};
     max_Teams = _max_teams;
-    int team_id;
 
     delete[] Teams_lists;
     Teams_lists = new Team[max_Teams];
+    delete[] player_ready;
+    player_ready = new bool [PlayerInterface::getMaxPlayers()];
 
     std::vector&lt;NPString&gt; plist;
     NPString pl = *GameConfig::game_team_names;
     string_to_params(pl, plist);
 
-    for ( team_id = 0; team_id &lt; max_Teams; ++team_id )
+
+    for ( int team_id = 0; team_id &lt; max_Teams; ++team_id )
     {
         Teams_lists[ team_id ].initialize(team_id);
         if (team_id &lt; (Uint8) plist.size()) Teams_lists[ team_id ].setName(plist[team_id]);
@@ -123,6 +156,7 @@
             }
         }
     }
+    resetPlayerReady();
 }
 
 void TeamManager::addPlayerinTeam(PlayerID player_id, Uint8 team_id)
@@ -267,18 +301,31 @@
 {
     Uint8 current_team = PlayerInterface::getPlayer(player_id)-&gt;getTeamID();
 
-    if ( (Teams_lists[newteam].countPlayers() &lt; Teams_lists[current_team].countPlayers())
-        &amp;&amp; ((PlayerInterface::getMaxPlayers()/2) &gt; Teams_lists[newteam].countPlayers()))
+    if (GameControlRulesDaemon::getGameState() == _game_state_prepare_team)
     {
-        Teams_lists[current_team].removePlayer(player_id);
-        Teams_lists[newteam].addPlayer(player_id);
-        PlayerTeamRequest Changeteam_request;
-        
-        UnitInterface::destroyPlayerUnits(player_id);
-        GameManager::spawnPlayer( player_id );
+        if (((PlayerInterface::getMaxPlayers()/2) &gt; Teams_lists[newteam].countPlayers()))
+        {
+            Teams_lists[current_team].removePlayer(player_id);
+            Teams_lists[newteam].addPlayer(player_id);
+            PlayerTeamRequest Changeteam_request;
+            Changeteam_request.set(player_id, newteam, change_team_Accepted);
+            SERVER-&gt;broadcastMessage( &amp;Changeteam_request, sizeof(PlayerTeamRequest));
+        }
+    }
+    else
+    {
+        if ( (Teams_lists[newteam].countPlayers() &lt; Teams_lists[current_team].countPlayers())
+                &amp;&amp; ((PlayerInterface::getMaxPlayers()/2) &gt; Teams_lists[newteam].countPlayers()))
+        {
+            Teams_lists[current_team].removePlayer(player_id);
+            Teams_lists[newteam].addPlayer(player_id);
+            PlayerTeamRequest Changeteam_request;
+            Changeteam_request.set(player_id, newteam, change_team_Accepted);
+            SERVER-&gt;broadcastMessage( &amp;Changeteam_request, sizeof(PlayerTeamRequest));
 
-        Changeteam_request.set(player_id, newteam, change_team_Accepted);
-        SERVER-&gt;broadcastMessage( &amp;Changeteam_request, sizeof(PlayerTeamRequest));
+            UnitInterface::destroyPlayerUnits(player_id);
+            GameManager::spawnPlayer( player_id );
+        }
     }
 }
 
@@ -288,12 +335,46 @@
 
     Teams_lists[current_team].removePlayer(player_id);
     Teams_lists[team_idx].addPlayer(player_id);
-    ConsoleInterface::postMessage(Color::yellow, false, 0,
-                                  &quot;%s has changed to team %s.&quot;,
-                                  PlayerInterface::getPlayer(player_id)-&gt;getName().c_str(),
-                                  Teams_lists[current_team].getName().c_str());
+
+    if (GameControlRulesDaemon::getGameState() != _game_state_prepare_team)
+        ConsoleInterface::postMessage(Color::yellow, false, 0,
+                                      &quot;%s has changed to team %s.&quot;,
+                                      PlayerInterface::getPlayer(player_id)-&gt;getName().c_str(),
+                                      Teams_lists[current_team].getName().c_str());
 }
 
+void TeamManager::PlayerRequestReady(PlayerID player_id)
+{
+    PlayerReadyRequest Ready_request;
+    Ready_request.set(player_id, ready_request);
+    CLIENT-&gt;sendMessage( &amp;Ready_request, sizeof(PlayerReadyRequest));
+}
+
+void TeamManager::ServerRequestReady(PlayerID player_id)
+{
+    setReady(player_id);
+    PlayerReadyRequest Ready_request;
+    Ready_request.set(player_id, ready_Accepted);
+    SERVER-&gt;broadcastMessage( &amp;Ready_request, sizeof(PlayerReadyRequest));
+}
+
+bool TeamManager::CheckisPlayerReady()
+{
+    if (PlayerInterface::getActivePlayerCount() &gt; 1)
+    {
+        if (isAllPlayersReady())
+        {
+            return true;
+        }
+    }
+    return false;
+}
+
+void TeamManager::PlayerRequestReadyAccepted(PlayerID player_id)
+{
+    setReady(player_id);
+}
+
 void TeamManager::SpawnTeams()
 {
     for ( PlayerID player_id = 0; player_id &lt; PlayerInterface::getMaxPlayers(); ++player_id )
@@ -307,7 +388,42 @@
     }
 }
 
+void TeamManager::netMessageChangeTeamRequest(const NetMessage* message)
+{
+    const PlayerTeamRequest* changeTeamRequest
+    = (const PlayerTeamRequest *) message;
+    
+    switch(changeTeamRequest-&gt;request_type)
+    {
+    case change_team_request :
+        serverrequestchangeTeam(changeTeamRequest-&gt;getPlayerIndex(),changeTeamRequest-&gt;gettoteamindex());
+        break;
+ 
+    case change_team_Accepted:
+        PlayerchangeTeam(changeTeamRequest-&gt;getPlayerIndex(),changeTeamRequest-&gt;gettoteamindex());
+        break;
+    }
+}
+void TeamManager::netMessageReadyRequest(const NetMessage* message)
+{
+    const PlayerReadyRequest* ReadyRequest
+    = (const PlayerReadyRequest *) message;
+    
+    switch(ReadyRequest-&gt;request_type)
+    {
+    case ready_request :
+        ServerRequestReady(ReadyRequest-&gt;getPlayerIndex());
+        break;
+ 
+    case change_team_Accepted:
+        PlayerRequestReadyAccepted(ReadyRequest-&gt;getPlayerIndex());
+        break;
+    }
+    
+}
 
 
 
 
+
+

Modified: trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Interfaces/TeamManager.hpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -19,6 +19,7 @@
 #define _TEAMMANAGER_HPP
 
 #include &quot;Interfaces/Team.hpp&quot;
+#include &quot;Classes/Network/NetMessage.hpp&quot;
 
 class TeamManager
 {
@@ -53,6 +54,16 @@
     static void serverrequestchangeTeam(PlayerID player_id, Uint8 team_idx);
     static void PlayerchangeTeam(PlayerID player_id, Uint8 team_idx);
     static void SpawnTeams();
+    
+    static bool CheckisPlayerReady();
+    static bool isPlayerReady(PlayerID player_id);
+    static void PlayerRequestReady(PlayerID player_id);
+    static void ServerRequestReady(PlayerID player_id);
+    static void PlayerRequestReadyAccepted(PlayerID player_id);
+
+    static void netMessageChangeTeamRequest(const NetMessage* message);
+    static void netMessageReadyRequest(const NetMessage* message);
+
 };
 
 #endif // ** _TEAMMANAGER_HPP

Modified: trunk/netpanzer/src/NetPanzer/Views/Components/cssButton.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Components/cssButton.cpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Views/Components/cssButton.cpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -90,23 +90,7 @@
                             std::string label,
                             iXY loc)
 {
-    Surface bstart;
-    bstart.loadBMP(&quot;pics/backgrounds/menus/buttons/default/bs-black.bmp&quot;);
-    Surface bend;
-    bend.loadBMP(&quot;pics/backgrounds/menus/buttons/default/be-black.bmp&quot;);
-
-    Surface spbutton(Surface::getTextLength(label)+20, bstart.getHeight(), 1);
-
-    spbutton.setFrame(0);
-    bstart.blt(spbutton,0,0);
-    bend.blt(spbutton,spbutton.getWidth()-10,0);
-
-    cssButton *b = new cssButton(cname);
-    b-&gt;setImage(spbutton);
-    b-&gt;setLabel(label);
-    b-&gt;setLocation(loc);
-    b-&gt;setTextColors(Color::white, Color::yellow, Color::yellow, Color::darkGray);
-
+    cssButton *b = cssButton::createcssButton(cname, label, loc, Surface::getTextLength(label)+20);
     return b;
 }
 
@@ -115,22 +99,31 @@
                             std::string label,
                             iXY loc, int width)
 {
+    Surface bitmap;
+    bitmap.loadBMP(&quot;pics/backgrounds/menus/buttons/default/b-black.bmp&quot;);
+    
     Surface bstart;
-    bstart.loadBMP(&quot;pics/backgrounds/menus/buttons/default/bs-black.bmp&quot;);
+    bstart.grab(bitmap, iRect(0, 0, 15, bitmap.getHeight()));
     Surface bend;
-    bend.loadBMP(&quot;pics/backgrounds/menus/buttons/default/be-black.bmp&quot;);
+    bend.grab(bitmap, iRect(bitmap.getWidth()-15, 0, bitmap.getWidth(), bitmap.getHeight()));
+    Surface bmiddle;
+    bmiddle.grab(bitmap, iRect(15, 0, bitmap.getWidth()-15, bitmap.getHeight()));
 
     Surface spbutton(width, bstart.getHeight(), 1);
 
     spbutton.setFrame(0);
     bstart.blt(spbutton,0,0);
-    bend.blt(spbutton,spbutton.getWidth()-10,0);
-
+    int msize = bmiddle.getWidth();
+    for (int i = 0; i &lt; (int)((spbutton.getWidth())/msize);i++)
+    {
+        bmiddle.blt(spbutton,15+(msize*i),0);
+    }
+    bend.blt(spbutton,spbutton.getWidth()-15,0);
     cssButton *b = new cssButton(cname);
     b-&gt;setImage(spbutton);
     b-&gt;setLabel(label);
     b-&gt;setLocation(loc);
-    b-&gt;setTextColors(Color::white, Color::yellow, Color::yellow, Color::darkGray);
+    b-&gt;setTextColors(componentActiveTextColor, componentBodyColor, componentBodyColor, 33);
 
     return b;
 }

Modified: trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp	2012-05-11 22:45:23 UTC (rev 1363)
+++ trunk/netpanzer/src/NetPanzer/Views/Game/PrepareTeam.cpp	2012-05-14 15:52:41 UTC (rev 1364)
@@ -34,11 +34,6 @@
 static const char * stats_format = &quot;%-20s&quot;;
 static Uint8 newteam = 0;
 
-//static void bChangeTeam()
-//{
-//    TeamManager::PlayerrequestchangeTeam(PlayerInterface::getLocalPlayerIndex(), newteam);
-//}
-
 PrepareTeam::PrepareTeam() : GameTemplateView()
 {
     setSearchName(&quot;PrepareTeam&quot;);
@@ -78,18 +73,19 @@
     secondrect.max.x = rect.max.x-7;
     secondrect.max.y = firstrect.max.y;
     
-    changebutton = cssButton::createcssButton( &quot;changeteam&quot;, &quot; &gt;&gt; &quot;, iXY(firstrect.max.x+15, (firstrect.min.y+50)), 70);
+    changebutton = cssButton::createcssButton( &quot;changeteam&quot;, &quot; &gt;&gt; &quot;, iXY(firstrect.max.x+10, (firstrect.min.y+50)), (secondrect.min.x-firstrect.max.x)-20);
     add(changebutton);
-    readybutton = cssButton::createcssButton( &quot;ready&quot;, &quot;Ready&quot;, iXY(firstrect.max.x+15, (firstrect.min.y+85)), 70);
+    readybutton = cssButton::createcssButton( &quot;ready&quot;, &quot;Ready&quot;, iXY(firstrect.max.x+10, (firstrect.min.y+85)), (secondrect.min.x-firstrect.max.x)-20);
     add(readybutton);
+
     loaded = true;
 }
 
 void PrepareTeam::doDraw(Surface &amp;viewArea, Surface &amp;clientArea)
 {
     menuImage.bltTrans(clientArea, menuImageXY.x, menuImageXY.y);
-    clientArea.FillRoundRect(rect, 12, Color::black);
-    clientArea.RoundRect(rect,12, Color::white);
+    clientArea.FillRoundRect(rect, 12, 33);
+    clientArea.RoundRect(rect,12, 15);
 
     clientArea.RoundRect(firstrect,10, TeamManager::getTeamColor(0));
     clientArea.RoundRect(secondrect,10, TeamManager::getTeamColor(1));
@@ -190,7 +186,7 @@
     int Start_x = firstrect.min.x+30;
     int current_Team = 0;
     Surface * flag = 0;
-
+    PIX textcolor;
     for(std::vector&lt;const PlayerState*&gt;::iterator i = states.begin();
             i != states.end(); ++i)
     {
@@ -205,11 +201,17 @@
         flag = ResourceManager::getFlag(state-&gt;getFlag());
         flag-&gt;blt( dest, Start_x-23, cur_line_pos-5 );
 
+        textcolor = Color::white;
+        if (TeamManager::isPlayerReady(state-&gt;getID()))
+            textcolor = Color::darkGray;
+        else if ( state-&gt;getID() == PlayerInterface::getLocalPlayerIndex() )
+            textcolor = Color::cyan;
+
         if ( state-&gt;getID() == PlayerInterface::getLocalPlayerIndex() )
         {
             snprintf(statBuf, sizeof(statBuf),
                      stats_format, state-&gt;getName().substr(0,20).c_str());
-            dest.bltStringShadowed(Start_x, cur_line_pos, statBuf,Color::cyan, Color::gray64);
+            dest.bltString(Start_x, cur_line_pos, statBuf,textcolor);
             if (current_Team &gt; 0)
             {
                 newteam=0;
@@ -225,7 +227,7 @@
         {
             snprintf(statBuf, sizeof(statBuf),
                      stats_format, state-&gt;getName().substr(0,20).c_str());
-            dest.bltStringShadowed(Start_x, cur_line_pos, statBuf,Color::gray224, Color::gray64);
+            dest.bltString(Start_x, cur_line_pos, statBuf,textcolor);
         }
         cur_line_pos += 20;
     }
@@ -268,8 +270,9 @@
     }
     else if ( c == readybutton )
     {
+        TeamManager::PlayerRequestReady(PlayerInterface::getLocalPlayerIndex());
+        changebutton-&gt;Disable();
         readybutton-&gt;Disable();
-        changebutton-&gt;Disable();
     }
 }
 

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000387.html">[Netpanzer-cvs] r1363 - trunk/netpanzer/src/NetPanzer/Interfaces
</A></li>
	<LI>Next message: <A HREF="000389.html">[Netpanzer-cvs] r1365 - in trunk/netpanzer:	pics/backgrounds/menus/menu src/Lib/2D src/NetPanzer/Classes	src/NetPanzer/Interfaces src/NetPanzer/Units	src/NetPanzer/Views/Components src/NetPanzer/Views/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#388">[ date ]</a>
              <a href="thread.html#388">[ thread ]</a>
              <a href="subject.html#388">[ subject ]</a>
              <a href="author.html#388">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">More information about the Netpanzer-cvs
mailing list</a><br>
</body></html>
