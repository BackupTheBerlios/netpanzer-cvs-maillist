<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Netpanzer-cvs] r1098 - in trunk/netpanzer: pics src/NetPanzer/Bot	src/NetPanzer/Classes src/NetPanzer/Classes/Network	src/NetPanzer/Core src/NetPanzer/Network	src/NetPanzer/Objectives src/NetPanzer/PowerUps	src/NetPanzer/Units src/NetPanzer/Weapons
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/netpanzer-cvs/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1098%20-%20in%20trunk/netpanzer%3A%20pics%20src/NetPanzer/Bot%0A%09src/NetPanzer/Classes%20src/NetPanzer/Classes/Network%0A%09src/NetPanzer/Core%20src/NetPanzer/Network%0A%09src/NetPanzer/Objectives%20src/NetPanzer/PowerUps%0A%09src/NetPanzer/Units%20src/NetPanzer/Weapons&In-Reply-To=%3C200902220759.n1M7xQix008730%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000129.html">
   <LINK REL="Next"  HREF="000131.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Netpanzer-cvs] r1098 - in trunk/netpanzer: pics src/NetPanzer/Bot	src/NetPanzer/Classes src/NetPanzer/Classes/Network	src/NetPanzer/Core src/NetPanzer/Network	src/NetPanzer/Objectives src/NetPanzer/PowerUps	src/NetPanzer/Units src/NetPanzer/Weapons</H1>
    <B>kromxp at mail.berlios.de</B> 
    <A HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1098%20-%20in%20trunk/netpanzer%3A%20pics%20src/NetPanzer/Bot%0A%09src/NetPanzer/Classes%20src/NetPanzer/Classes/Network%0A%09src/NetPanzer/Core%20src/NetPanzer/Network%0A%09src/NetPanzer/Objectives%20src/NetPanzer/PowerUps%0A%09src/NetPanzer/Units%20src/NetPanzer/Weapons&In-Reply-To=%3C200902220759.n1M7xQix008730%40sheep.berlios.de%3E"
       TITLE="[Netpanzer-cvs] r1098 - in trunk/netpanzer: pics src/NetPanzer/Bot	src/NetPanzer/Classes src/NetPanzer/Classes/Network	src/NetPanzer/Core src/NetPanzer/Network	src/NetPanzer/Objectives src/NetPanzer/PowerUps	src/NetPanzer/Units src/NetPanzer/Weapons">kromxp at mail.berlios.de
       </A><BR>
    <I>Sun Feb 22 08:59:26 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000129.html">[Netpanzer-cvs] r1097 - in trunk/netpanzer/src/NetPanzer:	Objectives Units Views/MainMenu/Multi
</A></li>
        <LI>Next message: <A HREF="000131.html">[Netpanzer-cvs] r1099 - trunk/netpanzer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#130">[ date ]</a>
              <a href="thread.html#130">[ thread ]</a>
              <a href="subject.html#130">[ subject ]</a>
              <a href="author.html#130">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: kromxp
Date: 2009-02-22 08:58:41 +0100 (Sun, 22 Feb 2009)
New Revision: 1098

Modified:
   trunk/netpanzer/pics/Jamfile
   trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp
   trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.cpp
   trunk/netpanzer/src/NetPanzer/Classes/OpcodeDebugger.cpp
   trunk/netpanzer/src/NetPanzer/Classes/SelectionList.cpp
   trunk/netpanzer/src/NetPanzer/Classes/SelectionList.hpp
   trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp
   trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp
   trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp
   trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp
   trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp
   trunk/netpanzer/src/NetPanzer/Network/MessageRouter.cpp
   trunk/netpanzer/src/NetPanzer/Objectives/Outpost.cpp
   trunk/netpanzer/src/NetPanzer/Objectives/Outpost.hpp
   trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.hpp
   trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp
   trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.hpp
   trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp
   trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.hpp
   trunk/netpanzer/src/NetPanzer/Units/Unit.cpp
   trunk/netpanzer/src/NetPanzer/Units/Unit.hpp
   trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp
   trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp
   trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeDecoder.cpp
   trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeEncoder.cpp
   trunk/netpanzer/src/NetPanzer/Units/UnitOpcodes.hpp
   trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp
   trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp
   trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp
   trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp
Log:
--- CLEAN BEFORE BUILD ---
- PROTOCOL CHANGE, this version is not compatible with older versions, new protocol is 1021
- The commands that the players send to the server (move unit, shoot, etc) are shorter now by 9 bytes.
- The updates the server sends to the players are sorter, each update has different size, before had the same size and waste a lot.
- PowerUps are easier to 'hit'
- Removed some unused commands
- Modify Jamfile to include correct buttons when installing
- More review of UnitInterface (mostly the unit querying)
- The method to capture outposts is different now, there are 3 rules:
  1 - You only have to enter the outpost area to capture it, no need to go to the old capture point
  2 - You have to be alone in the outpost area to be able to capture it, if there are some other player tanks, nobody can capture the outpost
  3 - If the outpost is owned by some player, and this player has some unit inside the outpost area, nobody can capture it (first kill him).

Notes:
The network changes make communication smaller but has some more stress on the CPU, as computers now are powerfull shouldn't make any difference.



Modified: trunk/netpanzer/pics/Jamfile
===================================================================
--- trunk/netpanzer/pics/Jamfile	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/pics/Jamfile	2009-02-22 07:58:41 UTC (rev 1098)
@@ -15,7 +15,7 @@
         flags
         cursors
         menus/vehicleSelectionView
-        backgrounds/menus/buttons/default/pak
+        backgrounds/menus/buttons/default
         backgrounds/menus/menu/pak
         backgrounds/menus/menu
         .

Modified: trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Bot/Bot.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -46,7 +46,7 @@
     matrix.getNextEmptyLoc(&amp;map_pos);
 
     TerminalUnitCmdRequest comm_mesg;
-    comm_mesg.comm_request.setHeader(unit-&gt;id, _umesg_flag_unique);
+    comm_mesg.comm_request.setHeader(unit-&gt;id);
     comm_mesg.comm_request.setMoveToLoc(map_pos);
 
     MessageRouter::enqueueIncomingPacket(&amp;comm_mesg, sizeof(TerminalUnitCmdRequest), botPlayerId, NULL);
@@ -62,7 +62,7 @@
     assert(enemyUnit != 0);
 
     TerminalUnitCmdRequest comm_mesg;
-    comm_mesg.comm_request.setHeader(unit-&gt;id, _umesg_flag_unique);
+    comm_mesg.comm_request.setHeader(unit-&gt;id);
     comm_mesg.comm_request.setTargetUnit(enemyUnit-&gt;id);
 
     MessageRouter::enqueueIncomingPacket(&amp;comm_mesg, sizeof(TerminalUnitCmdRequest), botPlayerId, NULL);
@@ -77,7 +77,7 @@
     assert(unit != 0);
 
     TerminalUnitCmdRequest comm_mesg;
-    comm_mesg.comm_request.setHeader(unit-&gt;id, _umesg_flag_unique);
+    comm_mesg.comm_request.setHeader(unit-&gt;id);
     comm_mesg.comm_request.setManualFire(world_pos);
 
     MessageRouter::enqueueIncomingPacket(&amp;comm_mesg, sizeof(TerminalUnitCmdRequest), botPlayerId, NULL);

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetPacketDebugger.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -280,16 +280,6 @@
             log &lt;&lt; &quot;Attack: &quot; &lt;&lt; cmd.getTargetUnitID();
             break;
         }
-        case _command_start_manual_move:
-        {
-            log &lt;&lt; &quot;mmove: O:&quot; &lt;&lt; cmd.manual_move_orientation;
-            break;
-        }
-        case _command_stop_manual_move:
-        {
-            log &lt;&lt; &quot;stop mm&quot;;
-            break;
-        }
         case _command_manual_fire:
         {
             log &lt;&lt; &quot;MFire: &quot; &lt;&lt; cmd.getTargetLoc().x 

Modified: trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/Network/NetworkClient.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -24,6 +24,7 @@
 #include &quot;NetworkClient.hpp&quot;
 
 #include &quot;Classes/Network/NetworkState.hpp&quot;
+#include &quot;Classes/Network/NetPacketDebugger.hpp&quot;
 
 #include &quot;ClientServerNetMessage.hpp&quot;
 #include &quot;ConnectNetMessage.hpp&quot;

Modified: trunk/netpanzer/src/NetPanzer/Classes/OpcodeDebugger.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/OpcodeDebugger.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/OpcodeDebugger.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -28,8 +28,8 @@
 void OpcodeDebugger::logOpcode(std::ostream&amp; log, UnitOpcode* opcode)
 {
     log &lt;&lt; &quot; UNIT:&quot; &lt;&lt; opcode-&gt;getUnitID()
-        &lt;&lt; &quot; FL:&quot; &lt;&lt; (int) opcode-&gt;flags &lt;&lt; &quot; &quot;;
-    switch(opcode-&gt;opcode) {
+        &lt;&lt; &quot; FL:&quot; &lt;&lt; int(opcode-&gt;getOpcode()&amp;0x80) &lt;&lt; &quot; &quot;;
+    switch(opcode-&gt;getOpcode()) {
         case _UNIT_OPCODE_MOVE:
         {
             MoveOpcode* movecode = (MoveOpcode*) opcode;

Modified: trunk/netpanzer/src/NetPanzer/Classes/SelectionList.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/SelectionList.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/SelectionList.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -29,8 +29,8 @@
     deselect();
     unit_list.clear();
 
-    Uint16 player_id = PlayerInterface::getLocalPlayerIndex();
-    UnitInterface::queryUnitsAt(unit_list, point, player_id, _search_player);
+    UnitInterface::queryPlayerUnitsAt(unit_list, point,
+                                        PlayerInterface::getLocalPlayerIndex());
 
     select();
     if (unit_list.size() == 0)
@@ -44,8 +44,8 @@
 {
     deselect();
 
-    Uint16 player_id = PlayerInterface::getLocalPlayerIndex();
-    UnitInterface::queryUnitsAt(unit_list, point, player_id, _search_player);
+    UnitInterface::queryPlayerUnitsAt(unit_list, point,
+                                        PlayerInterface::getLocalPlayerIndex());
 
     select();
     if (unit_list.size() == 0)
@@ -55,29 +55,11 @@
     return true;
 }
 
-
-bool SelectionList::selectTarget(iXY point)
-{
-    deselect();
-    unit_list.clear();
-
-    Uint16 player_id = PlayerInterface::getLocalPlayerIndex();
-    UnitInterface::queryUnitsAt(unit_list, point, player_id,
-            _search_exclude_player);
-
-    if (unit_list.size() == 0)
-        return false;
-    
-    resetUnitCycling();
-    return true;
-}
-
 bool SelectionList::selectBounded(iRect bounds, bool addunits)
 {
-    Uint16 player_id = PlayerInterface::getLocalPlayerIndex();
-
     std::vector&lt;UnitID&gt; tempunits;
-    UnitInterface::queryUnitsAt(tempunits, bounds, player_id, _search_player);
+    UnitInterface::queryPlayerUnitsInWorldRect(tempunits, bounds,
+                                       PlayerInterface::getLocalPlayerIndex() );
     
     if ( ! tempunits.size() )
         return false;
@@ -113,7 +95,7 @@
 
     std::vector&lt;UnitID&gt; temp_list;
 
-    UnitInterface::queryUnitsAt(temp_list, point, player_id, _search_player);
+    UnitInterface::queryPlayerUnitsAt(temp_list, point, player_id);
     
     if ( temp_list.empty() )
         return false;
@@ -123,7 +105,7 @@
     
     iRect wr;
     WorldViewInterface::getViewWindow(&amp;wr);
-    UnitInterface::queryUnitsAt(temp_list, wr, player_id, _search_player);
+    UnitInterface::queryPlayerUnitsInWorldRect(temp_list, wr, player_id );
     
     int p = temp_list.size();
     if ( !p )

Modified: trunk/netpanzer/src/NetPanzer/Classes/SelectionList.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/SelectionList.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/SelectionList.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -33,7 +33,6 @@
 
     bool selectUnit( iXY point );
     bool addUnit( iXY point );
-    bool selectTarget( iXY point );
     bool selectBounded(iRect bounds, bool addunits);
     bool selectSameTypeVisible(iXY point, bool addunits);
 

Modified: trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/UnitMessage.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -20,15 +20,6 @@
 
 #include &quot;Core/CoreTypes.hpp&quot;
 
-enum { _umesg_flag_unique          = 0x01,
-       _umesg_flag_broadcast       = 0x02,
-       _umesg_flag_player          = 0x04,
-       _umesg_flag_notplayer       = 0x08,
-       _umesg_flag_send            = 0x0F,
-       _umesg_flag_queue           = 0x20,
-       _umesg_flag_manager_request = 0x40
-     };
-
 #ifdef MSVC
 #pragma pack(1)
 #endif
@@ -39,19 +30,17 @@
     Uint16 unit_id;
 public:
     Uint8 message_id;
-    Uint8 message_flags;
 
 public:
     UnitMessage()
     {
         this-&gt;unit_id = 0xBADB;
         message_id = 0;
-        message_flags = 0;
     }
 
-    UnitMessage(UnitID unit_Id, unsigned char flags)
+    UnitMessage( UnitID unit_Id )
     {
-        setHeader(unit_Id, flags);
+        setHeader(unit_Id);
     }
 
     UnitID getUnitID() const
@@ -59,19 +48,11 @@
         return ltoh16(unit_id);
     }
 
-    void setHeader(UnitID unit_id, unsigned char flags )
+    void setHeader( UnitID unit_id )
     {
         this-&gt;unit_id = htol16(unit_id);
-        message_flags = flags;
     }
 
-    bool isFlagged(unsigned char flags) const
-    {
-        if ( (flags &amp; message_flags) == flags )
-            return true;
-
-        return false;
-    }
 } __attribute__((packed));
 
 #ifdef MSVC

Modified: trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/UnitMessageTypes.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -45,29 +45,21 @@
     Sint32 goal_loc_x;
     Sint32 goal_loc_y;
     Uint16 target_id;
+
 public:
-    Uint8 manual_move_orientation;
-private:
-    Sint32 target_loc_x;
-    Sint32 target_loc_y;
-public:
     UMesgAICommand()
     {
         command = 0;
         goal_loc_x = goal_loc_y = 0;
         target_id = 0;
-        manual_move_orientation = 0;
-        target_loc_x = target_loc_y = 0;
     }
 
-    UMesgAICommand(UnitID unit_id, unsigned char flags)
-            : UnitMessage(unit_id, flags )
+    UMesgAICommand( UnitID unit_id )
+            : UnitMessage( unit_id )
     {
         command = 0;
         goal_loc_x = goal_loc_y = 0;
         target_id = 0;
-        manual_move_orientation = 0;
-        target_loc_x = target_loc_y = 0;
     }
 
     void setMoveToLoc(const iXY&amp; goal)
@@ -76,7 +68,6 @@
         command = _command_move_to_loc;
         goal_loc_x = htol32(goal.x);
         goal_loc_y = htol32(goal.y);
-        manual_move_orientation = 0;
     }
 
     void setTargetUnit(UnitID target)
@@ -84,30 +75,14 @@
         message_id = _umesg_ai_command;
         command = _command_attack_unit;
         target_id = htol16(target);
-        manual_move_orientation = 0;
     }
 
-    void setStartManualMove(unsigned char orientation)
-    {
-        message_id = _umesg_ai_command;
-        command = _command_start_manual_move;
-        manual_move_orientation = orientation;
-    }
-
-    void setStopManualMove()
-    {
-        message_id = _umesg_ai_command;
-        command = _command_stop_manual_move;
-        manual_move_orientation = 0;
-    }
-
     void setManualFire(const iXY&amp; target)
     {
         message_id = _umesg_ai_command;
         command = _command_manual_fire;
-        target_loc_x = htol32(target.x);
-        target_loc_y = htol32(target.y);
-        manual_move_orientation = 0;
+        goal_loc_x = htol32(target.x);
+        goal_loc_y = htol32(target.y);
     }
 
     iXY getGoalLoc() const
@@ -122,7 +97,7 @@
 
     iXY getTargetLoc() const
     {
-        return iXY(ltoh32(target_loc_x), ltoh32(target_loc_y));
+        return iXY(ltoh32(goal_loc_x), ltoh32(goal_loc_y));
     }
 }
 __attribute__((packed));
@@ -180,7 +155,6 @@
             unsigned char unit_type )
     {
         message_id = _umesg_end_lifecycle;
-        message_flags = _umesg_flag_manager_request;
         destroyed = htol16(destroyed_unit);
         destroyer = htol16(destroyer_unit);
         this-&gt;unit_type = unit_type;

Modified: trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -780,8 +780,7 @@
         if ( unit_ptr != 0 ) {
             if ( unit_ptr-&gt;unit_state.select == true ) {
                 matrix.getNextEmptyLoc( &amp;map_pos );
-                comm_mesg.comm_request.setHeader(unit_ptr-&gt;id,
-                        _umesg_flag_unique );
+                comm_mesg.comm_request.setHeader(unit_ptr-&gt;id);
 
                 comm_mesg.comm_request.setMoveToLoc( map_pos );
                 encoder.encodeMessage(&amp;comm_mesg,
@@ -808,11 +807,15 @@
     size_t id_list_size;
     Unit *unit_ptr;
 
-    if ( working_list.isSelected() == true ) {
-        target_list.selectTarget( world_pos );
-        LOGGER.warning(&quot;num units in list=%d&quot;, (int)target_list.unit_list.size());
+    if ( working_list.isSelected() == true )
+    {
+        target_ptr = UnitInterface::queryNonPlayerUnitAtWorld(world_pos,
+                                        PlayerInterface::getLocalPlayerIndex());
 
-        target_ptr = UnitInterface::getUnit( target_list.unit_list[0] );
+        if ( ! target_ptr ) // there was nothing there
+        {
+            return;
+        }
 
         id_list_size = working_list.unit_list.size();
 
@@ -821,12 +824,14 @@
 
         NetMessageEncoder encoder(true);
 
-        for( id_list_index = 0; id_list_index &lt; id_list_size; id_list_index++ ) {
+        for( id_list_index = 0; id_list_index &lt; id_list_size; id_list_index++ )
+        {
             unit_ptr = UnitInterface::getUnit( working_list.unit_list[ id_list_index ] );
-            if ( unit_ptr != 0 ) {
-                if ( unit_ptr-&gt;unit_state.select == true ) {
-                    comm_mesg.comm_request.setHeader(unit_ptr-&gt;id,
-                            _umesg_flag_unique);
+            if ( unit_ptr != 0 )
+            {
+                if ( unit_ptr-&gt;unit_state.select == true )
+                {
+                    comm_mesg.comm_request.setHeader(unit_ptr-&gt;id);
                     comm_mesg.comm_request.setTargetUnit(target_ptr-&gt;id);
 
                     encoder.encodeMessage(&amp;comm_mesg,
@@ -843,41 +848,6 @@
 }
 
 void
-WorldInputCmdProcessor::sendManualMoveCommand(unsigned char orientation,
-        bool start_stop)
-{
-    TerminalUnitCmdRequest comm_mesg;
-    size_t id_list_index;
-    size_t id_list_size;
-    Unit *unit_ptr;
-
-    if ( working_list.unit_list.size() &gt; 0 ) {
-        id_list_size = working_list.unit_list.size();
-
-        NetMessageEncoder encoder(true);
-
-        for( id_list_index = 0; id_list_index &lt; id_list_size; id_list_index++ ) {
-            unit_ptr = UnitInterface::getUnit( working_list.unit_list[ id_list_index ] );
-            if ( unit_ptr != 0 ) {
-                if ( unit_ptr-&gt;unit_state.select == true ) {
-                    comm_mesg.comm_request.setHeader(unit_ptr-&gt;id,
-                            _umesg_flag_unique);
-                    if ( start_stop == true ) {
-                        comm_mesg.comm_request.setStartManualMove( orientation );
-                    } else {
-                        comm_mesg.comm_request.setStopManualMove();
-                    }
-
-                    encoder.encodeMessage(&amp;comm_mesg,
-                            sizeof(TerminalUnitCmdRequest) );
-                }
-            }
-        }
-        encoder.sendEncodedMessage();
-    }
-}
-
-void
 WorldInputCmdProcessor::sendManualFireCommand(const iXY &amp;world_pos)
 {
     TerminalUnitCmdRequest comm_mesg;
@@ -896,8 +866,7 @@
 
             if ( unit_ptr != 0 ) {
                 if ( unit_ptr-&gt;unit_state.select == true ) {
-                    comm_mesg.comm_request.setHeader(unit_ptr-&gt;id,
-                            _umesg_flag_unique);
+                    comm_mesg.comm_request.setHeader(unit_ptr-&gt;id);
                     comm_mesg.comm_request.setManualFire(world_pos);
 
                     encoder.encodeMessage(&amp;comm_mesg,
@@ -916,23 +885,24 @@
 void
 WorldInputCmdProcessor::sendAllianceRequest(const iXY&amp; world_pos, bool make_break)
 {
-    Unit *target_ptr;
+    Unit *target_ptr = UnitInterface::queryNonPlayerUnitAtWorld(world_pos,
+                                        PlayerInterface::getLocalPlayerIndex());
 
-    target_list.selectTarget(world_pos);
-
-    if ( target_list.isSelected() == true ) {
-        target_ptr = UnitInterface::getUnit( target_list.unit_list[0] );
-
+    if ( target_ptr )
+    {
         Uint8 type;
-        if ( make_break ) {
+        if ( make_break )
+        {
             type = _player_make_alliance;
-        } else {
+        }
+        else
+        {
             type = _player_break_alliance;
         }
 
         PlayerAllianceRequest allie_request;
         allie_request.set(PlayerInterface::getLocalPlayerIndex(),
-                target_ptr-&gt;player-&gt;getID(), type);
+                                            target_ptr-&gt;player-&gt;getID(), type);
 
         NetworkClient::sendMessage( &amp;allie_request, sizeof(PlayerAllianceRequest));
     }

Modified: trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Classes/WorldInputCmdProcessor.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -57,8 +57,6 @@
 
     void getManualControlStatus();
 
-    void sendManualMoveCommand(unsigned char orientation,
-                                bool start_stop);
     void sendManualFireCommand(const iXY &amp;world_pos);
     void sendMoveCommand(const iXY &amp;world_pos);
     void sendAttackCommand(const iXY &amp;world_pos);

Modified: trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Core/NetworkGlobals.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -19,7 +19,7 @@
 #define __NETWORK_GLOBALS_HPP__
 
 #define NETPANZER_DEFAULT_PORT_TCP     3030
-#define NETPANZER_PROTOCOL_VERSION     1020
+#define NETPANZER_PROTOCOL_VERSION     1021
 #define MASTERSERVER_PORT             28900
 
 #endif

Modified: trunk/netpanzer/src/NetPanzer/Network/MessageRouter.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/MessageRouter.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Network/MessageRouter.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -41,7 +41,9 @@
 #include &quot;Classes/Network/NetworkServer.hpp&quot;
 #include &quot;Classes/Network/NetworkClient.hpp&quot;
 #include &quot;Classes/Network/NetworkState.hpp&quot;
+#include &quot;Classes/Network/NetPacketDebugger.hpp&quot;
 
+
 class MultiMessage;
 
 static MessageClassHandler * handlers[256];
@@ -212,7 +214,7 @@
         receive_queue.pop();
         NetworkState::incPacketsReceived(np.getSize());
 #ifdef NETWORKDEBUG
-        NetPacketDebugger::logPacket(&quot;R&quot;, packet);
+        NetPacketDebugger::logPacket(&quot;R&quot;, &amp;np);
 #endif
 
         handlers[np.getNetMessage()-&gt;message_class]-&gt;handlePacket(&amp;np);

Modified: trunk/netpanzer/src/NetPanzer/Objectives/Outpost.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Objectives/Outpost.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Objectives/Outpost.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -16,6 +16,8 @@
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
 #include &lt;config.h&gt;
+
+#include &quot;Classes/PlayerState.hpp&quot;
 #include &quot;Outpost.hpp&quot;
 
 #include &quot;Units/UnitInterface.hpp&quot;
@@ -38,7 +40,7 @@
     objective_state.selection_box.max = location + iXY( 64, 32 );
     objective_state.selection_box.min = location + iXY( -224, -128 );
     objective_state.area.min = iXY( -400, -144 );
-    objective_state.area.max = iXY(  400,  240 );
+    objective_state.area.max = iXY(  350,  240 );
     objective_state.outpost_type = 0;
     
 
@@ -52,13 +54,12 @@
 }
 
 void
-Outpost::attemptOccupationChange(UnitID unit_id)
+Outpost::attemptOccupationChange( Uint16 player_id )
 {
     ObjectiveOccupationUpdate update_mesg;
     int player_status;
 
-    Unit* unit = UnitInterface::getUnit(unit_id);
-    PlayerState* player = unit-&gt;player;
+    PlayerState* player = PlayerInterface::getPlayer( player_id );
     player_status = player-&gt;getStatus();
 
     if ( objective_state.occupation_status == _occupation_status_unoccupied )
@@ -109,31 +110,58 @@
 void
 Outpost::checkOccupationStatus()
 {
-    if( occupation_status_timer.count()  )	//
+    if ( occupation_status_timer.count() )
     {
-        Unit *unit_ptr;
         iRect bounding_area;
-        iXY occupation_pad_loc;
 
-        occupation_pad_loc = objective_state.location + occupation_pad_offset;
-        bounding_area = objective_state.capture_area.getAbsRect( occupation_pad_loc );
+        // This was used for previous ocupation checks
+        //iXY occupation_pad_loc;
+        //occupation_pad_loc = objective_state.location + occupation_pad_offset;
+        //bounding_area = objective_state.capture_area.getAbsRect( occupation_pad_loc );
+        
+        bounding_area = objective_state.area.getAbsRect(objective_state.location);
 
+        std::vector&lt;Unit*&gt; unitsInArea;
+        if ( objective_state.occupation_status == _occupation_status_occupied )
+        {
+            std::vector&lt;UnitID&gt; playerunits;
+            UnitInterface::queryPlayerUnitsInWorldRect(playerunits,
+                                    bounding_area,
+                                    objective_state.occupying_player-&gt;getID() );
 
-        UnitInterface::queryClosestUnit( &amp;unit_ptr,
-                                          bounding_area,
-                                          occupation_pad_loc
-                                        );
+            if ( ! playerunits.empty() )
+            {
+                return;
+            }
 
-        if ( unit_ptr != 0 )
+            UnitInterface::queryNonPlayerUnitsInWorldRect(unitsInArea,
+                                    bounding_area,
+                                    objective_state.occupying_player-&gt;getID() );
+
+        }
+        else
         {
-            iXY unit_loc;
-            unit_loc = unit_ptr-&gt;unit_state.location;
-            if ( objective_state.capture_area.bounds( occupation_pad_loc, unit_loc ) )
+            UnitInterface::queryUnitsInWorldRect( unitsInArea, bounding_area );  
+        }
+
+
+        if ( ! unitsInArea.empty() )
+        {
+            std::vector&lt;Unit*&gt;::iterator i = unitsInArea.begin();
+
+            Uint16 ocu_player = (*i)-&gt;player-&gt;getID();
+
+            while ( ++i != unitsInArea.end() )
             {
-                attemptOccupationChange( unit_ptr-&gt;id );
+                if ( (*i)-&gt;player-&gt;getID() != ocu_player )
+                {
+                    // more than one player in area, must be alone to capture
+                    return;
+                }
             }
 
-        } // ** if unit_ptr != 0
+            attemptOccupationChange( ocu_player );
+        }
 
     } // ** if occupation_status_timer.count()
 
@@ -172,7 +200,7 @@
                     placement_matrix.reset( collection_loc );
                     placement_matrix.getNextEmptyLoc( &amp;loc );
 
-                    ai_command.setHeader( unit-&gt;id, _umesg_flag_unique );
+                    ai_command.setHeader( unit-&gt;id);
                     ai_command.setMoveToLoc( loc );
                     UnitInterface::sendMessage( &amp;ai_command );
                 }

Modified: trunk/netpanzer/src/NetPanzer/Objectives/Outpost.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Objectives/Outpost.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Objectives/Outpost.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -38,7 +38,7 @@
     Timer unit_generation_timer;
 
 private:
-    void attemptOccupationChange(UnitID unit_id);
+    void attemptOccupationChange(Uint16 player_id);
 
     void checkOccupationStatus( void );
 

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -40,15 +40,13 @@
 }
 
 
-void BonusUnitPowerUp::onHit( UnitID unit_id )
+void BonusUnitPowerUp::onHit( Unit * unit )
 {
     PlacementMatrix placement_matrix;
     iXY map_pos;
 
     sound-&gt;playPowerUpSound();
 
-    Unit* unit = UnitInterface::getUnit(unit_id);
-
     MapInterface::pointXYtoMapXY( unit-&gt;unit_state.location, &amp;map_pos );
 
     placement_matrix.reset( map_pos );

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/BonusUnitPowerUp.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -25,7 +25,7 @@
 protected:
     int bonus_unit_type;
 
-    virtual void onHit( UnitID unit_id );
+    virtual void onHit( Unit * unit );
 
 public:
     virtual ~BonusUnitPowerUp()

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -60,12 +60,10 @@
 }
 
 void
-EnemyRadarPowerUp::onHit(UnitID unit_id)
+EnemyRadarPowerUp::onHit( Unit * unit )
 {
     sound-&gt;playPowerUpSound();
 
-    Unit* unit = UnitInterface::getUnit(unit_id);
-
     if(unit-&gt;player == PlayerInterface::getLocalPlayer())
     {
         ActivateRadar();

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/EnemyRadarPowerUp.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -23,7 +23,7 @@
 class EnemyRadarPowerUp : public PowerUp
 {
 protected:
-    virtual void onHit( UnitID unit_id );
+    virtual void onHit( Unit * unit );
 
 public:
     static bool isRadarActive();

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -67,17 +67,6 @@
     sprite_shadow.setDrawModeBlend(&amp;Palette::colorTableDarkenALot);
 }
 
-bool PowerUp::isPowerUpHit(UnitID *unit_id)
-{
-    if( UnitBlackBoard::unitOccupiesLoc(map_loc) 
-        &amp;&amp; UnitInterface::queryUnitAtMapLoc(map_loc, unit_id) )
-    {
-        return true;
-    }
-    
-    return false;
-}
-
 void PowerUp::offloadGraphics( SpriteSorter &amp;sorter )
 {
     sprite.nextFrame();
@@ -93,10 +82,13 @@
     if ( NetworkState::status == _network_state_server
          &amp;&amp; life_cycle_state == _power_up_lifecycle_state_active )
     {
-        UnitID unit_id;
-        if( isPowerUpHit( &amp;unit_id ) == true )
+        if( UnitBlackBoard::unitOccupiesLoc(map_loc) )
         {
-            onHit( unit_id );
+            Unit * unit = UnitInterface::queryUnitAtMapLoc(map_loc);
+            if ( unit )
+            {
+                onHit( unit );
+            }
         }
     }
 }

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/PowerUp.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -23,6 +23,8 @@
 #include &quot;Classes/Sprite.hpp&quot;
 #include &quot;Classes/Network/PowerUpNetMessage.hpp&quot;
 
+class Unit;
+
 enum { _power_up_lifecycle_state_active,
        _power_up_lifecycle_state_inactive
      };
@@ -30,8 +32,7 @@
 class PowerUp
 {
 protected:
-    bool isPowerUpHit( UnitID *unit_id );
-    virtual void onHit( UnitID unit_id ) = 0;
+    virtual void onHit( Unit * unit ) = 0;
     
     SpritePacked sprite;
     SpritePacked sprite_shadow;

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -114,17 +114,15 @@
 void UnitPowerUp::powerUpDestruct( UnitID unit_id )
 {
     UMesgSelfDestruct self_destruct;
-    self_destruct.setHeader( unit_id, _umesg_flag_unique );
+    self_destruct.setHeader( unit_id );
     UnitInterface::sendMessage( &amp;self_destruct );
 }
 
 
-void UnitPowerUp::onHit( UnitID unit_id )
+void UnitPowerUp::onHit( Unit * unit )
 {
     sound-&gt;playPowerUpSound();
 
-    Unit* unit = UnitInterface::getUnit( unit_id );
-
     switch( unit_powerup_type )
     {
         case _unit_powerup_hitpoints:
@@ -152,7 +150,7 @@
             break;
 
         case _unit_powerup_destruct:
-            powerUpDestruct( unit_id );
+            powerUpDestruct( unit-&gt;getID() );
             break;
     }
 

Modified: trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/PowerUps/UnitPowerUp.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -26,7 +26,7 @@
 protected:
     int unit_powerup_type;
 
-    virtual void onHit( UnitID unit_id );
+    virtual void onHit( Unit * unit );
 
     void powerUpHitPoints( UnitState *unit_state);
     void powerUpRange( UnitState *unit_state);

Modified: trunk/netpanzer/src/NetPanzer/Units/Unit.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/Unit.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Units/Unit.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -1,3 +1,6 @@
+
+#include &quot;UnitOpcodes.hpp&quot;
+
 /*
 Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
  
@@ -538,7 +541,7 @@
     {
         iXY loc_offset;
 
-        move_opcode.opcode = _UNIT_OPCODE_MOVE;
+        //move_opcode.opcode = _UNIT_OPCODE_MOVE;
         move_opcode.setUnitID(id);
         move_opcode.setSquare(square);
         locationOffset( square, loc_offset );
@@ -627,11 +630,8 @@
 
     if ( NetworkState::status == _network_state_server )
     {
-        TurretTrackPointOpcode track_point_opcode;
-        track_point_opcode.opcode = _UNIT_OPCODE_TURRET_TRACK_POINT;
-        track_point_opcode.setUnitID(id);
+        TurretTrackPointOpcode track_point_opcode(id, 0, true);
         track_point_opcode.setTarget(target);
-        track_point_opcode.activate = true;
         UnitInterface::sendOpcode( &amp;track_point_opcode );
     }
 
@@ -645,10 +645,7 @@
 
     if ( NetworkState::status == _network_state_server )
     {
-        TurretTrackPointOpcode track_point_opcode;
-        track_point_opcode.opcode = _UNIT_OPCODE_TURRET_TRACK_POINT;
-        track_point_opcode.setUnitID(id);
-        track_point_opcode.activate = false;
+        TurretTrackPointOpcode track_point_opcode(id, 0, false);
         UnitInterface::sendOpcode( &amp;track_point_opcode );
     }
 }
@@ -657,13 +654,8 @@
 {
     if ( fsm_active_list[ _control_turret_track_point ] == true )
     {
-        TurretTrackPointOpcode track_point_opcode;
-        track_point_opcode.flags = _unit_opcode_flag_sync;
-        track_point_opcode.opcode = _UNIT_OPCODE_TURRET_TRACK_POINT;
-        track_point_opcode.setUnitID(id);
+        TurretTrackPointOpcode track_point_opcode(id, _unit_opcode_flag_sync, true);
         track_point_opcode.setTarget(fsmTurretTrackPoint_target);
-        track_point_opcode.activate = true;
-
         UnitInterface::sendOpcode( &amp;track_point_opcode );
     }
 }
@@ -696,11 +688,8 @@
 
     if ( NetworkState::status == _network_state_server )
     {
-        TurretTrackTargetOpcode track_target_opcode;
-        track_target_opcode.opcode  = _UNIT_OPCODE_TURRET_TRACK_TARGET;
-        track_target_opcode.setUnitID(id);
+        TurretTrackTargetOpcode track_target_opcode(id, 0, true);
         track_target_opcode.setTargetUnitID(target_id);
-        track_target_opcode.activate = true;
         UnitInterface::sendOpcode( &amp;track_target_opcode );
     }
 
@@ -712,10 +701,7 @@
 
     if ( NetworkState::status == _network_state_server )
     {
-        TurretTrackTargetOpcode track_target_opcode;
-        track_target_opcode.opcode  = _UNIT_OPCODE_TURRET_TRACK_TARGET;
-        track_target_opcode.setUnitID(id);
-        track_target_opcode.activate = false;
+        TurretTrackTargetOpcode track_target_opcode(id, 0, false);
         UnitInterface::sendOpcode( &amp;track_target_opcode );
     }
 
@@ -725,12 +711,8 @@
 {
     if ( fsm_active_list[ _control_turret_track_target ] == true )
     {
-        TurretTrackTargetOpcode track_target_opcode;
-        track_target_opcode.opcode  = _UNIT_OPCODE_TURRET_TRACK_TARGET;
-        track_target_opcode.flags = _unit_opcode_flag_sync;
-        track_target_opcode.setUnitID(id);
+        TurretTrackTargetOpcode track_target_opcode(id, _unit_opcode_flag_sync, true);
         track_target_opcode.setTargetUnitID(fsmTurretTrackTarget_target_id);
-        track_target_opcode.activate = true;
         UnitInterface::sendOpcode( &amp;track_target_opcode );
     }
 
@@ -1701,9 +1683,7 @@
                                       );
 
     if ( NetworkState::status == _network_state_server ) {
-        FireWeaponOpcode fire_opcode;
-        fire_opcode.opcode = _UNIT_OPCODE_FIRE_WEAPON;
-        fire_opcode.setUnitID(id);
+        FireWeaponOpcode fire_opcode(id);
         fire_opcode.setTarget(target_loc);
         UnitInterface::sendOpcode(&amp;fire_opcode);
     }
@@ -1806,13 +1786,6 @@
                     setCommandAttackUnit( &amp;pending_AI_comm_mesg );
                     break;
 
-                case _command_start_manual_move :
-                    setCommandManualMove( &amp;pending_AI_comm_mesg  );
-                    break;
-
-                case _command_stop_manual_move :
-                    setCommandManualMove( &amp;pending_AI_comm_mesg  );
-                    break;
             } // ** switch
 
         } // ** unit_state.lifecycle_state == _UNIT_LIFECYCLE_ACTIVE
@@ -1889,21 +1862,6 @@
     setFsmGunneryTarget( aiFsmAttackUnit_target_ID );
 }
 
-void Unit::setCommandManualMove(const UMesgAICommand* message)
-{
-    if ( message-&gt;command == _command_start_manual_move )
-    {
-        aiFsmManualMove_move_orientation = message-&gt;manual_move_orientation;
-        MapInterface::pointXYtoMapXY( unit_state.location, &amp;aiFsmManualMove_next_loc );
-        aiFsmManualMove_state = _aiFsmManualMove_next_move;
-        ai_command_state = _ai_command_manual_move;
-    }
-    else if ( message-&gt;command == _command_stop_manual_move )
-    {
-        ai_command_state = _ai_command_idle;
-    }
-}
-
 void Unit::setCommandManualFire(const UMesgAICommand* message)
 {
     setFsmGunneryLocation(message-&gt;getTargetLoc());
@@ -2034,8 +1992,8 @@
 
 void Unit::unitOpcodeMove(const UnitOpcode* opcode)
 {
-    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;flags &amp; _unit_opcode_flag_sync) ) ||
-            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;flags &amp; _unit_opcode_flag_sync) )
+    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;isSyncFlag()) ) ||
+            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;isSyncFlag()) )
        )
         return;
 
@@ -2060,8 +2018,8 @@
 
 void Unit::unitOpcodeTrackPoint(const UnitOpcode* opcode )
 {
-    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;flags &amp; _unit_opcode_flag_sync) ) ||
-            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;flags &amp; _unit_opcode_flag_sync) )
+    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;isSyncFlag()) ) ||
+            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;isSyncFlag()) )
        )
         return;
 
@@ -2082,8 +2040,8 @@
 
 void Unit::unitOpcodeTrackTarget(const UnitOpcode* opcode )
 {
-    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;flags &amp; _unit_opcode_flag_sync) ) ||
-            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;flags &amp; _unit_opcode_flag_sync) )
+    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;isSyncFlag()) ) ||
+            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;isSyncFlag()) )
        )
         return;
 
@@ -2105,8 +2063,8 @@
 {
     iXY target_loc;
 
-    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;flags &amp; _unit_opcode_flag_sync) ) ||
-            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;flags &amp; _unit_opcode_flag_sync) )
+    if ( ( (in_sync_flag == false) &amp;&amp; !(opcode-&gt;isSyncFlag()) ) ||
+            ( (in_sync_flag == true) &amp;&amp; (opcode-&gt;isSyncFlag()) )
        )
         return;
 
@@ -2141,10 +2099,8 @@
     syncFsmTurretTrackPoint();
     syncFsmTurretTrackTarget();
 
-    SyncUnitOpcode sync_opcode;
+    SyncUnitOpcode sync_opcode(id);
 
-    sync_opcode.opcode = _UNIT_OPCODE_SYNC_UNIT;
-    sync_opcode.setUnitID(id);
     UnitInterface::sendOpcode( &amp;sync_opcode );
 }
 
@@ -2181,7 +2137,7 @@
         UnitOpcodeStruct opcodedata = opcode_queue.front();
         const UnitOpcode* opcode = (UnitOpcode*) &opcodedata;
 
-        switch(opcode-&gt;opcode )
+        switch( opcode-&gt;getOpcode() )
         {
             case _UNIT_OPCODE_TURRET_TRACK_POINT:
                 unitOpcodeTrackPoint(opcode);
@@ -2208,7 +2164,7 @@
                 break;
 
             default:
-                LOGGER.warning(&quot;Unknown Opcode: %d.\n&quot;, opcode-&gt;opcode);
+                LOGGER.warning(&quot;Unknown Opcode: %d.\n&quot;, opcode-&gt;getOpcode());
                 assert(false);
                 break;
         }
@@ -2218,7 +2174,7 @@
 
 void Unit::evalCommandOpcode(const UnitOpcode* opcode)
 {
-    if (opcode-&gt;opcode == _UNIT_OPCODE_MOVE)
+    if (opcode-&gt;getOpcode() == _UNIT_OPCODE_MOVE)
     {
         move_opcode_queue.push(*((const UnitOpcodeStruct*) opcode));
     }

Modified: trunk/netpanzer/src/NetPanzer/Units/Unit.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/Unit.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Units/Unit.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -52,6 +52,11 @@
 
     void syncUnit();
 
+    UnitID getID() const
+    {
+        return id;
+    }
+
     float smolderWait;
     float smolderWaitMin;
 
@@ -212,7 +217,6 @@
 
     void setCommandMoveToLoc(const UMesgAICommand* message);
     void setCommandAttackUnit(const UMesgAICommand* message);
-    void setCommandManualMove(const UMesgAICommand* message);
     void setCommandManualFire(const UMesgAICommand* message);
 
     void messageAICommand(const UnitMessage* message);
@@ -230,11 +234,6 @@
         this-&gt;id = id;
     }
 
-    UnitID getID() const
-    {
-        return id;
-    }
-
 };
 
 

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitInterface.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -288,7 +288,7 @@
 UnitInterface::destroyPlayerUnits( const Uint16 player_id )
 {
     UMesgSelfDestruct self_destruct;
-    self_destruct.setHeader(0, _umesg_flag_unique);
+    self_destruct.setHeader(0);
 
     UnitList&amp; unitlist = playerUnitLists[player_id];
     for(UnitList::iterator i = unitlist.begin(); i != unitlist.end(); ++i)
@@ -374,56 +374,112 @@
 // ******************************************************************
 
 void
-UnitInterface::queryUnitsAt( std::vector&lt;UnitID&gt;&amp; working_list,
-                             const iXY&amp; point,
-                             const Uint16 player_id,
-                             const unsigned char search_flags )
+UnitInterface::queryPlayerUnitsAt( std::vector&lt;UnitID&gt;&amp; working_list,
+                                   const iXY&amp; point,
+                                   const Uint16 player_id )
 {
     UnitList &amp; ubl = unit_bucket_array.getBucketAssocWorldLoc(point);
     for(UnitList::iterator i = ubl.begin(); i != ubl.end(); ++i)
     {
         Unit* unit = *i;
-        if(!unit-&gt;unit_state.bounds(point))
-            continue;
+        if( (*i)-&gt;unit_state.bounds(point)
+            &amp;&amp; (*i)-&gt;player-&gt;getID() == player_id )
+        {
+            working_list.push_back(unit-&gt;id);
+        }
+    }
+}
 
-        if(search_flags == _search_exclude_player
-                &amp;&amp; unit-&gt;player-&gt;getID() == player_id)
-            continue;
-        if(search_flags == _search_player
-                &amp;&amp; unit-&gt;player-&gt;getID() != player_id)
-            continue;
+// ******************************************************************
 
-        working_list.push_back(unit-&gt;id);
+void
+UnitInterface::queryUnitsInWorldRect( std::vector&lt;Unit *&gt;&amp; working_list,
+                                      const iRect&amp; rect )
+{
+    UnitList::iterator iter;
+    iRect bucket_rect;
+    unit_bucket_array.worldRectToBucketRect( rect, bucket_rect);
+
+    for( int row = bucket_rect.min.y; row &lt;= bucket_rect.max.y; ++row )
+    {
+        for( int col = bucket_rect.min.x; col &lt;= bucket_rect.max.x; ++col )
+        {
+            UnitList &amp; bucket_list = unit_bucket_array.getBucket(row, col);
+
+            for( iter = bucket_list.begin(); iter != bucket_list.end(); ++iter )
+            {
+                if( rect.contains((*iter)-&gt;unit_state.location) )
+                {
+                    working_list.push_back(*iter);
+                }
+
+            }
+        }
     }
 }
 
 // ******************************************************************
 
 void
-UnitInterface::queryUnitsAt( std::vector&lt;UnitID&gt;&amp; working_list,
-                             const iRect&amp; rect,
-                             const Uint16 player_id,
-                             const unsigned char search_flags )
+UnitInterface::queryPlayerUnitsInWorldRect( std::vector&lt;UnitID&gt;&amp; working_list,
+                                            const iRect&amp; rect,
+                                            const Uint16 player_id )
 {
-    for(Units::iterator i = units.begin(); i != units.end(); ++i)
+    UnitList::iterator iter;
+    iRect bucket_rect;
+    unit_bucket_array.worldRectToBucketRect( rect, bucket_rect);
+
+    for( int row = bucket_rect.min.y; row &lt;= bucket_rect.max.y; ++row )
     {
-        Unit* unit = i-&gt;second;
-        if(!rect.contains(unit-&gt;unit_state.location))
-            continue;
+        for( int col = bucket_rect.min.x; col &lt;= bucket_rect.max.x; ++col )
+        {
+            UnitList &amp; bucket_list = unit_bucket_array.getBucket(row, col);
 
-        if(search_flags == _search_exclude_player
-                &amp;&amp; unit-&gt;player-&gt;getID() == player_id)
-            continue;
-        if(search_flags == _search_player
-                &amp;&amp; unit-&gt;player-&gt;getID() != player_id)
-            continue;
+            for( iter = bucket_list.begin(); iter != bucket_list.end(); ++iter )
+            {
+                if(    rect.contains((*iter)-&gt;unit_state.location)
+                    &amp;&amp; (*iter)-&gt;player-&gt;getID() == player_id )
+                {
+                    working_list.push_back((*iter)-&gt;id);
+                }
 
-        working_list.push_back(unit-&gt;id);
+            }
+        }
     }
 }
 
 // ******************************************************************
 
+void
+UnitInterface::queryNonPlayerUnitsInWorldRect( std::vector&lt;Unit *&gt;&amp; working_list,
+                                               const iRect&amp; rect,
+                                               const Uint16 player_id )
+{
+    UnitList::iterator iter;
+    iRect bucket_rect;
+    unit_bucket_array.worldRectToBucketRect( rect, bucket_rect);
+
+    for( int row = bucket_rect.min.y; row &lt;= bucket_rect.max.y; ++row )
+    {
+        for( int col = bucket_rect.min.x; col &lt;= bucket_rect.max.x; ++col )
+        {
+            UnitList &amp; bucket_list = unit_bucket_array.getBucket(row, col);
+
+            for( iter = bucket_list.begin(); iter != bucket_list.end(); ++iter )
+            {
+                if(    rect.contains((*iter)-&gt;unit_state.location)
+                    &amp;&amp; (*iter)-&gt;player-&gt;getID() != player_id )
+                {
+                    working_list.push_back(*iter);
+                }
+
+            }
+        }
+    }
+}
+
+// ******************************************************************
+
 bool
 UnitInterface::queryClosestUnit( Unit **closest_unit_ptr,
                                  const iXY &amp;loc,
@@ -544,33 +600,41 @@
     Unit *closest_unit = 0;
     long closest_magnitude = 0;
 
-    for(Units::iterator i = units.begin(); i != units.end(); ++i) {
+    for(Units::iterator i = units.begin(); i != units.end(); ++i)
+    {
         Unit* unit = i-&gt;second;
         Uint16 unitPlayerID = unit-&gt;player-&gt;getID();
 
         if(unitPlayerID == player_index
                 || PlayerInterface::isAllied(player_index, unitPlayerID))
+        {
             continue;
+        }
 
         iXY delta;
         long temp_mag;
 
-        if ( closest_unit == 0 ) {
+        if ( closest_unit == 0 )
+        {
             closest_unit = unit;
             delta  = loc - unit-&gt;unit_state.location;
             closest_magnitude = long(delta.mag2());
-        } else {
+        }
+        else
+        {
             delta  = loc - unit-&gt;unit_state.location;
             temp_mag = long(delta.mag2());
 
-            if ( closest_magnitude &gt; temp_mag ) {
+            if ( closest_magnitude &gt; temp_mag )
+            {
                 closest_unit = unit;
                 closest_magnitude = temp_mag;
             }
         }
     }
 
-    if( closest_unit != 0 ) {
+    if( closest_unit != 0 )
+    {
         *closest_unit_ptr = closest_unit;
         return true;
     }
@@ -581,24 +645,41 @@
 
 // ******************************************************************
 
-bool
-UnitInterface::queryUnitAtMapLoc( const iXY &amp; map_loc,
-                                  UnitID *queary_unit_id )
+Unit *
+UnitInterface::queryUnitAtMapLoc( const iXY &amp; map_loc )
 {
-    iXY unit_map_loc;
+    iXY world_loc;
+    MapInterface::mapXYtoPointXY(map_loc, &amp;world_loc);
 
-    for(Units::iterator i = units.begin(); i != units.end(); ++i) {
-        Unit* unit = i-&gt;second;
-        UnitState* unit_state = &amp; unit-&gt;unit_state;
+    UnitList &amp; ubl = unit_bucket_array.getBucketAssocMapLoc(map_loc);
+    for(UnitList::iterator i = ubl.begin(); i != ubl.end(); ++i)
+    {
+        if ( (*i)-&gt;unit_state.bounds(world_loc) )
+        {
+            return *i;
+        }
+    }
 
-        MapInterface::pointXYtoMapXY( unit_state-&gt;location, &amp;unit_map_loc );
-        if( map_loc == unit_map_loc ) {
-            *queary_unit_id = unit-&gt;id;
-            return true;
+    return 0;
+}
+
+// ******************************************************************
+
+Unit *
+UnitInterface::queryNonPlayerUnitAtWorld( const iXY &amp; world_loc,
+                                          const Uint16 player_id )
+{
+    UnitList &amp; ubl = unit_bucket_array.getBucketAssocWorldLoc(world_loc);
+    for(UnitList::iterator i = ubl.begin(); i != ubl.end(); ++i)
+    {
+        if ( (*i)-&gt;unit_state.bounds(world_loc)
+              &amp;&amp; (*i)-&gt;player-&gt;getID() != player_id )
+        {
+            return *i;
         }
     }
 
-    return false;
+    return 0;
 }
 
 // ******************************************************************
@@ -608,25 +689,26 @@
 {
     Uint16 player_id = PlayerInterface::getLocalPlayerIndex();
 
-    std::vector&lt;UnitID&gt; locUnits;
-    queryUnitsAt(locUnits, loc, player_id, 0);
-    if(locUnits.size() == 0) {
-        return _no_unit_found;
-    }
+    UnitList &amp; ubl = unit_bucket_array.getBucketAssocWorldLoc(loc);
+    for(UnitList::iterator i = ubl.begin(); i != ubl.end(); ++i)
+    {
+        if ( (*i)-&gt;unit_state.bounds(loc) )
+        {
+            if ( (*i)-&gt;player-&gt;getID() == player_id )
+            {
+                return _unit_player;
+            }
 
-    UnitID id = locUnits[0];
-    Unit* unit = getUnit(id);
-    if(!unit) {
-        return _no_unit_found;
+            if( PlayerInterface::isAllied(player_id, (*i)-&gt;player-&gt;getID()) )
+            {
+                return _unit_allied;
+            }
+
+            return _unit_enemy;
+        }
     }
-    if(unit-&gt;player-&gt;getID() == player_id) {
-        return _unit_player;
-    }
-    if(PlayerInterface::isAllied(player_id, unit-&gt;player-&gt;getID())) {
-        return _unit_allied;
-    }
 
-    return _unit_enemy;
+    return _no_unit_found;
 }
 
 // ******************************************************************
@@ -656,8 +738,22 @@
 UnitInterface::sendMessage( const UnitMessage* message,
                             const PlayerState* player )
 {
-    if (message-&gt;isFlagged(_umesg_flag_unique))
+    if ( message-&gt;message_id == _umesg_weapon_hit )
     {
+        UnitList &amp; uli = unit_bucket_array.getBucketAssocWorldLoc(
+                                ((UMesgWeaponHit*)message)-&gt;getHitLocation() );
+
+        for ( UnitList::iterator i = uli.begin(); i != uli.end(); ++i)
+        {
+            (*i)-&gt;processMessage(message);
+        }
+    }
+    else if ( message-&gt;message_id == _umesg_end_lifecycle )
+    {
+        unitManagerMesgEndLifecycle(message);
+    }
+    else
+    {
         Unit* unit = getUnit(message-&gt;getUnitID());
         if(unit == 0)
         {
@@ -674,35 +770,6 @@
 
         unit-&gt;processMessage(message);
     }
-    else if (message-&gt;isFlagged( _umesg_flag_broadcast) )
-    {
-        if(message-&gt;message_id != _umesg_weapon_hit)
-        {
-            LOGGER.warning(&quot;Broadcast flag only allowed for weapon hit.&quot;);
-            if(player)
-            {
-                LOGGER.warning(&quot;from player %u.\n&quot;, player-&gt;getID());
-            }
-            return;
-        }
-
-        for(Units::iterator i = units.begin(); i != units.end(); ++i)
-        {
-            Unit* unit = i-&gt;second;
-            unit-&gt;processMessage(message);
-        }
-    }
-    else if (message-&gt;isFlagged( _umesg_flag_manager_request) )
-    {
-        if(player)
-        {
-            LOGGER.warning(
-                    &quot;UnitManagerMessage sent out by player %u not allowed.&quot;,
-                    player-&gt;getID());
-            return;
-        }
-  	processManagerMessage(message);
-    }
 }
 
 // ******************************************************************
@@ -745,25 +812,6 @@
 // ******************************************************************
 
 void
-UnitInterface::processManagerMessage( const UnitMessage* message )
-{
-    switch(message-&gt;message_id)
-    {
-        case _umesg_end_lifecycle:
-            unitManagerMesgEndLifecycle(message);
-            break;
-        default:
-            LOGGER.warning(&quot;Unknown unit Manage Message type (%u).&quot;,
-                    message-&gt;message_id);
-#ifdef DEBUG
-            assert(false);
-#endif
-    }
-}
-
-// ******************************************************************
-
-void
 UnitInterface::unitManagerMesgEndLifecycle( const UnitMessage* message )
 {
     const UMesgEndLifeCycleUpdate *lifecycle_update
@@ -771,13 +819,16 @@
 
     Unit* unit1 = getUnit(lifecycle_update-&gt;getDestroyer());
     Unit* unit2 = getUnit(lifecycle_update-&gt;getDestroyed());
-    if(unit1 == 0 || unit2 == 0) {
+    
+    if(unit1 == 0 || unit2 == 0)
+    {
         LOGGER.warning(
                 &quot;Unit in EndLifeCycle message doesn't exist anymore&quot;
                 &quot;(u1: %u u2: %u)&quot;, lifecycle_update-&gt;getDestroyer(),
                 lifecycle_update-&gt;getDestroyed());
         return;
     }
+
     PlayerState* player1 = unit1-&gt;player;
     PlayerState* player2 = unit2-&gt;player;
 
@@ -787,14 +838,16 @@
     int unittype2 = unit2-&gt;unit_state.unit_type;
     const std::string&amp; unitname2 =
         UnitProfileInterface::getUnitProfile(unittype2)-&gt;unitname;
-    if(Console::server) {
+    if(Console::server)
+    {
         *Console::server &lt;&lt; &quot;'&quot; &lt;&lt; player1-&gt;getName() &lt;&lt; &quot;' killed a '&quot;
             &lt;&lt; unitname2 &lt;&lt; &quot;' from '&quot; &lt;&lt; player2-&gt;getName()
             &lt;&lt; &quot;' with his '&quot; &lt;&lt; unitname1 &lt;&lt; &quot;'.&quot; &lt;&lt; std::endl;
     }
 
     // killing own units doesn't give score
-    if(player1 != player2) {
+    if(player1 != player2)
+    {
         PlayerInterface::setKill(unit1-&gt;player, unit2-&gt;player,
                 (UnitType) lifecycle_update-&gt;unit_type);
 
@@ -890,10 +943,12 @@
     decoder.setMessage(net_message);
 
     UnitOpcode* opcode;
-    while(decoder.decode(&amp;opcode)) {
+    while(decoder.decode(&amp;opcode))
+    {
         Unit* unit = getUnit(opcode-&gt;getUnitID());
 
-        if(!unit) {
+        if(!unit)
+        {
             LOGGER.debug(&quot;Update for non-existant unit: %d&quot;,
                     opcode-&gt;getUnitID());
             continue;

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitInterface.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -101,16 +101,21 @@
 
 
     // unit querying
-    static void queryUnitsAt( std::vector&lt;UnitID&gt;&amp; working_list,
-                              const iXY&amp; point,
-                              const Uint16 player_id,
-                              const unsigned char search_flags );
+    static void queryPlayerUnitsAt( std::vector&lt;UnitID&gt;&amp; working_list,
+                                    const iXY&amp; point,
+                                    const Uint16 player_id );
 
-    static void queryUnitsAt( std::vector&lt;UnitID&gt;&amp; working_list,
-                              const iRect&amp; rect,
-                              const Uint16 player_id,
-                              const unsigned char search_flags );
+    static void queryUnitsInWorldRect( std::vector&lt;Unit *&gt;&amp; working_list,
+                                       const iRect&amp; rect );
 
+    static void queryPlayerUnitsInWorldRect( std::vector&lt;UnitID&gt;&amp; working_list,
+                                             const iRect&amp; rect,
+                                             const Uint16 player_id );
+
+    static void queryNonPlayerUnitsInWorldRect( std::vector&lt;Unit *&gt;&amp; working_list,
+                                                const iRect&amp; rect,
+                                                const Uint16 player_id );
+
     static bool queryClosestUnit( Unit **closest_unit_ptr,
                                   const iXY &amp;loc,
                                   const Uint16 player_id,
@@ -124,8 +129,11 @@
                                        const iXY &amp;loc,
                                        const Uint16 player_index );
 
-    static bool queryUnitAtMapLoc( const iXY &amp; map_loc, UnitID *query_unit_id );
+    static Unit * queryUnitAtMapLoc( const iXY &amp; map_loc );
 
+    static Unit * queryNonPlayerUnitAtWorld( const iXY &amp; world_loc,
+                                         const Uint16 player_id );
+
     static unsigned char queryUnitLocationStatus( const iXY &amp; loc );
 
     // message methods
@@ -139,7 +147,6 @@
     friend class Unit;
 
     // Unit Message Handler Methods
-    static void processManagerMessage( const UnitMessage *message );
     static void unitManagerMesgEndLifecycle( const UnitMessage *message );
 
     // Network Message Handler Variables

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeDecoder.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeDecoder.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeDecoder.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -53,12 +53,11 @@
 bool
 UnitOpcodeDecoder::decode(UnitOpcode** opcode)
 {
-    if(opcode_index + opcode_message.getHeaderSize() &gt;=
-            opcode_message.getSize())
+    if(opcode_index+opcode_message.getHeaderSize() &gt;= opcode_message.getSize() )
         return false;
     
     *opcode = (UnitOpcode*) (opcode_message.data + opcode_index);
-    opcode_index += UnitOpcode::getSize();
+    opcode_index += (*opcode)-&gt;getSize();
     return true;
 }
 

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeEncoder.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeEncoder.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitOpcodeEncoder.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -43,12 +43,14 @@
 void
 UnitOpcodeEncoder::encode(const UnitOpcode *opcode)
 {
-    if(opcode_index + UnitOpcode::getSize() &gt; sizeof(opcode_message.data)) {
+    unsigned int size = opcode-&gt;getSize();
+    if(opcode_index + size &gt; sizeof(opcode_message.data))
+    {
         send();
     }
    
-    memcpy(opcode_message.data + opcode_index, opcode, UnitOpcode::getSize());
-    opcode_index += UnitOpcode::getSize();
+    memcpy(opcode_message.data + opcode_index, opcode, size);
+    opcode_index += size;
 }
 
 void

Modified: trunk/netpanzer/src/NetPanzer/Units/UnitOpcodes.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Units/UnitOpcodes.hpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Units/UnitOpcodes.hpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -22,31 +22,28 @@
 #include &quot;Types/iXY.hpp&quot;
 #include &lt;queue&gt;
 
-enum { _unit_opcode_flag_sync = 0x01 };
+enum { _unit_opcode_flag_sync = 0x80 };
 
-/** The following is a tricky macro to ensure a struct has a specific size. THe
- * check is done at compiletime. The trick is that C doesn't allow duplicate
- * case labels...
- */
-#define ASSERT_SIZE(mystruct, size)                                     \
-    namespace TRICKYTESTS { static inline void mystruct##_test() {      \
-        int i=0; switch(i) { case 0: ; case (sizeof(mystruct) == (size)): ; } \
-    } }
-
 #ifdef MSVC
 #pragma pack(1)
 #endif
 
+#define _UNIT_OPCODE_MOVE                   1
+#define _UNIT_OPCODE_TURRET_TRACK_POINT     2
+#define _UNIT_OPCODE_TURRET_TRACK_TARGET    3
+#define _UNIT_OPCODE_FIRE_WEAPON            4
+#define _UNIT_OPCODE_SYNC_UNIT              5
+#define _UNIT_OPCODE_UPDATE_STATE           6
+#define _UNIT_OPCODE_DESTRUCT               7
+
+inline unsigned int getOpcodeSize(unsigned char code);
+
 // do not use this directly, cast to 1 of the UnitOpcode classes...
 struct UnitOpcodeStruct
 {
-public:
-    Uint8 opcode;
 private:
+    Uint8 opcode;
     Uint16 unit_index;
-public:
-    Uint8 flags;
-private:
     Uint8 op_data[7];
 } __attribute__((packed));
 
@@ -54,19 +51,28 @@
 
 class UnitOpcode
 {
-public:
+protected:
     Uint8 opcode;
-    //Uint8 player_index;
+    
 private:
     Uint16 unit_id;
+
 public:
-    Uint8 flags;
+    Uint8 getOpcode() const
+    {
+        return opcode&amp;0x7f;
+    }
 
-    static size_t getSize()
+    bool isSyncFlag() const
     {
-        return sizeof(UnitOpcodeStruct);
+        return opcode &amp; _unit_opcode_flag_sync;
     }
 
+    size_t getSize() const
+    {
+        return getOpcodeSize(getOpcode());
+    }
+
     void setUnitID(UnitID id)
     {
         unit_id = htol16(id);
@@ -78,10 +84,6 @@
     }
 } __attribute__((packed));
 
-ASSERT_SIZE(UnitOpcode, sizeof(UnitOpcodeStruct)-7)
-
-#define _UNIT_OPCODE_MOVE 1
-
 class MoveOpcode : public UnitOpcode
 {
 private:
@@ -90,17 +92,14 @@
 public:
     Sint8 loc_x_offset;
     Sint8 loc_y_offset;
-    Uint8 pad[1];
 
     MoveOpcode( )
     {
-        flags = 0;
         opcode = _UNIT_OPCODE_MOVE;
 
         square = 0;
         loc_x_offset = 0;
         loc_y_offset = 0;
-        pad[0] = 0;
     }
 
     void setSquare(Uint32 square)
@@ -114,10 +113,6 @@
     }
 } __attribute__((packed));
 
-ASSERT_SIZE(MoveOpcode, 7 + sizeof(UnitOpcode))
-
-#define _UNIT_OPCODE_TURRET_TRACK_POINT 2
-
 class TurretTrackPointOpcode : public UnitOpcode
 {
 private:
@@ -126,16 +121,13 @@
 
 public:
     Uint8  activate;
-    Uint8 pad[2];
 
-    TurretTrackPointOpcode( )
+    TurretTrackPointOpcode( UnitID unitid, Uint8 flag, bool _activate)
     {
-        flags = 0;
-        opcode = _UNIT_OPCODE_TURRET_TRACK_POINT;
-
+        opcode = _UNIT_OPCODE_TURRET_TRACK_POINT | flag;
+        setUnitID(unitid);
         target_x = target_y = 0;
-        activate = false;
-        pad[0] = pad[1] = 0;
+        activate = _activate;
     }
 
     void setTarget(iXY pos)
@@ -150,26 +142,19 @@
     }
 } __attribute__((packed));
 
-ASSERT_SIZE(TurretTrackPointOpcode, 7 + sizeof(UnitOpcode))
-
-#define _UNIT_OPCODE_TURRET_TRACK_TARGET 3
-
 class TurretTrackTargetOpcode : public UnitOpcode
 {
 private:
     Uint16 targetUnitID;
 public:
     Uint8 activate;
-    Uint8 pad[4];
 
-    TurretTrackTargetOpcode( )
+    TurretTrackTargetOpcode( UnitID unitid, Uint8 flag, bool _activate )
     {
-        flags = 0;
-        opcode = _UNIT_OPCODE_TURRET_TRACK_TARGET;
-
+        opcode = _UNIT_OPCODE_TURRET_TRACK_TARGET | flag;
+        setUnitID(unitid);
         targetUnitID = 0;
-        activate = false;
-        pad[0] = pad[1] = pad[2] = pad[3] = 0;
+        activate = _activate;
     }
 
     void setTargetUnitID(UnitID id)
@@ -183,26 +168,20 @@
     }
 } __attribute__((packed));
 
-ASSERT_SIZE(TurretTrackTargetOpcode, 7 + sizeof(UnitOpcode))
-
-#define _UNIT_OPCODE_FIRE_WEAPON 4
-
 class FireWeaponOpcode : public UnitOpcode
 {
 private:
     Uint16 x;
     Uint16 y;
-    Uint8 pad[3];
     
 public:
 
-    FireWeaponOpcode( )
+    FireWeaponOpcode( UnitID unitid )
     {
-        flags = 0;
         opcode = _UNIT_OPCODE_FIRE_WEAPON;
+        setUnitID(unitid);
 
         x = y = 0;
-        pad[0] = pad[1] = pad[2] = 0;
     }
 
     void setTarget(iXY target)
@@ -217,44 +196,28 @@
     }
 } __attribute__((packed));
 
-ASSERT_SIZE(FireWeaponOpcode, 7 + sizeof(UnitOpcode))
-
-#define _UNIT_OPCODE_SYNC_UNIT 5
-
 class SyncUnitOpcode : public UnitOpcode
 {
 public:
-    Uint8 pad[7];
 
-    SyncUnitOpcode( )
+    SyncUnitOpcode( UnitID unitid )
     {
-        flags = 0;
         opcode = _UNIT_OPCODE_SYNC_UNIT;
+        setUnitID(unitid);
 
-        for(int i=0;i&lt;7;i++)
-            pad[i] = 0;
     }
 
 } __attribute__((packed));
 
-ASSERT_SIZE(SyncUnitOpcode, 7 + sizeof(UnitOpcode))
-
-#define _UNIT_OPCODE_UPDATE_STATE 6
-
 class UpdateStateUnitOpcode : public UnitOpcode
 {
 private:
     Sint16 hit_points;
 public:
-    Uint8 pad[5];
 
     UpdateStateUnitOpcode( )
     {
-        flags = 0;
         opcode = _UNIT_OPCODE_UPDATE_STATE;
-
-        for(int i=0; i&lt;5; i++)
-            pad[i] = 0;
     }
 
     void setHitPoints(Sint16 newhitpoints)
@@ -268,29 +231,47 @@
     }
 } __attribute__((packed));
 
-ASSERT_SIZE(UpdateStateUnitOpcode, 7 + sizeof(UnitOpcode))
-
-#define _UNIT_OPCODE_DESTRUCT 7
-
 class DestructUnitOpcode : public UnitOpcode
 {
 public:
-    unsigned char pad[7];
 
     DestructUnitOpcode( )
     {
-        flags = 0;
         opcode = _UNIT_OPCODE_DESTRUCT;
-
-        for(int i=0; i&lt;7; i++)
-            pad[i] = 0;
     }
 } __attribute__((packed));
 
-ASSERT_SIZE(DestructUnitOpcode, 7 + sizeof(UnitOpcode))
-
 #ifdef MSVC
 #pragma pack()
 #endif
 
+inline unsigned int getOpcodeSize(unsigned char code)
+{
+    switch ( code )
+    {
+        case _UNIT_OPCODE_MOVE:
+            return sizeof(MoveOpcode);
+
+        case _UNIT_OPCODE_TURRET_TRACK_POINT:
+            return sizeof(TurretTrackPointOpcode);
+
+        case _UNIT_OPCODE_TURRET_TRACK_TARGET:
+            return sizeof(TurretTrackTargetOpcode);
+
+        case _UNIT_OPCODE_FIRE_WEAPON:
+            return sizeof(FireWeaponOpcode);
+
+        case _UNIT_OPCODE_SYNC_UNIT:
+            return sizeof(SyncUnitOpcode);
+
+        case _UNIT_OPCODE_UPDATE_STATE:
+            return sizeof(UpdateStateUnitOpcode);
+
+        case _UNIT_OPCODE_DESTRUCT:
+            return sizeof(DestructUnitOpcode);
+
+    }
+    return sizeof(UnitOpcodeStruct);
+}
+
 #endif

Modified: trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Weapons/BulletWeapon.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -59,7 +59,7 @@
             case _fsmFlight_on_target:
                 if (NetworkState::status == _network_state_server) {
                     UMesgWeaponHit weapon_hit;
-                    weapon_hit.setHeader(0, _umesg_flag_broadcast);
+                    weapon_hit.setHeader(0);
                     weapon_hit.message_id = _umesg_weapon_hit;
                     weapon_hit.setOwnerUnitID(owner_id);
                     weapon_hit.setHitLocation(location);

Modified: trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Weapons/MissleWeapon.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -110,7 +110,7 @@
                 UMesgWeaponHit weapon_hit;
 
                 if ( NetworkState::status == _network_state_server ) {
-                    weapon_hit.setHeader(0, _umesg_flag_broadcast);
+                    weapon_hit.setHeader(0);
                     weapon_hit.message_id = _umesg_weapon_hit;
                     weapon_hit.setOwnerUnitID(owner_id);
                     weapon_hit.setHitLocation(location);

Modified: trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Weapons/ShellWeapon.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -85,7 +85,7 @@
                 UMesgWeaponHit weapon_hit;
 
                 if ( NetworkState::status == _network_state_server ) {
-                    weapon_hit.setHeader(0, _umesg_flag_broadcast);
+                    weapon_hit.setHeader(0);
                     weapon_hit.message_id = _umesg_weapon_hit;
                     weapon_hit.setOwnerUnitID(owner_id);
                     weapon_hit.setHitLocation(location);

Modified: trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp	2009-02-21 15:37:47 UTC (rev 1097)
+++ trunk/netpanzer/src/NetPanzer/Weapons/Weapon.cpp	2009-02-22 07:58:41 UTC (rev 1098)
@@ -92,7 +92,7 @@
                 UMesgWeaponHit weapon_hit;
 
                 if (NetworkState::status == _network_state_server) {
-                    weapon_hit.setHeader(0, _umesg_flag_broadcast);
+                    weapon_hit.setHeader(0);
                     weapon_hit.message_id = _umesg_weapon_hit;
                     weapon_hit.setOwnerUnitID(owner_id);
                     weapon_hit.setHitLocation(location);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000129.html">[Netpanzer-cvs] r1097 - in trunk/netpanzer/src/NetPanzer:	Objectives Units Views/MainMenu/Multi
</A></li>
	<LI>Next message: <A HREF="000131.html">[Netpanzer-cvs] r1099 - trunk/netpanzer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#130">[ date ]</a>
              <a href="thread.html#130">[ thread ]</a>
              <a href="subject.html#130">[ subject ]</a>
              <a href="author.html#130">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">More information about the Netpanzer-cvs
mailing list</a><br>
</body></html>
