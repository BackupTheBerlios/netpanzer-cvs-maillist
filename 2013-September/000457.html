<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Netpanzer-cvs] r1436 - in trunk/netpanzer:	projects/netpanzer-svn-windows/nbproject/private	src/NetPanzer/Classes src/NetPanzer/Network	src/NetPanzer/Scenes/MainMenu
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/netpanzer-cvs/2013-September/index.html" >
   <LINK REL="made" HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1436%20-%20in%20trunk/netpanzer%3A%0A%09projects/netpanzer-svn-windows/nbproject/private%0A%09src/NetPanzer/Classes%20src/NetPanzer/Network%0A%09src/NetPanzer/Scenes/MainMenu&In-Reply-To=%3C20130914172922.B483555B0C%40scm.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000456.html">
   <LINK REL="Next"  HREF="000458.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Netpanzer-cvs] r1436 - in trunk/netpanzer:	projects/netpanzer-svn-windows/nbproject/private	src/NetPanzer/Classes src/NetPanzer/Network	src/NetPanzer/Scenes/MainMenu</H1>
    <B>kromxp at scm.berlios.de</B> 
    <A HREF="mailto:netpanzer-cvs%40lists.berlios.de?Subject=Re%3A%20%5BNetpanzer-cvs%5D%20r1436%20-%20in%20trunk/netpanzer%3A%0A%09projects/netpanzer-svn-windows/nbproject/private%0A%09src/NetPanzer/Classes%20src/NetPanzer/Network%0A%09src/NetPanzer/Scenes/MainMenu&In-Reply-To=%3C20130914172922.B483555B0C%40scm.berlios.de%3E"
       TITLE="[Netpanzer-cvs] r1436 - in trunk/netpanzer:	projects/netpanzer-svn-windows/nbproject/private	src/NetPanzer/Classes src/NetPanzer/Network	src/NetPanzer/Scenes/MainMenu">kromxp at scm.berlios.de
       </A><BR>
    <I>Sat Sep 14 19:29:22 CEST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="000456.html">[Netpanzer-cvs] r1435 - in trunk/netpanzer:	projects/netpanzer-svn-windows/nbproject	projects/netpanzer-svn-windows/nbproject/private src/Lib/2D	src/NetPanzer/Classes src/NetPanzer/Core	src/NetPanzer/Interfaces src/NetPanzer/Network	src/NetPanzer/Scenes src/NetPanzer/Scenes/MainMenu
</A></li>
        <LI>Next message: <A HREF="000458.html">[Netpanzer-cvs] r1437 - in trunk/netpanzer/src: Lib NetPanzer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#457">[ date ]</a>
              <a href="thread.html#457">[ thread ]</a>
              <a href="subject.html#457">[ subject ]</a>
              <a href="author.html#457">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: kromxp
Date: 2013-09-14 19:29:22 +0200 (Sat, 14 Sep 2013)
New Revision: 1436

Modified:
   trunk/netpanzer/projects/netpanzer-svn-windows/nbproject/private/private.xml
   trunk/netpanzer/src/NetPanzer/Classes/GameServerInfo.hpp
   trunk/netpanzer/src/NetPanzer/Network/GameserverQuerier.cpp
   trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.cpp
   trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.hpp
Log:
Added player list to join game view

Modified: trunk/netpanzer/projects/netpanzer-svn-windows/nbproject/private/private.xml
===================================================================
--- trunk/netpanzer/projects/netpanzer-svn-windows/nbproject/private/private.xml	2013-09-14 13:50:43 UTC (rev 1435)
+++ trunk/netpanzer/projects/netpanzer-svn-windows/nbproject/private/private.xml	2013-09-14 17:29:22 UTC (rev 1436)
@@ -10,15 +10,15 @@
     &lt;editor-bookmarks xmlns=&quot;<A HREF="http://www.netbeans.org/ns/editor-bookmarks/2">http://www.netbeans.org/ns/editor-bookmarks/2</A>&quot; lastBookmarkId=&quot;0&quot;/&gt;
     &lt;open-files xmlns=&quot;<A HREF="http://www.netbeans.org/ns/projectui-open-files/2">http://www.netbeans.org/ns/projectui-open-files/2</A>&quot;&gt;
         &lt;group&gt;
-            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/Lib/2D/Layer.hpp&lt;/file&gt;
-            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Network/MasterserverQuerier.hpp&lt;/file&gt;
+            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Scenes/MainMenu/IntroLayer.cpp&lt;/file&gt;
+            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Classes/ServerListDataSource.cpp&lt;/file&gt;
+            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Classes/ServerListDataSource.hpp&lt;/file&gt;
+            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Interfaces/InfoSocket.cpp&lt;/file&gt;
             &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Classes/GameServerInfo.hpp&lt;/file&gt;
-            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/Lib/ArrayUtil/PtrArray.hpp&lt;/file&gt;
-            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Network/MasterserverQuerier.cpp&lt;/file&gt;
+            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Network/GameserverQuerier.cpp&lt;/file&gt;
             &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.cpp&lt;/file&gt;
             &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.hpp&lt;/file&gt;
-            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/Lib/2D/ComponentLayer.hpp&lt;/file&gt;
-            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/Lib/Network/Address.hpp&lt;/file&gt;
+            &lt;file&gt;file:/C:/prog/netpanzer-svn/src/NetPanzer/Network/GameserverQuerier.hpp&lt;/file&gt;
         &lt;/group&gt;
     &lt;/open-files&gt;
     &lt;preferences xmlns=&quot;<A HREF="http://www.netbeans.org/ns/auxiliary-configuration-preferences/1">http://www.netbeans.org/ns/auxiliary-configuration-preferences/1</A>&quot;&gt;

Modified: trunk/netpanzer/src/NetPanzer/Classes/GameServerInfo.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Classes/GameServerInfo.hpp	2013-09-14 13:50:43 UTC (rev 1435)
+++ trunk/netpanzer/src/NetPanzer/Classes/GameServerInfo.hpp	2013-09-14 17:29:22 UTC (rev 1436)
@@ -24,6 +24,7 @@
 
 #include &quot;Core/CoreTypes.hpp&quot;
 #include &quot;Network/Address.hpp&quot;
+#include &lt;vector&gt;
 
 class GameServerInfo
 {
@@ -33,6 +34,23 @@
     {
         // nothing
     }
+        
+    struct PlayerInfo
+    {
+        PlayerInfo( const NPString&amp; name,
+                    const NPString&amp; kills,
+                    const NPString&amp; deaths,
+                    const NPString&amp; objectives,
+                    const NPString&amp; points)
+            : name(name), kills(kills), deaths(deaths), objectives(objectives), points(points)
+        {}
+        
+        NPString name;
+        NPString kills;
+        NPString deaths;
+        NPString objectives;
+        NPString points;
+    };
 
     enum
     {
@@ -66,6 +84,8 @@
     unsigned queryTimestamp;
     unsigned ping;
     unsigned retryNum;
+    
+    std::vector&lt;PlayerInfo&gt; players;
 };
 
 #endif	/* GAMESERVERINFO_HPP */

Modified: trunk/netpanzer/src/NetPanzer/Network/GameserverQuerier.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Network/GameserverQuerier.cpp	2013-09-14 13:50:43 UTC (rev 1435)
+++ trunk/netpanzer/src/NetPanzer/Network/GameserverQuerier.cpp	2013-09-14 17:29:22 UTC (rev 1436)
@@ -173,6 +173,67 @@
         } else if(token == &quot;objectivelimit&quot;) {
             std::stringstream str(tokenizer.getNextToken());
             str &gt;&gt; info-&gt;objective_limit;
+        } else if(token == &quot;player_0&quot; ) {
+            int player_n = 0;
+            bool firstTime = true;
+            std::string player;
+            std::string kills;
+            std::string deaths;
+            std::string objectives;
+            std::string points;
+            
+            do
+            {
+                if ( firstTime )
+                {
+                    player = tokenizer.getNextToken();
+                    firstTime = false;
+                }
+                
+                token = tokenizer.getNextToken();
+                if ( token.substr(0, 7) == &quot;player_&quot; ) {
+                    info-&gt;players.push_back( GameServerInfo::PlayerInfo(
+                                player, kills, deaths, objectives, points) );
+                    
+                    player = tokenizer.getNextToken();
+                    kills  = &quot;&quot;;
+                    deaths = &quot;&quot;;
+                    objectives = &quot;&quot;;
+                    points = &quot;&quot;;
+                    player_n++;
+                    
+                } else if ( token.substr(0, 6) == &quot;kills_&quot; ) {
+                    kills = tokenizer.getNextToken();
+                } else if ( token.substr(0, 7) == &quot;deaths_&quot; ) {
+                    deaths = tokenizer.getNextToken();
+                } else if ( token.substr(0, 6) == &quot;score_&quot; ) {
+                    objectives = tokenizer.getNextToken();
+                } else if ( token.substr(0, 7) == &quot;points_&quot; ) {
+                    points = tokenizer.getNextToken();
+                } else if ( token.substr(0, 5) == &quot;flag_&quot; ) {
+                    tokenizer.getNextToken();
+                    // ignore
+                } else if ( token.substr(0, 6) == &quot;flagu_&quot; ) {
+                    tokenizer.getNextToken();
+                    // ignore
+                } else {
+                    // finish it!
+                    player_n = info-&gt;current_players;
+                }
+                
+                if ( player_n &gt;= info-&gt;current_players )
+                {
+                    info-&gt;players.push_back( GameServerInfo::PlayerInfo(
+                                        player, kills, deaths, objectives, points) );
+
+                    player = tokenizer.getNextToken();
+                    kills  = &quot;&quot;;
+                    deaths = &quot;&quot;;
+                    objectives = &quot;&quot;;
+                    points = &quot;&quot;;
+                }
+                
+            } while ( player_n &lt; info-&gt;current_players );
         } else {
             // handle more tokens...
         }

Modified: trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.cpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.cpp	2013-09-14 13:50:43 UTC (rev 1435)
+++ trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.cpp	2013-09-14 17:29:22 UTC (rev 1436)
@@ -64,6 +64,93 @@
  * 
  */
 
+class PlayerRowPainter : public Table::RowPainter
+{
+public:
+    PlayerRowPainter() {}
+    ~PlayerRowPainter() {}
+    
+    void setPlayerInfo(const GameServerInfo::PlayerInfo&amp; pi)
+    {
+        name.setText(pi.name.c_str());
+        kills.setText(pi.kills.c_str());
+        deaths.setText(pi.deaths.c_str());
+        objectives.setText(pi.objectives.c_str());
+        points.setText(pi.points.c_str());
+    }
+    
+    void paintCell(Surface&amp; dest, const int x, const int y, const iRect&amp; rect, const unsigned column) const
+    {
+        switch ( column )
+        {
+            case 0: name.drawPart(dest, x, y, rect); break;
+            case 1: kills.drawPart(dest, x, y, rect); break;
+            case 2: deaths.drawPart(dest, x, y, rect); break;
+            case 3: objectives.drawPart(dest, x, y, rect); break;
+            case 4: points.drawPart(dest, x, y, rect); break;
+        }
+    }
+    
+    TextRenderer name;
+    TextRenderer kills;
+    TextRenderer deaths;
+    TextRenderer objectives;
+    TextRenderer points;
+};
+
+class PlayersDataSource : public Table::DataSource
+{
+public:
+    PlayersDataSource() : serverInfo(0) {}
+    ~PlayersDataSource() {}
+    
+    unsigned getRowCount() const
+    {
+        if ( serverInfo )
+        {
+            return serverInfo-&gt;players.size();
+        }
+        return 0;
+    }
+
+    unsigned getRowHeight() const
+    {
+        return TextRenderingSystem::line_height();
+    }
+
+    Table::RowPainter * newRowPainter() const
+    {
+        return new PlayerRowPainter();
+    }
+
+    void configureRowPainter(Table::RowPainter * painter, const unsigned row) const
+    {
+        if ( serverInfo &amp;&amp; row &lt; (serverInfo-&gt;players.size()) )
+        {
+            PlayerRowPainter * p = static_cast&lt;PlayerRowPainter*&gt;(painter);
+            p-&gt;setPlayerInfo(serverInfo-&gt;players[row]);
+        }
+    }
+    
+    void setGameServerInfo(const GameServerInfo * si)
+    {
+        serverInfo = si;
+        notifyDataChanged();
+    }
+    
+    void clear()
+    {
+        serverInfo = 0;
+        notifyDataChanged();
+    }
+    
+private:
+    PlayersDataSource(const PlayersDataSource&amp; );
+    
+    const GameServerInfo * serverInfo;
+
+};
+
 JoinGameLayer::JoinGameLayer() : ComponentLayer(0)
 {
     area = new AreaComponent( MENU_WIDTH, MENU_HEIGHT );
@@ -89,6 +176,17 @@
     serverListDS = new ServerListDataSource();
     serverListDS-&gt;setTable(serverListTable);
     
+    playersTable = new Table(5, 1);
+    playersTable-&gt;addColumn(UString(&quot;Name&quot;), 220);
+    playersTable-&gt;addColumn(UString(&quot;Kills&quot;), 70);
+    playersTable-&gt;addColumn(UString(&quot;Deaths&quot;), 70);
+    playersTable-&gt;addColumn(UString(&quot;Objs&quot;), 70);
+    playersTable-&gt;addColumn(UString(&quot;Points&quot;), 70);
+    playersTable-&gt;setSize(520, 100);
+    
+    playersDS = new PlayersDataSource();
+    playersDS-&gt;setTable(playersTable);
+    
     getNewListButton = Button::createNewSpecialButton(&quot;Get new list&quot;, iXY(0,0), 100);
     getNewListButton-&gt;setClickEvent(Events::RefreshGameList);
     
@@ -99,6 +197,7 @@
     
     addComponent(area);
     addComponent(mapThumbnail);
+    addComponent(playersTable);
     addComponent(serverListTable);
     addComponent(getNewListButton);
     addComponent(refreshListButton);
@@ -127,6 +226,7 @@
     // @todo move the components
     
     mapThumbnail-&gt;setLocation(x, y);
+    playersTable-&gt;setLocation(x + mapThumbnail-&gt;getWidth(), y);
     
     y += 150; // server data
     
@@ -158,6 +258,8 @@
             {
                 servers.deleteAll();
                 serverListTable-&gt;clearSelection();
+                playersTable-&gt;clearSelection();
+                playersDS-&gt;clear();
                 mapThumbnail-&gt;setEmpty();
                 masterserverQuerier-&gt;beginQuery(&amp;servers);
             }
@@ -180,6 +282,8 @@
             {
                 serverListDS-&gt;clear();
                 serverListTable-&gt;clearSelection();
+                playersTable-&gt;clearSelection();
+                playersDS-&gt;clear();
                 mapThumbnail-&gt;setEmpty();
                 gameserverQuerier-&gt;beginQuery(servers);
             }
@@ -191,6 +295,7 @@
             const GameServerInfo * info = serverListDS-&gt;getServerInfo(index);
             if ( info )
             {
+                playersDS-&gt;setGameServerInfo(info);
                 const MapFile * mf = ResourceManager::getMap(info-&gt;current_map, ResourceManager::MAP_THUMBNAIL);
                 if ( mf )
                 {

Modified: trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.hpp
===================================================================
--- trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.hpp	2013-09-14 13:50:43 UTC (rev 1435)
+++ trunk/netpanzer/src/NetPanzer/Scenes/MainMenu/JoinGameLayer.hpp	2013-09-14 17:29:22 UTC (rev 1436)
@@ -31,6 +31,7 @@
 class GameServerInfo;
 class GameserverQuerier;
 class MapThumbnailComponent;
+class PlayersDataSource;
 
 class JoinGameLayer : public ComponentLayer
 {
@@ -48,10 +49,13 @@
     Button * getNewListButton;
     Button * refreshListButton;
     Table  * serverListTable;
+    Table  * playersTable;
     
     MapThumbnailComponent * mapThumbnail;
     
     ServerListDataSource * serverListDS;
+    PlayersDataSource    * playersDS;
+    
     GameServerInfo * selectedServer;
     
     MasterserverQuerier * masterserverQuerier;

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000456.html">[Netpanzer-cvs] r1435 - in trunk/netpanzer:	projects/netpanzer-svn-windows/nbproject	projects/netpanzer-svn-windows/nbproject/private src/Lib/2D	src/NetPanzer/Classes src/NetPanzer/Core	src/NetPanzer/Interfaces src/NetPanzer/Network	src/NetPanzer/Scenes src/NetPanzer/Scenes/MainMenu
</A></li>
	<LI>Next message: <A HREF="000458.html">[Netpanzer-cvs] r1437 - in trunk/netpanzer/src: Lib NetPanzer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#457">[ date ]</a>
              <a href="thread.html#457">[ thread ]</a>
              <a href="subject.html#457">[ subject ]</a>
              <a href="author.html#457">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/netpanzer-cvs">More information about the Netpanzer-cvs
mailing list</a><br>
</body></html>
